<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>WinOLS ECU Tuning Simulator (Advanced)</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2a3a, #2d3b4d); /* Enhanced dark gradient */
      color: #eee;
      padding: 20px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      width: 100%;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      width: 100%;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      border: 1px solid #2a6496;
    }

    h1 {
      color: #00bfff;
      margin: 0;
      font-size: 2.5rem;
      text-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    h1 .icon {
      font-size: 2rem;
    }

    .subtitle {
      color: #7fdbff;
      margin-top: 5px;
      font-size: 1.1rem;
    }

    .section {
      background: rgba(30, 40, 50, 0.8);
      padding: 25px;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      width: 100%;
      border: 1px solid #3a506b;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .section:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    .section h3 {
      color: #00bfff;
      margin-top: 0;
      padding-bottom: 15px;
      border-bottom: 1px solid #3a506b;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.4rem;
    }

    .section h3 .icon {
      font-size: 1.2rem;
    }

    label {
      margin-right: 10px;
      color: #aaccff;
      white-space: nowrap;
      font-weight: 500;
    }

    select, input[type=number], input.hex, button, input[type=file] {
      background: rgba(50, 60, 80, 0.8);
      color: #eee;
      border: 1px solid #4a6380;
      padding: 10px 15px;
      margin: 8px 15px 8px 0;
      border-radius: 6px;
      font-size: 1.05em;
      transition: all 0.3s ease;
    }

    select:focus, input:focus, button:focus, input[type=file]:focus {
      outline: none;
      border-color: #00bfff;
      box-shadow: 0 0 10px rgba(0, 191, 255, 0.7);
      background: rgba(60, 80, 100, 0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(40, 50, 65, 0.7);
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #4a6380;
      padding: 12px;
      color: #eee;
      text-align: center;
    }

    th {
      background: rgba(30, 70, 100, 0.7);
      color: #7fdbff;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background: rgba(45, 55, 70, 0.5);
    }

    tr:hover {
      background: rgba(60, 80, 110, 0.6);
    }

    input.map-value-input {
      width: 100%;
      max-width: 120px;
      text-align: center;
      background: rgba(60, 70, 90, 0.8);
    }

    .hex-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 12px;
      margin-top: 20px;
      padding: 15px;
      background: rgba(40, 50, 65, 0.7);
      border-radius: 6px;
      border: 1px solid #4a6380;
    }

    input.hex {
      width: 100%;
      box-sizing: border-box;
      text-transform: uppercase;
      font-family: 'Consolas', 'Monaco', monospace;
      text-align: center;
      padding: 10px;
    }

    button {
      background: linear-gradient(to right, #0062cc, #00bfff);
      color: white;
      border: none;
      padding: 14px 30px;
      cursor: pointer;
      font-size: 1.1em;
      transition: all 0.3s ease;
      margin-top: 15px;
      border-radius: 50px;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0, 110, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: linear-gradient(to right, #0050a0, #009acd);
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 110, 255, 0.5);
    }

    button:active {
      transform: translateY(1px);
    }

    #resultArea, #messageArea {
      margin-top: 25px;
      padding: 20px;
      background: rgba(40, 50, 65, 0.8);
      border-radius: 8px;
      text-align: center;
      font-size: 1.1em;
      border: 1px solid #00bfff;
      box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
    }
    
    #resultArea {
      color: #aaffaa;
    }
    
    #messageArea {
      color: #aaccff;
    }
    
    #messageArea.error {
      color: #ffaaaa;
      border-color: #ff5555;
      box-shadow: 0 0 15px rgba(255, 85, 85, 0.3);
    }

    .button-group {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 25px;
    }

    #graphCanvas {
      width: 100%;
      max-width: 900px;
      height: 400px;
      background: rgba(30, 40, 50, 0.7);
      border: 1px solid #4a6380;
      border-radius: 8px;
      margin-top: 20px;
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
      padding: 12px;
      background: rgba(40, 60, 80, 0.6);
      border-radius: 8px;
      border: 1px solid #4a6380;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-active {
      background: #00ff00;
      box-shadow: 0 0 8px #00ff00;
    }
    
    .status-inactive {
      background: #ff5555;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .section {
        padding: 20px;
      }
      
      .button-group {
        flex-direction: column;
        align-items: center;
      }
      
      button {
        width: 100%;
        max-width: 300px;
      }
      
      .file-info {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.8rem;
      }
      
      select, input[type=number], input.hex, button, input[type=file] {
        width: 100%;
        margin: 8px 0;
      }
      
      .hex-grid {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1><span class="icon">üîß</span> WinOLS ECU Tuning Simulator (Advanced)</h1>
      <div class="subtitle">Professional-grade ECU remapping simulation for performance tuning</div>
    </header>

    <div class="section">
      <h3><span class="icon">üìÇ</span> File Operations</h3>
      <div>
        <label for="fileInput">Load ECU File (.bin/.hex):</label>
        <input type="file" id="fileInput" accept=".bin, .hex">
        <button onclick="simulateFileLoad()">Simulate Load</button>
        <button onclick="simulateFileSave()">Simulate Save</button>
      </div>
      <div id="messageArea"></div>
      <div class="file-info">
        <div><span class="status-indicator status-inactive"></span> ECU File: <span id="fileStatus">Not loaded</span></div>
        <div><span class="status-indicator status-inactive"></span> Current Map: <span id="mapStatus">None selected</span></div>
      </div>
    </div>

    <div class="section">
      <h3><span class="icon">‚öôÔ∏è</span> Vehicle & Model Selection</h3>
      <div>
        <label for="carBrand">Brand:</label>
        <select id="carBrand">
          <option value="Mazda">Mazda</option>
          <option value="Toyota">Toyota</option>
          <option value="Honda">Honda</option>
          <option value="Isuzu">Isuzu</option>
          <option value="Ford">Ford</option>
          <option value="Nissan">Nissan</option>
          <option value="BMW">BMW</option>
          <option value="Mercedes-Benz">Mercedes-Benz</option>
        </select>

        <label for="carModel">Model:</label>
        <select id="carModel"></select>
      </div>
    </div>

    <div class="section">
      <h3><span class="icon">üó∫Ô∏è</span> Map Selection & View Mode</h3>
      <div>
        <label for="mapType">Select Map for Tuning:</label>
        <select id="mapType"></select>
      </div>
      <div style="margin-top: 20px;">
        <label for="viewMode">Display Mode:</label>
        <select id="viewMode">
          <option value="text">Text</option>
          <option value="2d">2D Graph</option>
          <option value="3d">3D Graph (Simulated)</option>
        </select>
      </div>
      <canvas id="graphCanvas" style="display: none;"></canvas>
    </div>

    <div class="section">
      <h3><span class="icon">üìà</span> Map Tuning Area</h3>
      <div style="overflow-x: auto;">
        <table id="tuningTable">
          <thead>
            <tr><th>Axis X</th><th>Axis Y</th><th>Value</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h3><span class="icon">üî¢</span> HEX Viewer</h3>
      <div class="hex-grid" id="hexGrid"></div>
    </div>

    <div class="section">
      <div class="button-group">
        <button onclick="confirmTuning()"><span>‚úÖ</span> Confirm Tuning</button>
        <button onclick="compareMaps()"><span>üìä</span> Compare Maps</button>
        <button onclick="calculateChecksum()"><span>‚ûï</span> Calc Checksum</button>
        <button onclick="undoLastChange()"><span>‚Ü©Ô∏è</span> Undo</button>
        <button onclick="redoChange()"><span>‚Ü™Ô∏è</span> Redo</button>
      </div>
      <div id="resultArea"></div>
    </div>
  </div>

  <script>
    // --- Global State ---
    let currentECUFile = null;
    let currentMapData = null;
    let currentMapDefinition = null;
    let history = [];
    let historyPointer = -1;

    // --- Data Definitions ---
    const ecuDefinitions = {
      "Mazda": {
        "Mazda 2 Skyactiv-D (Diesel)": {
          iq_limit: {
            name: "IQ Limit (mg/stroke)",
            address: 0x1000, type: "8-bit unsigned", factor: 0.01, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "20" }, { rpm: 1000, load: 10, hexValue: "25" }, { rpm: 1500, load: 10, hexValue: "2A" }, { rpm: 2000, load: 10, hexValue: "2D" },
              { rpm: 2500, load: 10, hexValue: "30" }, { rpm: 3000, load: 10, hexValue: "32" }, { rpm: 3500, load: 10, hexValue: "34" }, { rpm: 4000, load: 10, hexValue: "35" },
              { rpm: 800, load: 30, hexValue: "30" }, { rpm: 1000, load: 30, hexValue: "35" }, { rpm: 1500, load: 30, hexValue: "3A" }, { rpm: 2000, load: 30, hexValue: "3D" },
              { rpm: 2500, load: 30, hexValue: "40" }, { rpm: 3000, load: 30, hexValue: "42" }, { rpm: 3500, load: 30, hexValue: "44" }, { rpm: 4000, load: 30, hexValue: "45" },
              { rpm: 800, load: 50, hexValue: "40" }, { rpm: 1000, load: 50, hexValue: "45" }, { rpm: 1500, load: 50, hexValue: "4A" }, { rpm: 2000, load: 50, hexValue: "4D" },
              { rpm: 2500, load: 50, hexValue: "50" }, { rpm: 3000, load: 50, hexValue: "52" }, { rpm: 3500, load: 50, hexValue: "54" }, { rpm: 4000, load: 50, hexValue: "55" },
              { rpm: 800, load: 70, hexValue: "50" }, { rpm: 1000, load: 70, hexValue: "55" }, { rpm: 1500, load: 70, hexValue: "5A" }, { rpm: 2000, load: 70, hexValue: "5D" },
              { rpm: 2500, load: 70, hexValue: "60" }, { rpm: 3000, load: 70, hexValue: "62" }, { rpm: 3500, load: 70, hexValue: "64" }, { rpm: 4000, load: 70, hexValue: "65" },
              { rpm: 800, load: 90, hexValue: "60" }, { rpm: 1000, load: 90, hexValue: "65" }, { rpm: 1500, load: 90, hexValue: "6A" }, { rpm: 2000, load: 90, hexValue: "6D" },
              { rpm: 2500, load: 90, hexValue: "70" }, { rpm: 3000, load: 90, hexValue: "72" }, { rpm: 3500, load: 90, hexValue: "74" }, { rpm: 4000, load: 90, hexValue: "75" },
              { rpm: 800, load: 100, hexValue: "68" }, { rpm: 1000, load: 100, hexValue: "6D" }, { rpm: 1500, load: 100, hexValue: "72" }, { rpm: 2000, load: 100, hexValue: "75" },
              { rpm: 2500, load: 100, hexValue: "78" }, { rpm: 3000, load: 100, hexValue: "7A" }, { rpm: 3500, load: 100, hexValue: "7C" }, { rpm: 4000, load: 100, hexValue: "7D" },
            ]
          },
          main_injection: {
            name: "Main Injection Quantity (mg/stroke)",
            address: 0x1100, type: "8-bit unsigned", factor: 0.02, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "1A" }, { rpm: 1000, load: 10, hexValue: "1C" }, { rpm: 1500, load: 10, hexValue: "1E" }, { rpm: 2000, load: 10, hexValue: "20" },
              { rpm: 2500, load: 10, hexValue: "22" }, { rpm: 3000, load: 10, hexValue: "24" }, { rpm: 3500, load: 10, hexValue: "26" }, { rpm: 4000, load: 10, hexValue: "27" },
              { rpm: 800, load: 30, hexValue: "25" }, { rpm: 1000, load: 30, hexValue: "28" }, { rpm: 1500, load: 30, hexValue: "2B" }, { rpm: 2000, load: 30, hexValue: "2E" },
              { rpm: 2500, load: 30, hexValue: "30" }, { rpm: 3000, load: 30, hexValue: "32" }, { rpm: 3500, load: 30, hexValue: "34" }, { rpm: 4000, load: 30, hexValue: "35" },
              { rpm: 800, load: 50, hexValue: "30" }, { rpm: 1000, load: 50, hexValue: "33" }, { rpm: 1500, load: 50, hexValue: "36" }, { rpm: 2000, load: 50, hexValue: "39" },
              { rpm: 2500, load: 50, hexValue: "3B" }, { rpm: 3000, load: 50, hexValue: "3D" }, { rpm: 3500, load: 50, hexValue: "3F" }, { rpm: 4000, load: 50, hexValue: "40" },
              { rpm: 800, load: 70, hexValue: "3B" }, { rpm: 1000, load: 70, hexValue: "3E" }, { rpm: 1500, load: 70, hexValue: "41" }, { rpm: 2000, load: 70, hexValue: "44" },
              { rpm: 2500, load: 70, hexValue: "46" }, { rpm: 3000, load: 70, hexValue: "48" }, { rpm: 3500, load: 70, hexValue: "4A" }, { rpm: 4000, load: 70, hexValue: "4B" },
              { rpm: 800, load: 90, hexValue: "48" }, { rpm: 1000, load: 90, hexValue: "4B" }, { rpm: 1500, load: 90, hexValue: "4E" }, { rpm: 2000, load: 90, hexValue: "51" },
              { rpm: 2500, load: 90, hexValue: "53" }, { rpm: 3000, load: 90, hexValue: "55" }, { rpm: 3500, load: 90, hexValue: "57" }, { rpm: 4000, load: 90, hexValue: "58" },
              { rpm: 800, load: 100, hexValue: "50" }, { rpm: 1000, load: 100, hexValue: "53" }, { rpm: 1500, load: 100, hexValue: "56" }, { rpm: 2000, load: 100, hexValue: "59" },
              { rpm: 2500, load: 100, hexValue: "5B" }, { rpm: 3000, load: 100, hexValue: "5D" }, { rpm: 3500, load: 100, hexValue: "5F" }, { rpm: 4000, load: 100, hexValue: "60" },
            ]
          },
          boost_pressure: {
            name: "Boost Pressure (mbar)",
            address: 0x1200, type: "16-bit unsigned", factor: 0.01, offset: 950,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000], load: [30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 1500, load: 30, hexValue: "05DC" }, { rpm: 2000, load: 30, hexValue: "0640" }, { rpm: 2500, load: 30, hexValue: "06A4" }, { rpm: 3000, load: 30, hexValue: "0708" },
              { rpm: 3500, load: 30, hexValue: "076C" }, { rpm: 4000, load: 30, hexValue: "07D0" }, { rpm: 4500, load: 30, hexValue: "0834" }, { rpm: 5000, load: 30, hexValue: "0898" },
              { rpm: 1500, load: 50, hexValue: "06A4" }, { rpm: 2000, load: 50, hexValue: "0708" }, { rpm: 2500, load: 50, hexValue: "076C" }, { rpm: 3000, load: 50, hexValue: "07D0" },
              { rpm: 3500, load: 50, hexValue: "0834" }, { rpm: 4000, load: 50, hexValue: "0898" }, { rpm: 4500, load: 50, hexValue: "08FC" }, { rpm: 5000, load: 50, hexValue: "0960" },
              { rpm: 1500, load: 70, hexValue: "07D0" }, { rpm: 2000, load: 70, hexValue: "0834" }, { rpm: 2500, load: 70, hexValue: "0898" }, { rpm: 3000, load: 70, hexValue: "08FC" },
              { rpm: 3500, load: 70, hexValue: "0960" }, { rpm: 4000, load: 70, hexValue: "09C4" }, { rpm: 4500, load: 70, hexValue: "0A28" }, { rpm: 5000, load: 70, hexValue: "0A8C" },
              { rpm: 1500, load: 90, hexValue: "08FC" }, { rpm: 2000, load: 90, hexValue: "0960" }, { rpm: 2500, load: 90, hexValue: "09C4" }, { rpm: 3000, load: 90, hexValue: "0A28" },
              { rpm: 3500, load: 90, hexValue: "0A8C" }, { rpm: 4000, load: 90, hexValue: "0AF0" }, { rpm: 4500, load: 90, hexValue: "0B54" }, { rpm: 5000, load: 90, hexValue: "0BB8" },
              { rpm: 1500, load: 100, hexValue: "0A28" }, { rpm: 2000, load: 100, hexValue: "0A8C" }, { rpm: 2500, load: 100, hexValue: "0AF0" }, { rpm: 3000, load: 100, hexValue: "0B54" },
              { rpm: 3500, load: 100, hexValue: "0BB8" }, { rpm: 4000, load: 100, hexValue: "0C1C" }, { rpm: 4500, load: 100, hexValue: "0C80" }, { rpm: 5000, load: 100, hexValue: "0CE4" },
            ]
          }
        },
        "Mazda 2 Skyactiv-G (Petrol)": {
          ignition_timing: {
            name: "Ignition Timing (degrees BTDC)",
            address: 0x1000, type: "8-bit signed", factor: 0.5, offset: -30,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "30" }, { rpm: 1000, load: 10, hexValue: "35" }, { rpm: 1500, load: 10, hexValue: "3A" }, { rpm: 2000, load: 10, hexValue: "3D" },
              { rpm: 2500, load: 10, hexValue: "40" }, { rpm: 3000, load: 10, hexValue: "42" }, { rpm: 3500, load: 10, hexValue: "44" }, { rpm: 4000, load: 10, hexValue: "45" },
              { rpm: 800, load: 30, hexValue: "2A" }, { rpm: 1000, load: 30, hexValue: "2F" }, { rpm: 1500, load: 30, hexValue: "34" }, { rpm: 2000, load: 30, hexValue: "37" },
              { rpm: 2500, load: 30, hexValue: "3A" }, { rpm: 3000, load: 30, hexValue: "3C" }, { rpm: 3500, load: 30, hexValue: "3E" }, { rpm: 4000, load: 30, hexValue: "3F" },
              { rpm: 800, load: 50, hexValue: "20" }, { rpm: 1000, load: 50, hexValue: "25" }, { rpm: 1500, load: 50, hexValue: "2A" }, { rpm: 2000, load: 50, hexValue: "2D" },
              { rpm: 2500, load: 50, hexValue: "30" }, { rpm: 3000, load: 50, hexValue: "32" }, { rpm: 3500, load: 50, hexValue: "34" }, { rpm: 4000, load: 50, hexValue: "35" },
              { rpm: 800, load: 70, hexValue: "18" }, { rpm: 1000, load: 70, hexValue: "1D" }, { rpm: 1500, load: 70, hexValue: "22" }, { rpm: 2000, load: 70, hexValue: "25" },
              { rpm: 2500, load: 70, hexValue: "28" }, { rpm: 3000, load: 70, hexValue: "2A" }, { rpm: 3500, load: 70, hexValue: "2C" }, { rpm: 4000, load: 70, hexValue: "2D" },
              { rpm: 800, load: 90, hexValue: "10" }, { rpm: 1000, load: 90, hexValue: "15" }, { rpm: 1500, load: 90, hexValue: "1A" }, { rpm: 2000, load: 90, hexValue: "1D" },
              { rpm: 2500, load: 90, hexValue: "20" }, { rpm: 3000, load: 90, hexValue: "22" }, { rpm: 3500, load: 90, hexValue: "24" }, { rpm: 4000, load: 90, hexValue: "25" },
              { rpm: 800, load: 100, hexValue: "08" }, { rpm: 1000, load: 100, hexValue: "0D" }, { rpm: 1500, load: 100, hexValue: "12" }, { rpm: 2000, load: 100, hexValue: "15" },
              { rpm: 2500, load: 100, hexValue: "18" }, { rpm: 3000, load: 100, hexValue: "1A" }, { rpm: 3500, load: 100, hexValue: "1C" }, { rpm: 4000, load: 100, hexValue: "1D" },
            ]
          }
        }
      },
      "Toyota": {
        "Toyota Hilux Revo (Diesel)": {
          iq_limit: {
            name: "IQ Limit (mg/stroke)",
            address: 0x1000, type: "8-bit unsigned", factor: 0.01, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "20" }, { rpm: 1000, load: 10, hexValue: "25" }, { rpm: 1500, load: 10, hexValue: "2A" }, { rpm: 2000, load: 10, hexValue: "2D" },
              { rpm: 2500, load: 10, hexValue: "30" }, { rpm: 3000, load: 10, hexValue: "32" }, { rpm: 3500, load: 10, hexValue: "34" }, { rpm: 4000, load: 10, hexValue: "35" },
              { rpm: 800, load: 30, hexValue: "30" }, { rpm: 1000, load: 30, hexValue: "35" }, { rpm: 1500, load: 30, hexValue: "3A" }, { rpm: 2000, load: 30, hexValue: "3D" },
              { rpm: 2500, load: 30, hexValue: "40" }, { rpm: 3000, load: 30, hexValue: "42" }, { rpm: 3500, load: 30, hexValue: "44" }, { rpm: 4000, load: 30, hexValue: "45" },
              { rpm: 800, load: 50, hexValue: "40" }, { rpm: 1000, load: 50, hexValue: "45" }, { rpm: 1500, load: 50, hexValue: "4A" }, { rpm: 2000, load: 50, hexValue: "4D" },
              { rpm: 2500, load: 50, hexValue: "50" }, { rpm: 3000, load: 50, hexValue: "52" }, { rpm: 3500, load: 50, hexValue: "54" }, { rpm: 4000, load: 50, hexValue: "55" },
              { rpm: 800, load: 70, hexValue: "50" }, { rpm: 1000, load: 70, hexValue: "55" }, { rpm: 1500, load: 70, hexValue: "5A" }, { rpm: 2000, load: 70, hexValue: "5D" },
              { rpm: 2500, load: 70, hexValue: "60" }, { rpm: 3000, load: 70, hexValue: "62" }, { rpm: 3500, load: 70, hexValue: "64" }, { rpm: 4000, load: 70, hexValue: "65" },
              { rpm: 800, load: 90, hexValue: "60" }, { rpm: 1000, load: 90, hexValue: "65" }, { rpm: 1500, load: 90, hexValue: "6A" }, { rpm: 2000, load: 90, hexValue: "6D" },
              { rpm: 2500, load: 90, hexValue: "70" }, { rpm: 3000, load: 90, hexValue: "72" }, { rpm: 3500, load: 90, hexValue: "74" }, { rpm: 4000, load: 90, hexValue: "75" },
              { rpm: 800, load: 100, hexValue: "68" }, { rpm: 1000, load: 100, hexValue: "6D" }, { rpm: 1500, load: 100, hexValue: "72" }, { rpm: 2000, load: 100, hexValue: "75" },
              { rpm: 2500, load: 100, hexValue: "78" }, { rpm: 3000, load: 100, hexValue: "7A" }, { rpm: 3500, load: 100, hexValue: "7C" }, { rpm: 4000, load: 100, hexValue: "7D" },
            ]
          }
        }
      }
    };

    // --- DOM Elements ---
    const carBrandSelect = document.getElementById("carBrand");
    const carModelSelect = document.getElementById("carModel");
    const mapTypeSelect = document.getElementById("mapType");
    const tuningTableBody = document.querySelector("#tuningTable tbody");
    const hexGrid = document.getElementById("hexGrid");
    const resultArea = document.getElementById("resultArea");
    const messageArea = document.getElementById("messageArea");
    const viewModeSelect = document.getElementById("viewMode");
    const graphCanvas = document.getElementById("graphCanvas");
    const graphCtx = graphCanvas.getContext('2d');
    const fileStatus = document.getElementById("fileStatus");
    const mapStatus = document.getElementById("mapStatus");
    let chartInstance;

    // --- Utility Functions ---
    function decToHex(d, padLength = 2) {
      let hex = Number(d).toString(16).toUpperCase();
      return hex.padStart(padLength, '0');
    }

    function hexToDec(h) {
      return parseInt(h, 16);
    }

    function showMessage(msg, isError = false) {
      messageArea.textContent = msg;
      messageArea.className = isError ? "error" : "";
      clearTimeout(messageArea.timer);
      messageArea.timer = setTimeout(() => {
        messageArea.textContent = '';
        messageArea.className = '';
      }, 5000);
    }

    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    // --- Core Logic ---

    // Populates car models based on selected brand
    function populateCarModels() {
        const selectedBrand = carBrandSelect.value;
        const modelsForBrand = ecuDefinitions[selectedBrand];
        carModelSelect.innerHTML = '';

        if (modelsForBrand) {
            for (const modelKey in modelsForBrand) {
                const option = document.createElement("option");
                option.value = modelKey;
                option.textContent = modelKey;
                carModelSelect.appendChild(option);
            }
        } else {
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "No models available";
            carModelSelect.appendChild(option);
        }
        
        populateMapOptions();
    }

    // Populates map options based on selected car model
    function populateMapOptions() {
        const selectedBrand = carBrandSelect.value;
        const selectedModelText = carModelSelect.value;
        const mapsForModel = ecuDefinitions[selectedBrand]?.[selectedModelText];
        
        mapTypeSelect.innerHTML = '';

        let hasMaps = false;
        if (mapsForModel) {
            for (const mapKey in mapsForModel) {
                const option = document.createElement("option");
                option.value = mapKey;
                option.textContent = mapsForModel[mapKey].name;
                mapTypeSelect.appendChild(option);
                hasMaps = true;
            }
        }
        
        if (!hasMaps) {
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "No maps available";
            mapTypeSelect.appendChild(option);
        }

        if (hasMaps && mapTypeSelect.value) {
            loadMapData();
        } else {
            tuningTableBody.innerHTML = '<tr><td colspan="3">No data available for this map.</td></tr>';
            hexGrid.innerHTML = '';
            currentMapData = null;
            currentMapDefinition = null;
            renderGraph();
            mapStatus.textContent = "None selected";
        }
    }

    // Loads and displays the selected map data
    function loadMapData() {
        const selectedBrand = carBrandSelect.value;
        const selectedModelText = carModelSelect.value;
        const selectedMapType = mapTypeSelect.value;

        if (!selectedMapType || !ecuDefinitions[selectedBrand] || 
            !ecuDefinitions[selectedBrand][selectedModelText] || 
            !ecuDefinitions[selectedBrand][selectedModelText][selectedMapType]) {
            tuningTableBody.innerHTML = '<tr><td colspan="3">No data available for this map.</td></tr>';
            hexGrid.innerHTML = '';
            currentMapData = null;
            currentMapDefinition = null;
            renderGraph();
            mapStatus.textContent = "None selected";
            return;
        }

        currentMapDefinition = ecuDefinitions[selectedBrand][selectedModelText][selectedMapType];
        currentMapData = JSON.parse(JSON.stringify(currentMapDefinition.defaultData));

        renderTuningTable();
        renderHexGrid();
        renderGraph();
        addToHistory();
        
        mapStatus.textContent = currentMapDefinition.name;
    }

    // Renders the table view of the map
    function renderTuningTable() {
      tuningTableBody.innerHTML = '';

      if (!currentMapData || currentMapData.length === 0) {
          tuningTableBody.innerHTML = '<tr><td colspan="3">No map data to display.</td></tr>';
          return;
      }

      currentMapData.forEach((row, index) => {
        let displayValue;
        if (currentMapDefinition.name.includes("DTC Switch")) {
            displayValue = row.hexValue === "01" ? "Enabled" : "Disabled";
        } else {
            if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
                displayValue = (hexToDec(row.hexValue) * currentMapDefinition.factor + currentMapDefinition.offset).toFixed(currentMapDefinition.factor < 1 ? 2 : 0);
            } else {
                displayValue = hexToDec(row.hexValue);
            }
        }

        const tr = document.createElement("tr");
        const axisXKey = currentMapDefinition?.axes?.x?.toLowerCase() || 'id';
        const axisYKey = currentMapDefinition?.axes?.y?.toLowerCase();

        const axisXValue = axisXKey ? (row[axisXKey] || '-') : '-';
        const axisYValue = axisYKey ? (row[axisYKey] || '-') : '-';

        let rowHtml = `<td>${axisXValue}</td>`;
        if (axisYKey) {
            rowHtml += `<td>${axisYValue}</td>`;
        }
        
        rowHtml += `<td>
            ${currentMapDefinition.name.includes("DTC Switch") ? `
                <select class="map-value-input" data-index="${index}">
                    <option value="01" ${row.hexValue === "01" ? 'selected' : ''}>Enabled</option>
                    <option value="00" ${row.hexValue === "00" ? 'selected' : ''}>Disabled</option>
                </select>
            ` : `
                <input type="number" class="map-value-input" data-index="${index}" value="${displayValue}" step="${currentMapDefinition.factor < 1 ? '0.01' : '1'}">
            `}
          </td>`;
        tr.innerHTML = rowHtml;
        tuningTableBody.appendChild(tr);
      });

      document.querySelectorAll(".map-value-input").forEach(input => {
        input.addEventListener("change", updateFromMapTable);
      });
    }

    // Renders the HEX Viewer grid
    function renderHexGrid() {
      hexGrid.innerHTML = '';
      if (!currentMapData || currentMapData.length === 0) {
          hexGrid.innerHTML = 'No HEX data to display.';
          return;
      }

      let maxLength = 2;
      if (currentMapDefinition && currentMapDefinition.type && currentMapDefinition.type.includes("16-bit")) {
          maxLength = 4;
      }

      currentMapData.forEach((row, index) => {
        const input = document.createElement("input");
        input.type = "text";
        input.className = "hex";
        input.maxLength = maxLength;
        input.value = row.hexValue;
        input.setAttribute("data-index", index);
        input.addEventListener("input", updateFromHexGrid);
        hexGrid.appendChild(input);
      });
    }

    // Updates map data and HEX viewer from table input
    function updateFromMapTable(event) {
      const index = parseInt(event.target.dataset.index);
      let newValue = event.target.value;

      addToHistory();

      let hexEquivalent;
      if (currentMapDefinition.name.includes("DTC Switch")) {
          hexEquivalent = newValue;
      } else {
          newValue = parseFloat(newValue);
          if (isNaN(newValue)) {
             showMessage("Invalid number input.", true);
             return;
          }
          if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
              hexEquivalent = Math.round((newValue - currentMapDefinition.offset) / currentMapDefinition.factor);
              if (currentMapDefinition.type === "8-bit unsigned") {
                  hexEquivalent = Math.max(0, Math.min(hexEquivalent, 255));
              } else if (currentMapDefinition.type === "8-bit signed") {
                  hexEquivalent = Math.max(-128, Math.min(hexEquivalent, 127));
                  if (hexEquivalent < 0) hexEquivalent = 256 + hexEquivalent;
              }
              else if (currentMapDefinition.type === "16-bit unsigned") {
                  hexEquivalent = Math.max(0, Math.min(hexEquivalent, 65535));
              } else if (currentMapDefinition.type === "16-bit signed") {
                  hexEquivalent = Math.max(-32768, Math.min(hexEquivalent, 32767));
                  if (hexEquivalent < 0) hexEquivalent = 65536 + hexEquivalent;
              }
          } else {
              hexEquivalent = Math.round(newValue);
          }
      }

      const hexString = decToHex(hexEquivalent, currentMapDefinition && currentMapDefinition.type.includes("16-bit") ? 4 : 2);
      currentMapData[index].hexValue = hexString;

      const hexInput = hexGrid.querySelector(`input[data-index="${index}"]`);
      if (hexInput) {
        hexInput.value = hexString;
      }
      renderGraph();
      resultArea.innerHTML = '';
      showMessage("Map value updated.", false);
    }

    // Updates map data and table from HEX viewer input
    function updateFromHexGrid(event) {
      const index = parseInt(event.target.dataset.index);
      let newHexValue = event.target.value.toUpperCase();

      const is8Bit = currentMapDefinition && (currentMapDefinition.type === "8-bit unsigned" || currentMapDefinition.type === "8-bit signed");
      const is16Bit = currentMapDefinition && (currentMapDefinition.type === "16-bit unsigned" || currentMapDefinition.type === "16-bit signed");

      if (!/^[0-9A-F]*$/.test(newHexValue) || (is8Bit && newHexValue.length > 2) || (is16Bit && newHexValue.length > 4)) {
        event.target.value = currentMapData[index].hexValue;
        showMessage("Invalid HEX input.", true);
        return;
      }

      if (is8Bit && newHexValue.length === 1) newHexValue = '0' + newHexValue;
      if (is16Bit && newHexValue.length < 4) newHexValue = newHexValue.padStart(4, '0');
      
      if (is8Bit && newHexValue.length > 2) newHexValue = newHexValue.substring(newHexValue.length - 2);
      if (is16Bit && newHexValue.length > 4) newHexValue = newHexValue.substring(newHexValue.length - 4);

      addToHistory();

      currentMapData[index].hexValue = newHexValue;

      const mapInput = tuningTableBody.querySelector(`[data-index="${index}"]`);
      if (mapInput) {
          if (currentMapDefinition.name.includes("DTC Switch")) {
              mapInput.value = newHexValue;
          } else {
              let actualValueDec = hexToDec(newHexValue);
              if (currentMapDefinition.type === "8-bit signed" && actualValueDec >= 128) actualValueDec -= 256;
              if (currentMapDefinition.type === "16-bit signed" && actualValueDec >= 32768) actualValueDec -= 65536;

              if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
                  const actualValue = (actualValueDec * currentMapDefinition.factor + currentMapDefinition.offset).toFixed(currentMapDefinition.factor < 1 ? 2 : 0);
                  mapInput.value = actualValue;
              } else {
                  mapInput.value = actualValueDec;
              }
          }
      }
      renderGraph();
      resultArea.innerHTML = '';
      showMessage("HEX value updated.", false);
    }

    // --- Graphing (2D Simulation with Chart.js) ---
    function renderGraph() {
        const viewMode = viewModeSelect.value;
        if (chartInstance) {
            chartInstance.destroy();
        }

        if (viewMode === '2d' && currentMapDefinition && currentMapData && 
            !currentMapDefinition.name.includes("DTC Switch")) {
            graphCanvas.style.display = 'block';
            
            const xAxisLabel = currentMapDefinition?.axes?.x;
            const yAxisLabel = currentMapDefinition?.axes?.y;
            
            let labels = [];
            let datasets = [];
            
            if (xAxisLabel && yAxisLabel) {
                const uniqueYValues = [...new Set(currentMapData.map(d => d[yAxisLabel.toLowerCase()]))].sort((a,b) => a - b);
                labels = [...new Set(currentMapData.map(d => d[xAxisLabel.toLowerCase()]))].sort((a,b) => a - b);

                uniqueYValues.forEach(yVal => {
                    const dataForY = [];
                    labels.forEach(xVal => {
                        const item = currentMapData.find(d => 
                            d[xAxisLabel.toLowerCase()] === xVal && 
                            d[yAxisLabel.toLowerCase()] === yVal
                        );
                        if (item) {
                            let value = hexToDec(item.hexValue);
                            if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
                                value = (value * currentMapDefinition.factor + currentMapDefinition.offset);
                            }
                            dataForY.push(value);
                        } else {
                            dataForY.push(null);
                        }
                    });

                    datasets.push({
                        label: `${yAxisLabel}: ${yVal}`,
                        data: dataForY,
                        borderColor: getRandomColor(),
                        backgroundColor: 'rgba(0, 191, 255, 0.2)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.3
                    });
                });
            } else {
                labels = currentMapData.map(d => {
                    if (xAxisLabel) return d[xAxisLabel.toLowerCase()] || 'N/A';
                    if (yAxisLabel) return d[yAxisLabel.toLowerCase()] || 'N/A';
                    if (d.id) return d.id;
                    return `Point ${currentMapData.indexOf(d) + 1}`;
                });
                
                const dataValues = currentMapData.map(d => {
                    let value = hexToDec(d.hexValue);
                    if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
                        value = (value * currentMapDefinition.factor + currentMapDefinition.offset);
                    }
                    return value;
                });

                datasets.push({
                    label: `${currentMapDefinition.name} Values`,
                    data: dataValues,
                    borderColor: '#00bfff',
                    backgroundColor: 'rgba(0, 191, 255, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                });
            }

            chartInstance = new Chart(graphCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xAxisLabel || 'Index',
                                color: '#ccc'
                            },
                            ticks: { color: '#eee' },
                            grid: { color: '#555' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: currentMapDefinition.name,
                                color: '#ccc'
                            },
                            ticks: { color: '#eee' },
                            grid: { color: '#555' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#eee'
                            }
                        }
                    }
                }
            });
        } else {
            graphCanvas.style.display = 'none';
            if (viewMode === '3d') {
                showMessage("3D Graph visualization requires advanced libraries.", false);
            }
        }
    }

    // --- File Operations Simulation ---
    function simulateFileLoad() {
        showMessage("Simulating ECU file load...", false);

        currentECUFile = Array(0x4000).fill('00');
        
        for (const brandKey in ecuDefinitions) {
            for (const modelKey in ecuDefinitions[brandKey]) {
                for (const mapKey in ecuDefinitions[brandKey][modelKey]) {
                    const mapDef = ecuDefinitions[brandKey][modelKey][mapKey];
                    let currentAddress = mapDef.address;
                    mapDef.defaultData.forEach(item => {
                        let hexBytes = item.hexValue;
                        const byteLength = mapDef.type.includes("16-bit") ? 4 : 2;
                        hexBytes = hexBytes.padStart(byteLength, '0');

                        for (let i = 0; i < hexBytes.length; i += 2) {
                            if (currentAddress < currentECUFile.length) {
                                 currentECUFile[currentAddress++] = hexBytes.substring(i, i + 2);
                            }
                        }
                    });
                }
            }
        }

        history = [];
        historyPointer = -1;

        populateCarModels();
        showMessage("ECU file simulated load complete.", false);
        fileStatus.textContent = "Loaded (simulated)";
        document.querySelectorAll('.status-indicator')[0].className = 'status-indicator status-active';
    }

    function simulateFileSave() {
        if (!currentECUFile) {
            showMessage("No ECU file loaded to save.", true);
            return;
        }
        showMessage("Simulating saving of modified ECU file.");
    }

    // --- Tuning Functions ---

    function confirmTuning() {
      if (!currentMapData || !currentMapDefinition) {
          resultArea.innerHTML = "<p style='color: #ffaaaa;'>Please load a map first.</p>";
          return;
      }
      const map = mapTypeSelect.options[mapTypeSelect.selectedIndex].text;
      const mode = viewModeSelect.value;

      let originalTotalValue = 0;
      let modifiedTotalValue = 0;

      if (!currentMapDefinition.name.includes("DTC Switch")) {
          const originalMapDataDef = ecuDefinitions[carBrandSelect.value]
                                      ?.[carModelSelect.value]
                                      ?.[mapTypeSelect.value];

          if (originalMapDataDef && originalMapDataDef.defaultData) {
              originalMapDataDef.defaultData.forEach(item => {
                  originalTotalValue += hexToDec(item.hexValue);
              });
          }
          currentMapData.forEach(item => {
              modifiedTotalValue += hexToDec(item.hexValue);
          });
      }

      let hpChange = 0;
      let torqueChange = 0;
      let response = "Standard response.";

      const diffRatio = (originalTotalValue !== 0) ? (modifiedTotalValue - originalTotalValue) / originalTotalValue : 0;

      if (mapTypeSelect.value.includes("iq_limit") || mapTypeSelect.value.includes("main_injection")) {
        hpChange = (diffRatio * 30).toFixed(1);
        torqueChange = (diffRatio * 40).toFixed(1);
        response = diffRatio > 0 ? "Improved throttle response and power delivery." : "Smoother power delivery for economy.";
      } else if (mapTypeSelect.value.includes("boost_pressure")) {
        hpChange = (diffRatio * 25).toFixed(1);
        torqueChange = (diffRatio * 35).toFixed(1);
        response = diffRatio > 0 ? "Stronger pull throughout the RPM range." : "Reduced turbo lag for better drivability.";
      } else if (mapTypeSelect.value.includes("ignition_timing")) {
        hpChange = (diffRatio * 20).toFixed(1);
        torqueChange = (diffRatio * 25).toFixed(1);
        response = diffRatio > 0 ? "Optimized combustion for increased power." : "Safer operation with reduced risk.";
      } else if (currentMapDefinition.name.includes("DTC Switch")) {
          const disabledDTCs = currentMapData.filter(d => d.hexValue === "00");
          if (disabledDTCs.length > 0) {
              response = `Warning: ${disabledDTCs.length} DTCs are currently disabled.`;
          } else {
              response = "All DTCs are enabled as per standard.";
          }
          hpChange = "N/A";
          torqueChange = "N/A";
      } else {
          hpChange = (diffRatio * 10).toFixed(1);
          torqueChange = (diffRatio * 10).toFixed(1);
          response = "General performance adjustment.";
      }

      resultArea.innerHTML = `
        <p>‚úÖ Tuning of "${map}" completed!</p>
        <p>Initial Results: Horsepower change ~${hpChange} HP, Torque change ~${torqueChange} %</p>
        <p>${response}</p>
      `;
    }

    function compareMaps() {
        if (!currentMapData || history.length < 2 || !currentMapDefinition) {
            showMessage("Load a map and make changes to compare.", true);
            return;
        }

        const originalMapState = history[0];
        let changes = 0;
        let comparisonDetails = 'Changes detected:<br>';

        currentMapData.forEach((modifiedItem, index) => {
            const originalItem = originalMapState.currentMapData[index];
            if (originalItem && modifiedItem.hexValue !== originalItem.hexValue) {
                changes++;
                const axisXKey = currentMapDefinition?.axes?.x?.toLowerCase();
                const axisYKey = currentMapDefinition?.axes?.y?.toLowerCase();
                
                let label = '';
                if (axisXKey && modifiedItem[axisXKey] !== undefined) label += `${axisXKey.toUpperCase()}: ${modifiedItem[axisXKey]} `;
                if (axisYKey && modifiedItem[axisYKey] !== undefined) label += `${axisYKey.toUpperCase()}: ${modifiedItem[axisYKey]} `;
                if (modifiedItem.id) label = `ID: ${modifiedItem.id}`;

                comparisonDetails += `Row ${index + 1} (${label.trim() || 'N/A'}): Original HEX: ${originalItem.hexValue}, Modified HEX: ${modifiedItem.hexValue}<br>`;
            }
        });

        if (changes === 0) {
            showMessage("No changes detected between current map and original state.", false);
        } else {
            resultArea.innerHTML = `
                <p>üìä Map Comparison Complete: Found ${changes} differences.</p>
                <p>${comparisonDetails}</p>
            `;
        }
    }

    function calculateChecksum() {
        if (!currentECUFile) {
            showMessage("No ECU file loaded to calculate checksum.", true);
            return;
        }

        let sum = 0;
        currentECUFile.forEach(hexByte => {
            sum += hexToDec(hexByte);
        });

        const simulatedChecksum = decToHex(sum % 65536, 4);

        resultArea.innerHTML = `
            <p>‚ûï Simulated Checksum Calculation Complete.</p>
            <p>Calculated Checksum: <strong>0x${simulatedChecksum}</strong></p>
        `;
    }

    // --- Undo/Redo Functionality ---
    function addToHistory() {
        if (!currentMapData || !currentMapDefinition) return;

        const currentState = JSON.stringify({
            currentMapData: currentMapData,
            currentMapDefinition: currentMapDefinition
        });
        if (historyPointer >= 0 && JSON.stringify(history[historyPointer]) === currentState) {
            return;
        }

        if (historyPointer < history.length - 1) {
            history = history.slice(0, historyPointer + 1);
        }
        history.push({
            currentMapData: JSON.parse(JSON.stringify(currentMapData)),
            currentMapDefinition: JSON.parse(JSON.stringify(currentMapDefinition))
        });
        historyPointer++;
    }

    function undoLastChange() {
        if (historyPointer > 0) {
            historyPointer--;
            const prevState = history[historyPointer];
            currentMapData = JSON.parse(JSON.stringify(prevState.currentMapData));
            currentMapDefinition = JSON.parse(JSON.stringify(prevState.currentMapDefinition));
            
            renderTuningTable();
            renderHexGrid();
            renderGraph();
            showMessage("Undo successful.", false);
        } else {
            showMessage("No more changes to undo.", true);
        }
    }
    
    function redoChange() {
        if (historyPointer < history.length - 1) {
            historyPointer++;
            const nextState = history[historyPointer];
            currentMapData = JSON.parse(JSON.stringify(nextState.currentMapData));
            currentMapDefinition = JSON.parse(JSON.stringify(nextState.currentMapDefinition));
            
            renderTuningTable();
            renderHexGrid();
            renderGraph();
            showMessage("Redo successful.", false);
        } else {
            showMessage("No more changes to redo.", true);
        }
    }

    // --- Event Listeners and Initial Load ---
    document.addEventListener("DOMContentLoaded", () => {
      carBrandSelect.addEventListener("change", populateCarModels);
      carModelSelect.addEventListener("change", populateMapOptions);
      mapTypeSelect.addEventListener("change", loadMapData);
      viewModeSelect.addEventListener("change", renderGraph);
      
      // Initialize models
      populateCarModels();
    });
  </script>
</body>
</html>
