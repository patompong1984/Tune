<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WinOLS ECU Tuning Simulator (Advanced)</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2a3a, #2d3b4d); /* Enhanced dark gradient */
      color: #eee;
      padding: 20px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      width: 100%;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      width: 100%;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      border: 1px solid #2a6496;
    }

    h1 {
      color: #00bfff;
      margin: 0;
      font-size: 2.5rem;
      text-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    h1 .icon {
      font-size: 2rem;
    }

    .subtitle {
      color: #7fdbff;
      margin-top: 5px;
      font-size: 1.1rem;
    }

    .section {
      background: rgba(30, 40, 50, 0.8);
      padding: 25px;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      width: 100%;
      border: 1px solid #3a506b;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .section:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    .section h3 {
      color: #00bfff;
      margin-top: 0;
      padding-bottom: 15px;
      border-bottom: 1px solid #3a506b;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.4rem;
    }

    .section h3 .icon {
      font-size: 1.2rem;
    }

    label {
      margin-right: 10px;
      color: #aaccff;
      white-space: nowrap;
      font-weight: 500;
    }

    select, input[type=number], input.hex, button, input[type=file] {
      background: rgba(50, 60, 80, 0.8);
      color: #eee;
      border: 1px solid #4a6380;
      padding: 10px 15px;
      margin: 8px 15px 8px 0;
      border-radius: 6px;
      font-size: 1.05em;
      transition: all 0.3s ease;
    }

    select:focus, input:focus, button:focus, input[type=file]:focus {
      outline: none;
      border-color: #00bfff;
      box-shadow: 0 0 10px rgba(0, 191, 255, 0.7);
      background: rgba(60, 80, 100, 0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(40, 50, 65, 0.7);
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #4a6380;
      padding: 12px;
      color: #eee;
      text-align: center;
    }

    th {
      background: rgba(30, 70, 100, 0.7);
      color: #7fdbff;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background: rgba(45, 55, 70, 0.5);
    }

    tr:hover {
      background: rgba(60, 80, 110, 0.6);
    }

    input.map-value-input {
      width: 100%;
      max-width: 120px;
      text-align: center;
      background: rgba(60, 70, 90, 0.8);
    }

    .hex-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 12px;
      margin-top: 20px;
      padding: 15px;
      background: rgba(40, 50, 65, 0.7);
      border-radius: 6px;
      border: 1px solid #4a6380;
    }

    input.hex {
      width: 100%;
      box-sizing: border-box;
      text-transform: uppercase;
      font-family: 'Consolas', 'Monaco', monospace;
      text-align: center;
      padding: 10px;
    }

    button {
      background: linear-gradient(to right, #0062cc, #00bfff);
      color: white;
      border: none;
      padding: 14px 30px;
      cursor: pointer;
      font-size: 1.1em;
      transition: all 0.3s ease;
      margin-top: 15px;
      border-radius: 50px;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0, 110, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: linear-gradient(to right, #0050a0, #009acd);
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 110, 255, 0.5);
    }

    button:active {
      transform: translateY(1px);
    }

    #resultArea, #messageArea {
      margin-top: 25px;
      padding: 20px;
      background: rgba(40, 50, 65, 0.8);
      border-radius: 8px;
      text-align: center;
      font-size: 1.1em;
      border: 1px solid #00bfff;
      box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
    }
    
    #resultArea {
      color: #aaffaa;
    }
    
    #messageArea {
      color: #aaccff;
    }
    
    #messageArea.error {
      color: #ffaaaa;
      border-color: #ff5555;
      box-shadow: 0 0 15px rgba(255, 85, 85, 0.3);
    }

    .button-group {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 25px;
    }

    /* --- ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏á‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ --- */
    #graphCanvas {
      width: 100%;
      max-width: 500px; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏≠‡∏µ‡∏Å */
      height: 250px;    /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏≠‡∏µ‡∏Å */
      background: rgba(30, 40, 50, 0.7);
      border: 1px solid #4a6380;
      border-radius: 8px;
      margin-top: 20px;
      box-sizing: border-box;
      align-self: center; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ô Flex container */
      /* ‡πÄ‡∏û‡∏¥‡πà‡∏° display: block; ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡∏ñ‡∏π‡∏Å render ‡πÄ‡∏™‡∏°‡∏≠ */
      display: block; 
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
      padding: 12px;
      background: rgba(40, 60, 80, 0.6);
      border-radius: 8px;
      border: 1px solid #4a6380;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-active {
      background: #00ff00;
      box-shadow: 0 0 8px #00ff00;
    }
    
    .status-inactive {
      background: #ff5555;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .section {
        padding: 20px;
      }
      
      .button-group {
        flex-direction: column;
        align-items: center;
      }
      
      button {
        width: 100%;
        max-width: 300px;
      }
      
      .file-info {
        flex-direction: column;
        align-items: flex-start;
      }
      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
      #graphCanvas {
        height: 200px; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        max-width: 100%; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.8rem;
      }
      
      select, input[type=number], input.hex, button, input[type=file] {
        width: 100%;
        margin: 8px 0;
      }
      
      .hex-grid {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      }
      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏∏‡∏î */
      #graphCanvas {
        height: 150px; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1><span class="icon">üîß</span> WinOLS ECU Tuning Simulator (Advanced)</h1>
      <div class="subtitle">Professional-grade ECU remapping simulation for performance tuning</div>
    </header>

    <div class="section">
      <h3><span class="icon">üìÇ</span> File Operations</h3>
      <div>
        <label for="fileInput">Load ECU File (.bin/.hex):</label>
        <input type="file" id="fileInput" accept=".bin, .hex" disabled>
        <button onclick="simulateFileLoad()">Simulate Load</button>
        <button onclick="simulateFileSave()">Simulate Save</button>
      </div>
      <div id="messageArea"></div>
      <div class="file-info">
        <div><span class="status-indicator status-inactive"></span> ECU File: <span id="fileStatus">Not loaded</span></div>
        <div><span class="status-indicator status-inactive"></span> Current Map: <span id="mapStatus">None selected</span></div>
      </div>
    </div>

    <div class="section">
      <h3><span class="icon">‚öôÔ∏è</span> Vehicle & Model Selection</h3>
      <div>
        <label for="carBrand">Brand:</label>
        <select id="carBrand">
          <option value="Mazda">Mazda</option>
          <option value="Toyota">Toyota</option>
          <option value="Honda">Honda</option>
          <option value="Isuzu">Isuzu</option>
          <option value="Ford">Ford</option>
          <option value="Nissan">Nissan</option>
          <option value="BMW">BMW</option>
          <option value="Mercedes-Benz">Mercedes-Benz</option>
        </select>

        <label for="carModel">Model:</label>
        <select id="carModel"></select>
      </div>
    </div>

    <div class="section">
      <h3><span class="icon">üó∫Ô∏è</span> Map Selection & View Mode</h3>
      <div>
        <label for="mapType">Select Map for Tuning:</label>
        <select id="mapType"></select>
      </div>
      <div style="margin-top: 20px;">
        <label for="viewMode">Display Mode:</label>
        <select id="viewMode">
          <option value="text">Text</option>
          <option value="2d">2D Graph</option>
          <option value="3d">3d Graph (Simulated)</option>
        </select>
      </div>
      <canvas id="graphCanvas"></canvas> 
    </div>

    <div class="section">
      <h3><span class="icon">üìà</span> Map Tuning Area</h3>
      <div style="overflow-x: auto;">
        <table id="tuningTable">
          <thead>
            <tr><th>Axis X</th><th>Axis Y</th><th>Value</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h3><span class="icon">üî¢</span> HEX Viewer</h3>
      <div class="hex-grid" id="hexGrid"></div>
    </div>

    <div class="section">
      <div class="button-group">
        <button onclick="confirmTuning()"><span>‚úÖ</span> Confirm Tuning</button>
        <button onclick="compareMaps()"><span>üìä</span> Compare Maps</button>
        <button onclick="calculateChecksum()"><span>‚ûï</span> Calc Checksum</button>
        <button onclick="undoLastChange()"><span>‚Ü©Ô∏è</span> Undo</button>
        <button onclick="redoChange()"><span>‚Ü™Ô∏è</span> Redo</button>
      </div>
      <div id="resultArea"></div>
    </div>
  </div>

  <script>
    // --- Global State ---
    let currentECUFile = null;
    let currentMapData = null;
    let currentMapDefinition = null;
    let history = [];
    let historyPointer = -1;
    let myChart = null; // Variable to hold the Chart.js instance

    // --- Data Definitions ---
    const ecuDefinitions = {
      "Mazda": {
        "Mazda 2 Skyactiv-D (Diesel)": {
          iq_limit: {
            name: "IQ Limit (mg/stroke)",
            address: 0x1000, type: "8-bit unsigned", factor: 0.01, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "20" }, { rpm: 1000, load: 10, hexValue: "25" }, { rpm: 1500, load: 10, hexValue: "2A" }, { rpm: 2000, load: 10, hexValue: "2D" },
              { rpm: 2500, load: 10, hexValue: "30" }, { rpm: 3000, load: 10, hexValue: "32" }, { rpm: 3500, load: 10, hexValue: "34" }, { rpm: 4000, load: 10, hexValue: "35" },
              { rpm: 800, load: 30, hexValue: "30" }, { rpm: 1000, load: 30, hexValue: "35" }, { rpm: 1500, load: 30, hexValue: "3A" }, { rpm: 2000, load: 30, hexValue: "3D" },
              { rpm: 2500, load: 30, hexValue: "40" }, { rpm: 3000, load: 30, hexValue: "42" }, { rpm: 3500, load: 30, hexValue: "44" }, { rpm: 4000, load: 30, hexValue: "45" },
              { rpm: 800, load: 50, hexValue: "40" }, { rpm: 1000, load: 50, hexValue: "45" }, { rpm: 1500, load: 50, hexValue: "4A" }, { rpm: 2000, load: 50, hexValue: "4D" },
              { rpm: 2500, load: 50, hexValue: "50" }, { rpm: 3000, load: 50, hexValue: "52" }, { rpm: 3500, load: 50, hexValue: "54" }, { rpm: 4000, load: 50, hexValue: "55" },
              { rpm: 800, load: 70, hexValue: "50" }, { rpm: 1000, load: 70, hexValue: "55" }, { rpm: 1500, load: 70, hexValue: "5A" }, { rpm: 2000, load: 70, hexValue: "5D" },
              { rpm: 2500, load: 70, hexValue: "60" }, { rpm: 3000, load: 70, hexValue: "62" }, { rpm: 3500, load: 70, hexValue: "64" }, { rpm: 4000, load: 70, hexValue: "65" },
              { rpm: 800, load: 90, hexValue: "60" }, { rpm: 1000, load: 90, hexValue: "65" }, { rpm: 1500, load: 90, hexValue: "6A" }, { rpm: 2000, load: 90, hexValue: "6D" },
              { rpm: 2500, load: 90, hexValue: "70" }, { rpm: 3000, load: 90, hexValue: "72" }, { rpm: 3500, load: 90, hexValue: "74" }, { rpm: 4000, load: 90, hexValue: "75" },
              { rpm: 800, load: 100, hexValue: "68" }, { rpm: 1000, load: 100, hexValue: "6D" }, { rpm: 1500, load: 100, hexValue: "72" }, { rpm: 2000, load: 100, hexValue: "75" },
              { rpm: 2500, load: 100, hexValue: "78" }, { rpm: 3000, load: 100, hexValue: "7A" }, { rpm: 3500, load: 100, hexValue: "7C" }, { rpm: 4000, load: 100, hexValue: "7D" },
            ]
          },
          // --- ‡πÄ‡∏û‡∏¥‡πà‡∏° Injection Timing Map ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏µ‡πÄ‡∏ã‡∏• ---
          injection_timing: {
            name: "Injection Timing (degrees ATDC)", // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏µ‡πÄ‡∏ã‡∏•‡∏°‡∏±‡∏Å‡πÉ‡∏ä‡πâ ATDC (After TDC) ‡∏´‡∏£‡∏∑‡∏≠ BTDC (Before TDC) ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏•‡∏ö
            address: 0x1100, type: "16-bit signed", factor: 0.01, offset: 0, // ‡∏Ñ‡πà‡∏≤ factor/offset ‡∏™‡∏°‡∏°‡∏ï‡∏¥
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1200, 1800, 2500, 3000, 3500, 4000, 4500], load: [10, 20, 40, 60, 80, 100] },
            defaultData: [
              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Injection Timing (‡∏≠‡∏á‡∏®‡∏≤ ATDC, ‡∏Ñ‡πà‡∏≤‡∏ö‡∏ß‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å TDC, ‡∏Ñ‡πà‡∏≤‡∏•‡∏ö‡∏Ñ‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô TDC)
              // ‡πÄ‡∏ä‡πà‡∏ô 100 = 1.00 ‡∏≠‡∏á‡∏®‡∏≤, -200 = -2.00 ‡∏≠‡∏á‡∏®‡∏≤
              // RPM 800
              { rpm: 800, load: 10, hexValue: "FFEA" }, // -2.20 deg (Retarded for idle stability) -> FFEE
              { rpm: 800, load: 20, hexValue: "FFF5" }, // -1.00 deg
              { rpm: 800, load: 40, hexValue: "0005" }, // 0.05 deg
              { rpm: 800, load: 60, hexValue: "0010" }, // 0.16 deg
              { rpm: 800, load: 80, hexValue: "0020" }, // 0.32 deg
              { rpm: 800, load: 100, hexValue: "0030" }, // 0.48 deg (Full Load - Retarded for smoke/NVH)

              // RPM 1200
              { rpm: 1200, load: 10, hexValue: "FFD8" }, // -4.00 deg
              { rpm: 1200, load: 20, hexValue: "FFE8" }, // -2.00 deg
              { rpm: 1200, load: 40, hexValue: "0000" }, // 0.00 deg
              { rpm: 1200, load: 60, hexValue: "0018" }, // 0.24 deg
              { rpm: 1200, load: 80, hexValue: "0028" }, // 0.40 deg
              { rpm: 1200, load: 100, hexValue: "0040" }, // 0.64 deg

              // RPM 1800
              { rpm: 1800, load: 10, hexValue: "FFCC" }, // -5.00 deg
              { rpm: 1800, load: 20, hexValue: "FFDC" }, // -3.00 deg
              { rpm: 1800, load: 40, hexValue: "FFE8" }, // -2.00 deg
              { rpm: 1800, load: 60, hexValue: "0000" }, // 0.00 deg
              { rpm: 1800, load: 80, hexValue: "0010" }, // 0.16 deg
              { rpm: 1800, load: 100, hexValue: "0020" }, // 0.32 deg

              // RPM 2500
              { rpm: 2500, load: 10, hexValue: "FFC0" }, // -6.40 deg
              { rpm: 2500, load: 20, hexValue: "FFD0" }, // -4.80 deg
              { rpm: 2500, load: 40, hexValue: "FFE0" }, // -3.20 deg
              { rpm: 2500, load: 60, hexValue: "FFF0" }, // -1.60 deg
              { rpm: 2500, load: 80, hexValue: "0000" }, // 0.00 deg
              { rpm: 2500, load: 100, hexValue: "0010" }, // 0.16 deg

              // RPM 3000
              { rpm: 3000, load: 10, hexValue: "FFB0" }, // -8.00 deg
              { rpm: 3000, load: 20, hexValue: "FFC0" }, // -6.40 deg
              { rpm: 3000, load: 40, hexValue: "FFD0" }, // -4.80 deg
              { rpm: 3000, load: 60, hexValue: "FFE0" }, // -3.20 deg
              { rpm: 3000, load: 80, hexValue: "FFF0" }, // -1.60 deg
              { rpm: 3000, load: 100, hexValue: "0000" }, // 0.00 deg

              // RPM 3500
              { rpm: 3500, load: 10, hexValue: "FFA0" }, // -9.60 deg
              { rpm: 3500, load: 20, hexValue: "FFB0" }, // -8.00 deg
              { rpm: 3500, load: 40, hexValue: "FFC0" }, // -6.40 deg
              { rpm: 3500, load: 60, hexValue: "FFD0" }, // -4.80 deg
              { rpm: 3500, load: 80, hexValue: "FFE0" }, // -3.20 deg
              { rpm: 3500, load: 100, hexValue: "FFF0" }, // -1.60 deg

              // RPM 4000
              { rpm: 4000, load: 10, hexValue: "FF90" }, // -11.20 deg
              { rpm: 4000, load: 20, hexValue: "FFA0" }, // -9.60 deg
              { rpm: 4000, load: 40, hexValue: "FFB0" }, // -8.00 deg
              { rpm: 4000, load: 60, hexValue: "FFC0" }, // -6.40 deg
              { rpm: 4000, load: 80, hexValue: "FFD0" }, // -4.80 deg
              { rpm: 4000, load: 100, hexValue: "FFE0" }, // -3.20 deg

              // RPM 4500
              { rpm: 4500, load: 10, hexValue: "FF80" }, // -12.80 deg
              { rpm: 4500, load: 20, hexValue: "FF90" }, // -11.20 deg
              { rpm: 4500, load: 40, hexValue: "FFA0" }, // -9.60 deg
              { rpm: 4500, load: 60, hexValue: "FFB0" }, // -8.00 deg
              { rpm: 4500, load: 80, hexValue: "FFC0" }, // -6.40 deg
              { rpm: 4500, load: 100, hexValue: "FFD0" }, // -4.80 deg
            ]
          },
          // --- ‡πÄ‡∏û‡∏¥‡πà‡∏° Rail Pressure Map ---
          rail_pressure: {
            name: "Rail Pressure (bar)",
            address: 0x1200, type: "16-bit unsigned", factor: 0.1, offset: 0, // ‡∏Ñ‡πà‡∏≤ factor/offset ‡∏™‡∏°‡∏°‡∏ï‡∏¥
            axes: { x: "RPM", y: "IQ (mg/stroke)" },
            axisValues: { rpm: [800, 1500, 2500, 3500, 4500], iq: [10, 30, 50, 70] },
            defaultData: [
              // ‡∏Ñ‡πà‡∏≤ Rail Pressure (bar * 10)
              // RPM 800
              { rpm: 800, iq: 10, hexValue: "1F40" }, // 800 bar
              { rpm: 800, iq: 30, hexValue: "2EE0" }, // 1200 bar
              { rpm: 800, iq: 50, hexValue: "3A98" }, // 1500 bar
              { rpm: 800, iq: 70, hexValue: "44C0" }, // 1760 bar

              // RPM 1500
              { rpm: 1500, iq: 10, hexValue: "2710" }, // 1000 bar
              { rpm: 1500, iq: 30, hexValue: "36B0" }, // 1400 bar
              { rpm: 1500, iq: 50, hexValue: "4268" }, // 1680 bar
              { rpm: 1500, iq: 70, hexValue: "4E20" }, // 1920 bar

              // RPM 2500
              { rpm: 2500, iq: 10, hexValue: "32C8" }, // 1300 bar
              { rpm: 2500, iq: 30, hexValue: "40D0" }, // 1660 bar
              { rpm: 2500, iq: 50, hexValue: "4C88" }, // 1960 bar
              { rpm: 2500, iq: 70, hexValue: "5840" }, // 2260 bar

              // RPM 3500
              { rpm: 3500, iq: 10, hexValue: "3E80" }, // 1600 bar
              { rpm: 3500, iq: 30, hexValue: "4A38" }, // 1890 bar
              { rpm: 3500, iq: 50, hexValue: "55F0" }, // 2180 bar
              { rpm: 3500, iq: 70, hexValue: "61A8" }, // 2470 bar

              // RPM 4500
              { rpm: 4500, iq: 10, hexValue: "4A38" }, // 1890 bar
              { rpm: 4500, iq: 30, hexValue: "55F0" }, // 2180 bar
              { rpm: 4500, iq: 50, hexValue: "61A8" }, // 2470 bar
              { rpm: 4500, iq: 70, hexValue: "6D60" }, // 2750 bar
            ]
          },
          // --- ‡πÄ‡∏û‡∏¥‡πà‡∏° Torque Limiter Map ---
          torque_limiter: {
            name: "Torque Limiter (Nm)",
            address: 0x1300, type: "16-bit unsigned", factor: 1, offset: 0, // ‡∏Ñ‡πà‡∏≤ factor/offset ‡∏™‡∏°‡∏°‡∏ï‡∏¥
            axes: { x: "RPM", y: "Load" }, // ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "Gear" ‡∏´‡∏£‡∏∑‡∏≠ "Driver Demand"
            axisValues: { rpm: [800, 1500, 2500, 3500, 4500], load: [20, 40, 60, 80, 100] }, // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ Load ‡πÄ‡∏õ‡πá‡∏ô Driver Demand %
            defaultData: [
              // Torque Values (Nm)
              // RPM 800
              { rpm: 800, load: 20, hexValue: "00C8" }, // 200 Nm
              { rpm: 800, load: 40, hexValue: "012C" }, // 300 Nm
              { rpm: 800, load: 60, hexValue: "0190" }, // 400 Nm
              { rpm: 800, load: 80, hexValue: "01F4" }, // 500 Nm
              { rpm: 800, load: 100, hexValue: "0258" }, // 600 Nm

              // RPM 1500
              { rpm: 1500, load: 20, hexValue: "012C" }, // 300 Nm
              { rpm: 1500, load: 40, hexValue: "0190" }, // 400 Nm
              { rpm: 1500, load: 60, hexValue: "01F4" }, // 500 Nm
              { rpm: 1500, load: 80, hexValue: "0258" }, // 600 Nm
              { rpm: 1500, load: 100, hexValue: "02BC" }, // 700 Nm

              // RPM 2500
              { rpm: 2500, load: 20, hexValue: "0190" }, // 400 Nm
              { rpm: 2500, load: 40, hexValue: "01F4" }, // 500 Nm
              { rpm: 2500, load: 60, hexValue: "0258" }, // 600 Nm
              { rpm: 2500, load: 80, hexValue: "02BC" }, // 700 Nm
              { rpm: 2500, load: 100, hexValue: "0320" }, // 800 Nm

              // RPM 3500
              { rpm: 3500, load: 20, hexValue: "01F4" }, // 500 Nm
              { rpm: 3500, load: 40, hexValue: "0258" }, // 600 Nm
              { rpm: 3500, load: 60, hexValue: "02BC" }, // 700 Nm
              { rpm: 3500, load: 80, hexValue: "0320" }, // 800 Nm
              { rpm: 3500, load: 100, hexValue: "0384" }, // 900 Nm

              // RPM 4500
              { rpm: 4500, load: 20, hexValue: "0258" }, // 600 Nm
              { rpm: 4500, load: 40, hexValue: "02BC" }, // 700 Nm
              { rpm: 4500, load: 60, hexValue: "0320" }, // 800 Nm
              { rpm: 4500, load: 80, hexValue: "0384" }, // 900 Nm
              { rpm: 4500, load: 100, hexValue: "03E8" }, // 1000 Nm
            ]
          },
          // --- ‡πÄ‡∏û‡∏¥‡πà‡∏° RPM Limiter (Single value ‡∏´‡∏£‡∏∑‡∏≠ Simple Map) ---
          rpm_limiter: {
            name: "RPM Limiter (RPM)",
            address: 0x1400, type: "16-bit unsigned", factor: 1, offset: 0,
            axes: { x: "Value", y: "" }, // ‡πÄ‡∏õ‡πá‡∏ô Single Value ‡∏´‡∏£‡∏∑‡∏≠ 1D Map
            axisValues: { value: [""], "": [""] }, // Dummy for single value
            defaultData: [
              { value: "", hexValue: "18F0" } // 6384 RPM (‡∏™‡∏°‡∏°‡∏ï‡∏¥)
            ]
          },
          // --- ‡πÄ‡∏û‡∏¥‡πà‡∏° EGR Map ---
          egr_map: {
            name: "EGR Map (Valve Position %)",
            address: 0x1500, type: "8-bit unsigned", factor: 0.392, offset: 0, // 255 -> 100%
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1500, 2500, 3500, 4500], load: [10, 20, 30, 40, 50] }, // EGR ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà Load ‡∏ï‡πà‡∏≥-‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á
            defaultData: [
              // EGR Valve Opening (0-255 -> 0-100%)
              // RPM 800
              { rpm: 800, load: 10, hexValue: "FF" }, // 100% Open (idle)
              { rpm: 800, load: 20, hexValue: "E0" }, // ~88%
              { rpm: 800, load: 30, hexValue: "C0" }, // ~75%
              { rpm: 800, load: 40, hexValue: "80" }, // ~50%
              { rpm: 800, load: 50, hexValue: "40" }, // ~25%

              // RPM 1500
              { rpm: 1500, load: 10, hexValue: "F0" }, // ~94%
              { rpm: 1500, load: 20, hexValue: "D0" }, // ~82%
              { rpm: 1500, load: 30, hexValue: "A0" }, // ~63%
              { rpm: 1500, load: 40, hexValue: "60" }, // ~37%
              { rpm: 1500, load: 50, hexValue: "20" }, // ~12%

              // RPM 2500
              { rpm: 2500, load: 10, hexValue: "C0" }, // ~75%
              { rpm: 2500, load: 20, hexValue: "90" }, // ~56%
              { rpm: 2500, load: 30, hexValue: "60" }, // ~37%
              { rpm: 2500, load: 40, hexValue: "30" }, // ~18%
              { rpm: 2500, load: 50, hexValue: "00" }, // 0% (Closed at higher load/RPM)

              // RPM 3500
              { rpm: 3500, load: 10, hexValue: "80" }, // ~50%
              { rpm: 3500, load: 20, hexValue: "40" }, // ~25%
              { rpm: 3500, load: 30, hexValue: "20" }, // ~12%
              { rpm: 3500, load: 40, hexValue: "00" }, // 0%
              { rpm: 3500, load: 50, hexValue: "00" }, // 0%

              // RPM 4500
              { rpm: 4500, load: 10, hexValue: "40" }, // ~25%
              { rpm: 4500, load: 20, hexValue: "20" }, // ~12%
              { rpm: 4500, load: 30, hexValue: "00" }, // 0%
              { rpm: 4500, load: 40, hexValue: "00" }, // 0%
              { rpm: 4500, load: 50, hexValue: "00" }, // 0%
            ]
          },
          // --- ‡πÄ‡∏û‡∏¥‡πà‡∏° Boost Pressure Map ---
          boost_pressure: {
            name: "Boost Pressure (mbar)",
            address: 0x1600, type: "16-bit unsigned", factor: 1, offset: 0, // ‡∏Ñ‡πà‡∏≤ factor/offset ‡∏™‡∏°‡∏°‡∏ï‡∏¥, ‡πÄ‡∏ä‡πà‡∏ô 1000 = 1000 mbar (1 bar)
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [1500, 2000, 2500, 3000, 3500, 4000, 4500], load: [20, 40, 60, 80, 100] },
            defaultData: [
              // ‡∏Ñ‡πà‡∏≤ Boost Pressure (mbar)
              // RPM 1500
              { rpm: 1500, load: 20, hexValue: "05DC" }, // 1500 mbar
              { rpm: 1500, load: 40, hexValue: "06A4" }, // 1700 mbar
              { rpm: 1500, load: 60, hexValue: "07D0" }, // 2000 mbar
              { rpm: 1500, load: 80, hexValue: "08FC" }, // 2300 mbar
              { rpm: 1500, load: 100, hexValue: "0A28" }, // 2600 mbar

              // RPM 2000
              { rpm: 2000, load: 20, hexValue: "06A4" }, // 1700 mbar
              { rpm: 2000, load: 40, hexValue: "07D0" }, // 2000 mbar
              { rpm: 2000, load: 60, hexValue: "08FC" }, // 2300 mbar
              { rpm: 2000, load: 80, hexValue: "0A28" }, // 2600 mbar
              { rpm: 2000, load: 100, hexValue: "0BB8" }, // 3000 mbar

              // RPM 2500
              { rpm: 2500, load: 20, hexValue: "07D0" }, // 2000 mbar
              { rpm: 2500, load: 40, hexValue: "08FC" }, // 2300 mbar
              { rpm: 2500, load: 60, hexValue: "0A28" }, // 2600 mbar
              { rpm: 2500, load: 80, hexValue: "0BB8" }, // 3000 mbar
              { rpm: 2500, load: 100, hexValue: "0E10" }, // 3600 mbar

              // RPM 3000
              { rpm: 3000, load: 20, hexValue: "08FC" }, // 2300 mbar
              { rpm: 3000, load: 40, hexValue: "0A28" }, // 2600 mbar
              { rpm: 3000, load: 60, hexValue: "0BB8" }, // 3000 mbar
              { rpm: 3000, load: 80, hexValue: "0E10" }, // 3600 mbar
              { rpm: 3000, load: 100, hexValue: "1004" }, // 4100 mbar

              // RPM 3500
              { rpm: 3500, load: 20, hexValue: "0A28" }, // 2600 mbar
              { rpm: 3500, load: 40, hexValue: "0BB8" }, // 3000 mbar
              { rpm: 3500, load: 60, hexValue: "0E10" }, // 3600 mbar
              { rpm: 3500, load: 80, hexValue: "1004" }, // 4100 mbar
              { rpm: 3500, load: 100, hexValue: "11F8" }, // 4600 mbar

              // RPM 4000
              { rpm: 4000, load: 20, hexValue: "0BB8" }, // 3000 mbar
              { rpm: 4000, load: 40, hexValue: "0E10" }, // 3600 mbar
              { rpm: 4000, load: 60, hexValue: "1004" }, // 4100 mbar
              { rpm: 4000, load: 80, hexValue: "11F8" }, // 4600 mbar
              { rpm: 4000, load: 100, hexValue: "13EC" }, // 5100 mbar

              // RPM 4500
              { rpm: 4500, load: 20, hexValue: "0E10" }, // 3600 mbar
              { rpm: 4500, load: 40, hexValue: "1004" }, // 4100 mbar
              { rpm: 4500, load: 60, hexValue: "11F8" }, // 4600 mbar
              { rpm: 4500, load: 80, hexValue: "13EC" }, // 5100 mbar
              { rpm: 4500, load: 100, hexValue: "15E0" }, // 5600 mbar
            ]
          },
        },
        "Mazda 2 Skyactiv-G (Petrol)": {
          ignition_timing: {
            name: "Ignition Timing (degrees BTDC)",
            address: 0x1000, type: "8-bit signed", factor: 0.5, offset: -30,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000, 5500, 6000, 6500], load: [10, 20, 30, 40, 50, 60, 70, 80, 90, 100] },
            defaultData: [
              // RPM 800
              { rpm: 800, load: 10, hexValue: "50" }, // ~5 deg BTDC (Idle)
              { rpm: 800, load: 20, hexValue: "58" }, // ~9 deg BTDC
              { rpm: 800, load: 30, hexValue: "40" }, // ~ -10 deg BTDC (Low load, maybe for warm up)
              { rpm: 800, load: 40, hexValue: "38" },
              { rpm: 800, load: 50, hexValue: "30" },
              { rpm: 800, load: 60, hexValue: "28" },
              { rpm: 800, load: 70, hexValue: "20" },
              { rpm: 800, load: 80, hexValue: "18" },
              { rpm: 800, load: 90, hexValue: "10" },
              { rpm: 800, load: 100, hexValue: "08" }, // ~-26 deg BTDC (full load, very retarded for torque/cat protection)

              // RPM 1000
              { rpm: 1000, load: 10, hexValue: "54" }, // ~7 deg BTDC
              { rpm: 1000, load: 20, hexValue: "5C" }, // ~11 deg BTDC
              { rpm: 1000, load: 30, hexValue: "44" },
              { rpm: 1000, load: 40, hexValue: "3C" },
              { rpm: 1000, load: 50, hexValue: "34" },
              { rpm: 1000, load: 60, hexValue: "2C" },
              { rpm: 1000, load: 70, hexValue: "24" },
              { rpm: 1000, load: 80, hexValue: "1C" },
              { rpm: 1000, load: 90, hexValue: "14" },
              { rpm: 1000, load: 100, hexValue: "0C" },

              // RPM 1500
              { rpm: 1500, load: 10, hexValue: "60" }, // ~15 deg BTDC
              { rpm: 1500, load: 20, hexValue: "68" }, // ~19 deg BTDC
              { rpm: 1500, load: 30, hexValue: "50" },
              { rpm: 1500, load: 40, hexValue: "48" },
              { rpm: 1500, load: 50, hexValue: "40" },
              { rpm: 1500, load: 60, hexValue: "38" },
              { rpm: 1500, load: 70, hexValue: "30" },
              { rpm: 1500, load: 80, hexValue: "28" },
              { rpm: 1500, load: 90, hexValue: "20" },
              { rpm: 1500, load: 100, hexValue: "18" },

              // RPM 2000
              { rpm: 2000, load: 10, hexValue: "6A" }, // ~20 deg BTDC (Changed from 0.50 for realism)
              { rpm: 2000, load: 20, hexValue: "70" }, // ~25 deg BTDC
              { rpm: 2000, load: 30, hexValue: "58" },
              { rpm: 2000, load: 40, hexValue: "50" },
              { rpm: 2000, load: 50, hexValue: "48" },
              { rpm: 2000, load: 60, hexValue: "40" },
              { rpm: 2000, load: 70, hexValue: "38" },
              { rpm: 2000, load: 80, hexValue: "30" },
              { rpm: 2000, load: 90, hexValue: "28" },
              { rpm: 2000, load: 100, hexValue: "20" },

              // RPM 2500
              { rpm: 2500, load: 10, hexValue: "6E" }, // ~22 deg BTDC
              { rpm: 2500, load: 20, hexValue: "74" }, // ~27 deg BTDC
              { rpm: 2500, load: 30, hexValue: "60" },
              { rpm: 2500, load: 40, hexValue: "58" },
              { rpm: 2500, load: 50, hexValue: "50" },
              { rpm: 2500, load: 60, hexValue: "48" },
              { rpm: 2500, load: 70, hexValue: "40" },
              { rpm: 2500, load: 80, hexValue: "38" },
              { rpm: 2500, load: 90, hexValue: "30" },
              { rpm: 2500, load: 100, hexValue: "28" },

              // RPM 3000
              { rpm: 3000, load: 10, hexValue: "72" }, // ~24 deg BTDC
              { rpm: 3000, load: 20, hexValue: "78" }, // ~29 deg BTDC
              { rpm: 3000, load: 30, hexValue: "64" },
              { rpm: 3000, load: 40, hexValue: "5C" },
              { rpm: 3000, load: 50, hexValue: "54" },
              { rpm: 3000, load: 60, hexValue: "4C" },
              { rpm: 3000, load: 70, hexValue: "44" },
              { rpm: 3000, load: 80, hexValue: "3C" },
              { rpm: 3000, load: 90, hexValue: "34" },
              { rpm: 3000, load: 100, hexValue: "2C" },

              // RPM 3500
              { rpm: 3500, load: 10, hexValue: "76" }, // ~26 deg BTDC
              { rpm: 3500, load: 20, hexValue: "7C" }, // ~31 deg BTDC
              { rpm: 3500, load: 30, hexValue: "68" },
              { rpm: 3500, load: 40, hexValue: "60" },
              { rpm: 3500, load: 50, hexValue: "58" },
              { rpm: 3500, load: 60, hexValue: "50" },
              { rpm: 3500, load: 70, hexValue: "48" },
              { rpm: 3500, load: 80, hexValue: "40" },
              { rpm: 3500, load: 90, hexValue: "38" },
              { rpm: 3500, load: 100, hexValue: "30" },

              // RPM 4000
              { rpm: 4000, load: 10, hexValue: "7A" }, // ~28 deg BTDC
              { rpm: 4000, load: 20, hexValue: "80" }, // ~34 deg BTDC
              { rpm: 4000, load: 30, hexValue: "6C" },
              { rpm: 4000, load: 40, hexValue: "64" },
              { rpm: 4000, load: 50, hexValue: "5C" },
              { rpm: 4000, load: 60, hexValue: "54" },
              { rpm: 4000, load: 70, hexValue: "4C" },
              { rpm: 4000, load: 80, hexValue: "44" },
              { rpm: 4000, load: 90, hexValue: "3C" },
              { rpm: 4000, load: 100, hexValue: "34" },

              // RPM 4500 (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏Å‡∏ô RPM)
              { rpm: 4500, load: 10, hexValue: "7E" }, // ~30 deg BTDC
              { rpm: 4500, load: 20, hexValue: "84" }, // ~37 deg BTDC
              { rpm: 4500, load: 30, hexValue: "70" },
              { rpm: 4500, load: 40, hexValue: "68" },
              { rpm: 4500, load: 50, hexValue: "60" },
              { rpm: 4500, load: 60, hexValue: "58" },
              { rpm: 4500, load: 70, hexValue: "50" },
              { rpm: 4500, load: 80, hexValue: "48" },
              { rpm: 4500, load: 90, hexValue: "40" },
              { rpm: 4500, load: 100, hexValue: "38" },

              // RPM 5000 (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏Å‡∏ô RPM)
              { rpm: 5000, load: 10, hexValue: "82" }, // ~32 deg BTDC
              { rpm: 5000, load: 20, hexValue: "88" }, // ~39 deg BTDC
              { rpm: 5000, load: 30, hexValue: "74" },
              { rpm: 5000, load: 40, hexValue: "6C" },
              { rpm: 5000, load: 50, hexValue: "64" },
              { rpm: 5000, load: 60, hexValue: "5C" },
              { rpm: 5000, load: 70, hexValue: "54" },
              { rpm: 5000, load: 80, hexValue: "4C" },
              { rpm: 5000, load: 90, hexValue: "44" },
              { rpm: 5000, load: 100, hexValue: "3C" },

              // RPM 5500 (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏Å‡∏ô RPM)
              { rpm: 5500, load: 10, hexValue: "86" }, // ~34 deg BTDC
              { rpm: 5500, load: 20, hexValue: "8C" }, // ~41 deg BTDC
              { rpm: 5500, load: 30, hexValue: "78" },
              { rpm: 5500, load: 40, hexValue: "70" },
              { rpm: 5500, load: 50, hexValue: "68" },
              { rpm: 5500, load: 60, hexValue: "60" },
              { rpm: 5500, load: 70, hexValue: "58" },
              { rpm: 5500, load: 80, hexValue: "50" },
              { rpm: 5500, load: 90, hexValue: "48" },
              { rpm: 5500, load: 100, hexValue: "40" },

              // RPM 6000 (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏Å‡∏ô RPM)
              { rpm: 6000, load: 10, hexValue: "8A" }, // ~36 deg BTDC
              { rpm: 6000, load: 20, hexValue: "90" }, // ~43 deg BTDC
              { rpm: 6000, load: 30, hexValue: "7C" },
              { rpm: 6000, load: 40, hexValue: "74" },
              { rpm: 6000, load: 50, hexValue: "6C" },
              { rpm: 6000, load: 60, hexValue: "64" },
              { rpm: 6000, load: 70, hexValue: "5C" },
              { rpm: 6000, load: 80, hexValue: "54" },
              { rpm: 6000, load: 90, hexValue: "4C" },
              { rpm: 6000, load: 100, hexValue: "44" },

              // RPM 6500 (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏Å‡∏ô RPM)
              { rpm: 6500, load: 10, hexValue: "8E" }, // ~38 deg BTDC
              { rpm: 6500, load: 20, hexValue: "94" }, // ~45 deg BTDC
              { rpm: 6500, load: 30, hexValue: "80" },
              { rpm: 6500, load: 40, hexValue: "78" },
              { rpm: 6500, load: 50, hexValue: "70" },
              { rpm: 6500, load: 60, hexValue: "68" },
              { rpm: 6500, load: 70, hexValue: "60" },
              { rpm: 6500, load: 80, hexValue: "58" },
              { rpm: 6500, load: 90, hexValue: "50" },
              { rpm: 6500, load: 100, hexValue: "48" },
            ]
          },
          // --- Maps ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£ ---
          fuel_map_mt: {
            name: "Fuel Map (MT) (ms)",
            address: 0x1300, type: "16-bit unsigned", factor: 0.001, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1500, 2500, 3500, 4500, 5500, 6500], load: [10, 20, 40, 60, 80, 100] }, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏Å‡∏ô Load
            defaultData: [
                // RPM 800
                { rpm: 800, load: 10, hexValue: "01F4" }, // 500ms (idle)
                { rpm: 800, load: 20, hexValue: "02BC" }, // 700ms
                { rpm: 800, load: 40, hexValue: "03E8" }, // 1000ms
                { rpm: 800, load: 60, hexValue: "05DC" }, // 1500ms
                { rpm: 800, load: 80, hexValue: "06A4" }, // 1700ms
                { rpm: 800, load: 100, hexValue: "07D0" }, // 2000ms

                // RPM 1500
                { rpm: 1500, load: 10, hexValue: "02BC" }, // 700ms
                { rpm: 1500, load: 20, hexValue: "0320" }, // 800ms
                { rpm: 1500, load: 40, hexValue: "0514" }, // 1300ms
                { rpm: 1500, load: 60, hexValue: "06A4" }, // 1700ms
                { rpm: 1500, load: 80, hexValue: "07D0" }, // 2000ms
                { rpm: 1500, load: 100, hexValue: "08FC" }, // 2300ms

                // RPM 2500
                { rpm: 2500, load: 10, hexValue: "03E8" }, // 1000ms
                { rpm: 2500, load: 20, hexValue: "04B0" }, // 1200ms
                { rpm: 2500, load: 40, hexValue: "06A4" }, // 1700ms
                { rpm: 2500, load: 60, hexValue: "07D0" }, // 2000ms
                { rpm: 2500, load: 80, hexValue: "09C4" }, // 2500ms
                { rpm: 2500, load: 100, hexValue: "0B54" }, // 2900ms

                // RPM 3500
                { rpm: 3500, load: 10, hexValue: "0514" }, // 1300ms
                { rpm: 3500, load: 20, hexValue: "05DC" }, // 1500ms
                { rpm: 3500, load: 40, hexValue: "07D0" }, // 2000ms
                { rpm: 3500, load: 60, hexValue: "09C4" }, // 2500ms
                { rpm: 3500, load: 80, hexValue: "0BB8" }, // 3000ms
                { rpm: 3500, load: 100, hexValue: "0D48" }, // 3400ms

                // RPM 4500
                { rpm: 4500, load: 10, hexValue: "06A4" }, // 1700ms
                { rpm: 4500, load: 20, hexValue: "07D0" }, // 2000ms
                { rpm: 4500, load: 40, hexValue: "09C4" }, // 2500ms
                { rpm: 4500, load: 60, hexValue: "0BB8" }, // 3000ms
                { rpm: 4500, load: 80, hexValue: "0D48" }, // 3400ms
                { rpm: 4500, load: 100, hexValue: "0E7A" }, // 3700ms

                // RPM 5500
                { rpm: 5500, load: 10, hexValue: "07D0" }, // 2000ms
                { rpm: 5500, load: 20, hexValue: "08FC" }, // 2300ms
                { rpm: 5500, load: 40, hexValue: "0BB8" }, // 3000ms
                { rpm: 5500, load: 60, hexValue: "0D48" }, // 3400ms
                { rpm: 5500, load: 80, hexValue: "0E7A" }, // 3700ms
                { rpm: 5500, load: 100, hexValue: "1004" }, // 4100ms

                // RPM 6500
                { rpm: 6500, load: 10, hexValue: "08FC" }, // 2300ms
                { rpm: 6500, load: 20, hexValue: "0A28" }, // 2600ms
                { rpm: 6500, load: 40, hexValue: "0D48" }, // 3400ms
                { rpm: 6500, load: 60, hexValue: "0E7A" }, // 3700ms
                { rpm: 6500, load: 80, hexValue: "1004" }, // 4100ms
                { rpm: 6500, load: 100, hexValue: "1190" }, // 4500ms
            ]
          },
          fuel_map_at: {
            name: "Fuel Map (AT) (ms)",
            address: 0x1400, type: "16-bit unsigned", factor: 0.001, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1500, 2500, 3500, 4500, 5500, 6500], load: [10, 20, 40, 60, 80, 100] }, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏Å‡∏ô Load
            defaultData: [
                // Data for AT might differ slightly from MT (slightly richer for smoothness)
                // RPM 800
                { rpm: 800, load: 10, hexValue: "0226" }, // 550ms (idle)
                { rpm: 800, load: 20, hexValue: "02EE" }, // 750ms
                { rpm: 800, load: 40, hexValue: "041A" }, // 1050ms
                { rpm: 800, load: 60, hexValue: "060E" }, // 1550ms
                { rpm: 800, load: 80, hexValue: "06D6" }, // 1750ms
                { rpm: 800, load: 100, hexValue: "0802" }, // 2050ms

                // RPM 1500
                { rpm: 1500, load: 10, hexValue: "02EE" }, // 750ms
                { rpm: 1500, load: 20, hexValue: "0320" }, // 800ms
                { rpm: 1500, load: 40, hexValue: "0514" }, // 1300ms
                { rpm: 1500, load: 60, hexValue: "06A4" }, // 1700ms
                { rpm: 1500, load: 80, hexValue: "07D0" }, // 2000ms
                { rpm: 1500, load: 100, hexValue: "08FC" }, // 2300ms
            ]
          },
          // --- DTC Switch Map (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏µ‡πÄ‡∏ã‡∏•, ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Skyactiv-G) ---
          dtc_switch: {
            name: "DTC Switch (Diagnostic Trouble Code)",
            address: 0x2000, type: "8-bit unsigned", factor: 1, offset: 0,
            axes: { x: "DTC Code", y: "Status" },
            axisValues: { dtc_code: ["P0001", "P0002", "P0003", "P0004", "P0005"], status: ["Enabled/Disabled"] },
            defaultData: [
                { dtc_code: "P0001", hexValue: "01" }, // Enabled
                { dtc_code: "P0002", hexValue: "01" }, // Enabled
                { dtc_code: "P0003", hexValue: "00" }, // Disabled (Example: DPF related)
                { dtc_code: "P0004", hexValue: "01" }, // Enabled
                { dtc_code: "P0005", hexValue: "00" }  // Disabled (Example: EGR related)
            ]
          }
        }
      },
      "Toyota": { /* ... (Existing data) ... */ },
      "Honda": { /* ... (Existing data) ... */ },
      "Isuzu": { /* ... (Existing data) ... */ },
      "Ford": { /* ... (Existing data) ... */ },
      "Nissan": { /* ... (Existing data) ... */ },
      "BMW": { /* ... (Existing data) ... */ },
      "Mercedes-Benz": { /* ... (Existing data) ... */ }
    };

    // --- Helper Functions (unchanged, just added for completeness) ---

    // Function to convert hex to decimal
    function hexToDec(hex) {
        return parseInt(hex, 16);
    }

    // Function to convert decimal to hex
    function decToHex(dec) {
        return dec.toString(16).toUpperCase();
    }

    // Function to convert raw hex value to display value based on map definition
    function rawToDisplayValue(hexValue, mapDef) {
        let rawVal = hexToDec(hexValue);
        if (mapDef.type === "8-bit signed" || mapDef.type === "16-bit signed") {
            // Handle signed values
            if (mapDef.type === "8-bit signed" && rawVal > 127) {
                rawVal -= 256;
            } else if (mapDef.type === "16-bit signed" && rawVal > 32767) {
                rawVal -= 65536;
            }
        }
        return (rawVal * mapDef.factor) + mapDef.offset;
    }

    // Function to convert display value back to raw hex value
    function displayToRawValue(displayValue, mapDef) {
        let rawVal = Math.round((displayValue - mapDef.offset) / mapDef.factor);
        if (mapDef.type === "8-bit unsigned" && (rawVal < 0 || rawVal > 255)) {
            // Handle out of bounds for unsigned 8-bit
            return null; // Or throw error
        } else if (mapDef.type === "16-bit unsigned" && (rawVal < 0 || rawVal > 65535)) {
            // Handle out of bounds for unsigned 16-bit
            return null; // Or throw error
        } else if (mapDef.type === "8-bit signed") {
            if (rawVal < -128 || rawVal > 127) return null;
            if (rawVal < 0) rawVal += 256;
        } else if (mapDef.type === "16-bit signed") {
            if (rawVal < -32768 || rawVal > 32767) return null;
            if (rawVal < 0) rawVal += 65536;
        }
        return decToHex(rawVal);
    }

    // Function to update message area
    function showMessage(msg, type = 'info') {
        const messageArea = document.getElementById('messageArea');
        messageArea.textContent = msg;
        messageArea.className = `message-area ${type}`; // Add a class for styling
        messageArea.style.display = 'block'; // Ensure it's visible
        // Auto-hide after some time
        setTimeout(() => {
            messageArea.style.display = 'none';
        }, 5000);
    }

    // --- Core Logic Functions ---

    function populateCarModels() {
      const carBrand = document.getElementById('carBrand').value;
      const carModelSelect = document.getElementById('carModel');
      carModelSelect.innerHTML = ''; // Clear previous models

      if (ecuDefinitions[carBrand]) {
        for (const model in ecuDefinitions[carBrand]) {
          const option = document.createElement('option');
          option.value = model;
          option.textContent = model;
          carModelSelect.appendChild(option);
        }
      }
      populateMapTypes(); // Populate maps after models are set
    }

    function populateMapTypes() {
      const carBrand = document.getElementById('carBrand').value;
      const carModel = document.getElementById('carModel').value;
      const mapTypeSelect = document.getElementById('mapType');
      mapTypeSelect.innerHTML = ''; // Clear previous map types

      if (ecuDefinitions[carBrand] && ecuDefinitions[carBrand][carModel]) {
        for (const mapId in ecuDefinitions[carBrand][carModel]) {
          const option = document.createElement('option');
          option.value = mapId;
          option.textContent = ecuDefinitions[carBrand][carModel][mapId].name;
          mapTypeSelect.appendChild(option);
        }
      }
      // Select the first map by default and display it
      if (mapTypeSelect.options.length > 0) {
        mapTypeSelect.value = mapTypeSelect.options[0].value;
        displayCurrentMap();
      } else {
        document.getElementById('tuningTable').innerHTML = '<thead><tr><th>Axis X</th><th>Axis Y</th><th>Value</th></tr></thead><tbody></tbody>';
        document.getElementById('hexGrid').innerHTML = '';
        document.getElementById('mapStatus').textContent = 'None selected';
        if (myChart) {
            myChart.destroy(); // Destroy previous chart if exists
            myChart = null;
        }
      }
    }

    function simulateFileLoad() {
      // In a real scenario, this would parse a .bin or .hex file
      // For this simulator, we'll just "load" the default data for the selected map
      const carBrand = document.getElementById('carBrand').value;
      const carModel = document.getElementById('carModel').value;
      const mapType = document.getElementById('mapType').value;

      if (!carBrand || !carModel || !mapType) {
        showMessage('Please select a car model and map type first.', 'error');
        return;
      }

      currentMapDefinition = ecuDefinitions[carBrand][carModel][mapType];
      // Deep copy defaultData to currentMapData to allow modifications
      currentMapData = JSON.parse(JSON.stringify(currentMapDefinition.defaultData));
      
      // Clear history and add initial state
      history = [];
      historyPointer = -1;
      addHistoryState();

      document.getElementById('fileStatus').textContent = 'Loaded (Simulated)';
      document.querySelector('.file-info .status-indicator.status-inactive').classList.remove('status-inactive');
      document.querySelector('.file-info .status-indicator').classList.add('status-active');
      showMessage(`Simulated loading of ECU file. Map '${currentMapDefinition.name}' ready for tuning.`, 'success');
      displayCurrentMap();
    }

    function simulateFileSave() {
      if (!currentECUFile && !currentMapData) {
        showMessage('No ECU data to save. Load a file or select a map first.', 'error');
        return;
      }
      showMessage('Simulated saving of tuned ECU file. (No actual file saved in browser)', 'success');
    }

    function displayCurrentMap() {
      if (!currentMapData || !currentMapDefinition) {
        document.getElementById('tuningTable').innerHTML = '<thead><tr><th>Axis X</th><th>Axis Y</th><th>Value</th></tr></thead><tbody></tbody>';
        document.getElementById('hexGrid').innerHTML = '';
        document.getElementById('mapStatus').textContent = 'None selected';
        if (myChart) {
            myChart.destroy();
            myChart = null;
        }
        return;
      }

      document.getElementById('mapStatus').textContent = currentMapDefinition.name;
      const viewMode = document.getElementById('viewMode').value;

      if (viewMode === 'text') {
        renderTuningTable();
        document.getElementById('graphCanvas').style.display = 'none';
      } else if (viewMode === '2d') {
        render2DGraph();
        document.getElementById('tuningTable').innerHTML = '<thead><tr><th>Axis X</th><th>Axis Y</th><th>Value</th></tr></thead><tbody></tbody>'; // Hide table
        document.getElementById('graphCanvas').style.display = 'block';
      } else if (viewMode === '3d') {
        render3DGraphSimulated();
        document.getElementById('tuningTable').innerHTML = '<thead><tr><th>Axis X</th><th>Axis Y</th><th>Value</th></tr></thead><tbody></tbody>'; // Hide table
        document.getElementById('graphCanvas').style.display = 'block';
      }
      renderHexGrid(); // Always show hex grid
    }

    function renderTuningTable() {
        const tableBody = document.getElementById('tuningTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';
        const tableHead = document.getElementById('tuningTable').getElementsByTagName('thead')[0];
        tableHead.innerHTML = `<tr><th>${currentMapDefinition.axes.x}</th><th>${currentMapDefinition.axes.y}</th><th>Value</th></tr>`;


        const xAxisValues = currentMapDefinition.axisValues.rpm || currentMapDefinition.axisValues.dtc_code || currentMapDefinition.axisValues.value;
        const yAxisValues = currentMapDefinition.axisValues.load || currentMapDefinition.axisValues.status || currentMapDefinition.axisValues.iq || [""]; // Use empty string for 1D map y-axis

        // For single-value maps like RPM Limiter, adjust the table rendering
        if (currentMapDefinition.axes.y === "") { // It's a 1D or single value map
            const row = tableBody.insertRow();
            const cellX = row.insertCell();
            const cellY = row.insertCell();
            const cellValue = row.insertCell();

            cellX.textContent = currentMapDefinition.name; // Use map name as X label
            cellY.textContent = ''; // No Y-axis label

            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'map-value-input';
            const dataPoint = currentMapData[0]; // Assuming single data point for 1D
            input.value = rawToDisplayValue(dataPoint.hexValue, currentMapDefinition).toFixed(currentMapDefinition.factor < 1 ? 2 : 0);
            input.onchange = (e) => {
                const newValue = parseFloat(e.target.value);
                const newHex = displayToRawValue(newValue, currentMapDefinition);
                if (newHex !== null) {
                    addHistoryState(); // Save current state before modification
                    dataPoint.hexValue = newHex;
                    renderHexGrid(); // Update hex grid
                    // Don't re-render table to avoid input focus loss, only update value
                    e.target.value = rawToDisplayValue(dataPoint.hexValue, currentMapDefinition).toFixed(currentMapDefinition.factor < 1 ? 2 : 0);
                    showMessage(`Value updated for ${currentMapDefinition.name}.`, 'info');
                } else {
                    showMessage('Invalid value: out of range for this map type.', 'error');
                    e.target.value = rawToDisplayValue(dataPoint.hexValue, currentMapDefinition).toFixed(currentMapDefinition.factor < 1 ? 2 : 0); // Revert
                }
            };
            cellValue.appendChild(input);
        } else { // 2D map
            yAxisValues.forEach(yVal => {
                const row = tableBody.insertRow();
                const cellY = row.insertCell();
                cellY.textContent = yVal; // Y-axis label

                xAxisValues.forEach(xVal => {
                    const cellValue = row.insertCell();
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'map-value-input';

                    // Find the corresponding data point
                    const dataPoint = currentMapData.find(d => {
                        const xMatch = d[currentMapDefinition.axes.x.toLowerCase()] === xVal;
                        const yMatch = d[currentMapDefinition.axes.y.toLowerCase()] === yVal;
                        return xMatch && yMatch;
                    });

                    if (dataPoint) {
                        input.value = rawToDisplayValue(dataPoint.hexValue, currentMapDefinition).toFixed(currentMapDefinition.factor < 1 ? 2 : 0); // Format based on factor
                        input.onchange = (e) => {
                            const newValue = parseFloat(e.target.value);
                            const newHex = displayToRawValue(newValue, currentMapDefinition);
                            if (newHex !== null) {
                                addHistoryState(); // Save current state before modification
                                dataPoint.hexValue = newHex;
                                renderHexGrid(); // Update hex grid
                                // Don't re-render table to avoid input focus loss, only update value
                                e.target.value = rawToDisplayValue(dataPoint.hexValue, currentMapDefinition).toFixed(currentMapDefinition.factor < 1 ? 2 : 0);
                                showMessage(`Value updated at ${currentMapDefinition.axes.x}: ${xVal}, ${currentMapDefinition.axes.y}: ${yVal}.`, 'info');
                            } else {
                                showMessage('Invalid value: out of range for this map type.', 'error');
                                e.target.value = rawToDisplayValue(dataPoint.hexValue, currentMapDefinition).toFixed(currentMapDefinition.factor < 1 ? 2 : 0); // Revert
                            }
                        };
                    } else {
                        input.value = 'N/A'; // Or some default if data point is missing
                        input.disabled = true;
                    }
                    cellValue.appendChild(input);
                });
            });

            // Add X-axis header row after Y-axis values
            const xAxisHeaderRow = tableBody.insertRow(0); // Insert at the top
            xAxisHeaderRow.insertCell().textContent = ''; // Empty cell for Y-axis header
            xAxisValues.forEach(xVal => {
                const th = document.createElement('th');
                th.textContent = xVal;
                xAxisHeaderRow.appendChild(th);
            });
        }
    }


    function renderHexGrid() {
        const hexGrid = document.getElementById('hexGrid');
        hexGrid.innerHTML = '';
        if (!currentMapData || !currentMapDefinition) return;

        currentMapData.forEach((dataPoint, index) => {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'hex';
            input.maxLength = currentMapDefinition.type.includes("16-bit") ? 4 : 2; // 4 chars for 16-bit, 2 for 8-bit
            input.value = dataPoint.hexValue;
            input.dataset.index = index; // Store index for updating
            input.onchange = (e) => {
                const newHex = e.target.value.toUpperCase();
                // Basic validation for hex
                const validHexPattern = currentMapDefinition.type.includes("16-bit") ? /^[0-9A-F]{1,4}$/ : /^[0-9A-F]{1,2}$/;
                if (validHexPattern.test(newHex) && hexToDec(newHex) !== null) {
                    addHistoryState(); // Save current state before modification
                    dataPoint.hexValue = newHex.padStart(input.maxLength, '0'); // Pad with leading zeros
                    displayCurrentMap(); // Re-render the table/graph to reflect hex change
                    showMessage(`HEX value updated at index ${index}.`, 'info');
                } else {
                    showMessage('Invalid HEX value. Please enter valid hexadecimal characters (0-9, A-F).', 'error');
                    e.target.value = dataPoint.hexValue; // Revert to old value
                }
            };
            hexGrid.appendChild(input);
        });
    }


    function render2DGraph() {
        const canvas = document.getElementById('graphCanvas');
        const ctx = canvas.getContext('2d');

        if (myChart) {
            myChart.destroy(); // Destroy previous chart instance
        }

        const xAxisName = currentMapDefinition.axes.x;
        const yAxisName = currentMapDefinition.axes.y;

        // Collect data for Chart.js
        const labels = currentMapDefinition.axisValues[xAxisName.toLowerCase()];
        const datasets = [];

        // Determine unique Y-axis values (Load, IQ, etc.)
        const uniqueYValues = currentMapDefinition.axisValues[yAxisName.toLowerCase()] || ["Single Value"];

        const colors = [
            'rgba(255, 99, 132, 0.8)', // Red
            'rgba(54, 162, 235, 0.8)', // Blue
            'rgba(255, 206, 86, 0.8)', // Yellow
            'rgba(75, 192, 192, 0.8)', // Green
            'rgba(153, 102, 255, 0.8)', // Purple
            'rgba(255, 159, 64, 0.8)', // Orange
            'rgba(199, 199, 199, 0.8)', // Grey
            'rgba(83, 102, 255, 0.8)', // Indigo
            'rgba(255, 99, 255, 0.8)', // Pink
            'rgba(0, 200, 0, 0.8)'    // Dark Green
        ];

        uniqueYValues.forEach((yVal, index) => {
            const data = [];
            labels.forEach(xVal => {
                const dataPoint = currentMapData.find(d =>
                    d[xAxisName.toLowerCase()] === xVal &&
                    (yAxisName === "" || d[yAxisName.toLowerCase()] === yVal)
                );
                if (dataPoint) {
                    data.push(rawToDisplayValue(dataPoint.hexValue, currentMapDefinition));
                } else {
                    data.push(null); // No data for this point
                }
            });

            datasets.push({
                label: `${yAxisName}: ${yVal}`,
                data: data,
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length].replace('0.8', '0.2'), // Lighter fill
                borderWidth: 2,
                pointRadius: 5,
                pointBackgroundColor: colors[index % colors.length],
                fill: false, // No fill under the line
                tension: 0.3 // Smooth lines
            });
        });

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Allow canvas to resize freely
                plugins: {
                    title: {
                        display: true,
                        text: currentMapDefinition.name,
                        color: '#eee',
                        font: { size: 16 }
                    },
                    legend: {
                        display: true,
                        position: 'right',
                        labels: {
                            color: '#eee'
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: xAxisName,
                            color: '#aaccff'
                        },
                        ticks: { color: '#eee' },
                        grid: { color: 'rgba(74, 99, 128, 0.3)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: currentMapDefinition.name.split('(')[0].trim(), // Use a cleaner Y-axis title
                            color: '#aaccff'
                        },
                        ticks: { color: '#eee' },
                        grid: { color: 'rgba(74, 99, 128, 0.3)' }
                    }
                }
            }
        });
    }

    // This is a simplified 3D graph simulation.
    // A true 3D graph would require a more complex library (e.g., three.js, plotly.js).
    // Here, we'll just display a message and optionally a placeholder image.
    function render3DGraphSimulated() {
        const canvas = document.getElementById('graphCanvas');
        const ctx = canvas.getContext('2d');

        if (myChart) {
            myChart.destroy(); // Destroy previous chart instance
        }
        
        ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

        // Display a message for 3D simulation
        ctx.fillStyle = '#eee';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText("3D Graph Simulation", canvas.width / 2, canvas.height / 2 - 20);
        ctx.fillText("A full 3D rendering requires advanced libraries (e.g., three.js)", canvas.width / 2, canvas.height / 2 + 10);
        ctx.fillText("This is a placeholder.", canvas.width / 2, canvas.height / 2 + 40);

        // Optionally, you can draw a simple cube or placeholder shape
        ctx.strokeStyle = '#00bfff';
        ctx.lineWidth = 2;
        ctx.strokeRect(canvas.width / 2 - 75, canvas.height / 2 - 100, 150, 150);
    }


    function confirmTuning() {
      if (!currentMapData) {
        showMessage('No map data loaded to confirm tuning.', 'error');
        return;
      }
      showMessage('Tuning confirmed! Changes are now "applied" to the simulated ECU.', 'success');
      // In a real application, this would trigger a write operation
    }

    function compareMaps() {
      if (!currentMapData) {
        showMessage('No map data loaded for comparison.', 'error');
        return;
      }
      showMessage('Simulating map comparison... (Feature not fully implemented in this simulator)', 'info');
      // In a real application, this would load a reference map and compare values
    }

    function calculateChecksum() {
      if (!currentMapData) {
        showMessage('No map data loaded to calculate checksum.', 'error');
        return;
      }
      // Simple simulated checksum (not real)
      const simulatedChecksum = Math.floor(Math.random() * 0xFFFFFFFF).toString(16).toUpperCase().padStart(8, '0');
      showMessage(`Simulated Checksum: 0x${simulatedChecksum}`, 'info');
    }

    // --- Undo/Redo Functionality ---
    function addHistoryState() {
        // Ensure we don't add duplicate states if undo/redo was used
        if (historyPointer < history.length - 1) {
            history = history.slice(0, historyPointer + 1);
        }
        history.push(JSON.parse(JSON.stringify(currentMapData)));
        historyPointer = history.length - 1;
    }

    function undoLastChange() {
        if (historyPointer > 0) {
            historyPointer--;
            currentMapData = JSON.parse(JSON.stringify(history[historyPointer]));
            displayCurrentMap();
            showMessage('Undid last change.', 'info');
        } else {
            showMessage('No more changes to undo.', 'info');
        }
    }

    function redoChange() {
        if (historyPointer < history.length - 1) {
            historyPointer++;
            currentMapData = JSON.parse(JSON.stringify(history[historyPointer]));
            displayCurrentMap();
            showMessage('Redid change.', 'info');
        } else {
            showMessage('No more changes to redo.', 'info');
        }
    }


    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
      populateCarModels(); // Initial population
      document.getElementById('carBrand').addEventListener('change', populateCarModels);
      document.getElementById('carModel').addEventListener('change', populateMapTypes);
      document.getElementById('mapType').addEventListener('change', displayCurrentMap);
      document.getElementById('viewMode').addEventListener('change', displayCurrentMap);

      // Simulate initial file load on page load for immediate interaction
      simulateFileLoad();
    });
  </script>
</body>
</html>
