<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>WinOLS ECU Tuning Simulator (Advanced)</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #333; /* Dark background similar to WinOLS */
      color: #eee; /* Light text for contrast */
      padding: 20px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: #00bfff; /* A bright blue for headings */
      text-align: center;
      margin-bottom: 30px;
    }

    .section {
      background: #444; /* Slightly lighter dark for sections */
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
      width: 90%;
      max-width: 800px;
      border: 1px solid #555;
    }

    .section h3 {
      color: #00bfff;
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #555;
      margin-bottom: 20px;
    }

    label {
      margin-right: 10px;
      color: #ccc;
      white-space: nowrap; /* Prevent line breaks */
    }

    select, input[type=number], input.hex, button, input[type=file] {
      background: #555;
      color: #eee;
      border: 1px solid #666;
      padding: 8px;
      margin: 5px 10px 5px 0;
      border-radius: 4px;
      font-size: 1em;
    }

    select:focus, input:focus, button:focus, input[type=file]:focus {
      outline: none;
      border-color: #00bfff;
      box-shadow: 0 0 5px rgba(0, 191, 255, 0.5);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #3a3a3a; /* Darker background for table */
    }

    th, td {
      border: 1px solid #555;
      text-align: center;
      padding: 8px;
      color: #eee;
    }

    th {
      background: #4a4a4a;
      color: #00bfff;
    }

    input.map-value-input { /* Specific class for table inputs */
      width: 80px; /* Adjust width for better number input visibility */
      text-align: center;
    }

    .hex-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); /* Responsive grid for hex values */
      gap: 8px;
      margin-top: 15px;
      padding: 10px;
      background: #3a3a3a;
      border-radius: 4px;
      border: 1px solid #555;
    }

    input.hex {
      width: 100%; /* Make hex inputs fill their grid cell */
      box-sizing: border-box; /* Include padding and border in the element's total width and height */
      text-transform: uppercase; /* Ensure hex values are uppercase */
      font-family: 'Consolas', 'Monaco', monospace; /* Monospace font for hex values */
    }

    button {
      background: #00bfff; /* Bright blue for the button */
      color: #fff;
      border: none;
      padding: 12px 25px;
      cursor: pointer;
      font-size: 1.1em;
      transition: background 0.3s ease, transform 0.2s ease;
      margin-top: 10px;
      display: block; /* Make button full width in its container */
      width: fit-content; /* Adjust to content width */
      margin-left: auto; /* Center button */
      margin-right: auto; /* Center button */
    }

    button:hover {
      background: #009acd;
      transform: translateY(-2px);
    }

    #resultArea, #messageArea {
      margin-top: 20px;
      padding: 15px;
      background: #3a3a3a;
      border: 1px solid #00bfff;
      border-radius: 4px;
      color: #aaffaa; /* Greenish color for success message */
      text-align: center;
      font-size: 1.1em;
    }
    #messageArea.error {
        color: #ffaaaa;
        border-color: #ff0000;
    }

    .button-group {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }

    #graphCanvas {
        width: 100%; /* Make canvas responsive to its container */
        max-width: 700px; /* Limit max width */
        height: 350px; /* Set a fixed height for consistency */
        background: #2a2a2a;
        border: 1px solid #555;
        border-radius: 4px;
        margin-top: 15px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <h1>üîß WinOLS ECU Tuning Simulator (Advanced)</h1>

  <div class="section">
    <h3>üìÇ File Operations</h3>
    <div>
      <label for="fileInput">Load ECU File (.bin/.hex):</label>
      <input type="file" id="fileInput" accept=".bin, .hex">
      <button onclick="simulateFileLoad()">Simulate Load</button>
      <button onclick="simulateFileSave()">Simulate Save</button>
    </div>
    <div id="messageArea"></div>
  </div>

  <div class="section">
    <h3>‚öôÔ∏è Vehicle & Model Selection</h3>
    <div>
      <label for="carBrand">Brand:</label>
      <select id="carBrand">
        <option value="Mazda">Mazda</option>
        <option value="Toyota">Toyota</option>
        <option value="Honda">Honda</option>
        <option value="Isuzu">Isuzu</option>
        <option value="Ford">Ford</option>
        <option value="Nissan">Nissan</option>
        <option value="BMW">BMW</option>
        <option value="Mercedes-Benz">Mercedes-Benz</option>
      </select>

      <label for="carModel">Model:</label>
      <select id="carModel">
        </select>
    </div>
  </div>

  <div class="section">
    <h3>üó∫Ô∏è Map Selection & View Mode</h3>
    <div>
      <label for="mapType">Select Map for Tuning:</label>
      <select id="mapType">
        </select>
    </div>
    <div style="margin-top: 15px;">
      <label for="viewMode">Display Mode:</label>
      <select id="viewMode">
        <option value="text">Text</option>
        <option value="2d">2D Graph</option>
        <option value="3d">3D Graph (Simulated)</option>
      </select>
    </div>
    <canvas id="graphCanvas" style="display: none;"></canvas>
  </div>

  <div class="section">
    <h3>üìà Map Tuning Area</h3>
    <table id="tuningTable">
      <thead>
        <tr><th>Axis X</th><th>Axis Y</th><th>Value</th></tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>

  <div class="section">
    <h3>üî¢ HEX Viewer</h3>
    <div class="hex-grid" id="hexGrid">
      </div>
  </div>

  <div class="section">
    <div class="button-group">
        <button onclick="confirmTuning()">‚úÖ Confirm Tuning</button>
        <button onclick="compareMaps()">üìä Compare Maps</button>
        <button onclick="calculateChecksum()">‚ûï Calc Checksum</button>
        <button onclick="undoLastChange()">‚Ü©Ô∏è Undo</button>
    </div>
    <div id="resultArea"></div>
  </div>

  <script>
    // --- Global State ---
    let currentECUFile = null;
    let currentMapData = null;
    let currentMapDefinition = null;
    let history = [];
    let historyPointer = -1;

    // --- Data Definitions (Expanded with more realistic and diverse maps) ---
    // Note: 'defaultData' contains {axisX_value, axisY_value, hexValue} for 2D maps
    // For 1D maps, axisY_value might be null or not present.
    // For raw maps (like DTC), use {id, hexValue}.
    const ecuDefinitions = {
      "Mazda": {
        "Mazda 2 Skyactiv-D (Diesel)": {
          iq_limit: {
            name: "IQ Limit (mg/stroke)",
            address: 0x1000, type: "8-bit unsigned", factor: 0.01, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "20" }, { rpm: 1000, load: 10, hexValue: "25" }, { rpm: 1500, load: 10, hexValue: "2A" }, { rpm: 2000, load: 10, hexValue: "2D" },
              { rpm: 2500, load: 10, hexValue: "30" }, { rpm: 3000, load: 10, hexValue: "32" }, { rpm: 3500, load: 10, hexValue: "34" }, { rpm: 4000, load: 10, hexValue: "35" },
              { rpm: 800, load: 30, hexValue: "30" }, { rpm: 1000, load: 30, hexValue: "35" }, { rpm: 1500, load: 30, hexValue: "3A" }, { rpm: 2000, load: 30, hexValue: "3D" },
              { rpm: 2500, load: 30, hexValue: "40" }, { rpm: 3000, load: 30, hexValue: "42" }, { rpm: 3500, load: 30, hexValue: "44" }, { rpm: 4000, load: 30, hexValue: "45" },
              { rpm: 800, load: 50, hexValue: "40" }, { rpm: 1000, load: 50, hexValue: "45" }, { rpm: 1500, load: 50, hexValue: "4A" }, { rpm: 2000, load: 50, hexValue: "4D" },
              { rpm: 2500, load: 50, hexValue: "50" }, { rpm: 3000, load: 50, hexValue: "52" }, { rpm: 3500, load: 50, hexValue: "54" }, { rpm: 4000, load: 50, hexValue: "55" },
              { rpm: 800, load: 70, hexValue: "50" }, { rpm: 1000, load: 70, hexValue: "55" }, { rpm: 1500, load: 70, hexValue: "5A" }, { rpm: 2000, load: 70, hexValue: "5D" },
              { rpm: 2500, load: 70, hexValue: "60" }, { rpm: 3000, load: 70, hexValue: "62" }, { rpm: 3500, load: 70, hexValue: "64" }, { rpm: 4000, load: 70, hexValue: "65" },
              { rpm: 800, load: 90, hexValue: "60" }, { rpm: 1000, load: 90, hexValue: "65" }, { rpm: 1500, load: 90, hexValue: "6A" }, { rpm: 2000, load: 90, hexValue: "6D" },
              { rpm: 2500, load: 90, hexValue: "70" }, { rpm: 3000, load: 90, hexValue: "72" }, { rpm: 3500, load: 90, hexValue: "74" }, { rpm: 4000, load: 90, hexValue: "75" },
              { rpm: 800, load: 100, hexValue: "68" }, { rpm: 1000, load: 100, hexValue: "6D" }, { rpm: 1500, load: 100, hexValue: "72" }, { rpm: 2000, load: 100, hexValue: "75" },
              { rpm: 2500, load: 100, hexValue: "78" }, { rpm: 3000, load: 100, hexValue: "7A" }, { rpm: 3500, load: 100, hexValue: "7C" }, { rpm: 4000, load: 100, hexValue: "7D" },
            ]
          },
          main_injection: {
            name: "Main Injection Quantity (mg/stroke)",
            address: 0x1100, type: "8-bit unsigned", factor: 0.02, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "1A" }, { rpm: 1000, load: 10, hexValue: "1C" }, { rpm: 1500, load: 10, hexValue: "1E" }, { rpm: 2000, load: 10, hexValue: "20" },
              { rpm: 2500, load: 10, hexValue: "22" }, { rpm: 3000, load: 10, hexValue: "24" }, { rpm: 3500, load: 10, hexValue: "26" }, { rpm: 4000, load: 10, hexValue: "27" },
              { rpm: 800, load: 30, hexValue: "25" }, { rpm: 1000, load: 30, hexValue: "28" }, { rpm: 1500, load: 30, hexValue: "2B" }, { rpm: 2000, load: 30, hexValue: "2E" },
              { rpm: 2500, load: 30, hexValue: "30" }, { rpm: 3000, load: 30, hexValue: "32" }, { rpm: 3500, load: 30, hexValue: "34" }, { rpm: 4000, load: 30, hexValue: "35" },
              { rpm: 800, load: 50, hexValue: "30" }, { rpm: 1000, load: 50, hexValue: "33" }, { rpm: 1500, load: 50, hexValue: "36" }, { rpm: 2000, load: 50, hexValue: "39" },
              { rpm: 2500, load: 50, hexValue: "3B" }, { rpm: 3000, load: 50, hexValue: "3D" }, { rpm: 3500, load: 50, hexValue: "3F" }, { rpm: 4000, load: 50, hexValue: "40" },
              { rpm: 800, load: 70, hexValue: "3B" }, { rpm: 1000, load: 70, hexValue: "3E" }, { rpm: 1500, load: 70, hexValue: "41" }, { rpm: 2000, load: 70, hexValue: "44" },
              { rpm: 2500, load: 70, hexValue: "46" }, { rpm: 3000, load: 70, hexValue: "48" }, { rpm: 3500, load: 70, hexValue: "4A" }, { rpm: 4000, load: 70, hexValue: "4B" },
              { rpm: 800, load: 90, hexValue: "48" }, { rpm: 1000, load: 90, hexValue: "4B" }, { rpm: 1500, load: 90, hexValue: "4E" }, { rpm: 2000, load: 90, hexValue: "51" },
              { rpm: 2500, load: 90, hexValue: "53" }, { rpm: 3000, load: 90, hexValue: "55" }, { rpm: 3500, load: 90, hexValue: "57" }, { rpm: 4000, load: 90, hexValue: "58" },
              { rpm: 800, load: 100, hexValue: "50" }, { rpm: 1000, load: 100, hexValue: "53" }, { rpm: 1500, load: 100, hexValue: "56" }, { rpm: 2000, load: 100, hexValue: "59" },
              { rpm: 2500, load: 100, hexValue: "5B" }, { rpm: 3000, load: 100, hexValue: "5D" }, { rpm: 3500, load: 100, hexValue: "5F" }, { rpm: 4000, load: 100, hexValue: "60" },
            ]
          },
          boost_pressure: {
            name: "Boost Pressure (mbar)",
            address: 0x1200, type: "16-bit unsigned", factor: 0.01, offset: 950,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000], load: [30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 1500, load: 30, hexValue: "05DC" }, { rpm: 2000, load: 30, hexValue: "0640" }, { rpm: 2500, load: 30, hexValue: "06A4" }, { rpm: 3000, load: 30, hexValue: "0708" },
              { rpm: 3500, load: 30, hexValue: "076C" }, { rpm: 4000, load: 30, hexValue: "07D0" }, { rpm: 4500, load: 30, hexValue: "0834" }, { rpm: 5000, load: 30, hexValue: "0898" },
              { rpm: 1500, load: 50, hexValue: "06A4" }, { rpm: 2000, load: 50, hexValue: "0708" }, { rpm: 2500, load: 50, hexValue: "076C" }, { rpm: 3000, load: 50, hexValue: "07D0" },
              { rpm: 3500, load: 50, hexValue: "0834" }, { rpm: 4000, load: 50, hexValue: "0898" }, { rpm: 4500, load: 50, hexValue: "08FC" }, { rpm: 5000, load: 50, hexValue: "0960" },
              { rpm: 1500, load: 70, hexValue: "07D0" }, { rpm: 2000, load: 70, hexValue: "0834" }, { rpm: 2500, load: 70, hexValue: "0898" }, { rpm: 3000, load: 70, hexValue: "08FC" },
              { rpm: 3500, load: 70, hexValue: "0960" }, { rpm: 4000, load: 70, hexValue: "09C4" }, { rpm: 4500, load: 70, hexValue: "0A28" }, { rpm: 5000, load: 70, hexValue: "0A8C" },
              { rpm: 1500, load: 90, hexValue: "08FC" }, { rpm: 2000, load: 90, hexValue: "0960" }, { rpm: 2500, load: 90, hexValue: "09C4" }, { rpm: 3000, load: 90, hexValue: "0A28" },
              { rpm: 3500, load: 90, hexValue: "0A8C" }, { rpm: 4000, load: 90, hexValue: "0AF0" }, { rpm: 4500, load: 90, hexValue: "0B54" }, { rpm: 5000, load: 90, hexValue: "0BB8" },
              { rpm: 1500, load: 100, hexValue: "0A28" }, { rpm: 2000, load: 100, hexValue: "0A8C" }, { rpm: 2500, load: 100, hexValue: "0AF0" }, { rpm: 3000, load: 100, hexValue: "0B54" },
              { rpm: 3500, load: 100, hexValue: "0BB8" }, { rpm: 4000, load: 100, hexValue: "0C1C" }, { rpm: 4500, load: 100, hexValue: "0C80" }, { rpm: 5000, load: 100, hexValue: "0CE4" },
            ]
          },
          rail_pressure: {
            name: "Rail Pressure (bar)",
            address: 0x1300, type: "16-bit unsigned", factor: 0.1, offset: 0,
            axes: { x: "RPM", y: "IQ (mg)" },
            axisValues: { rpm: [800, 1500, 2000, 2500, 3000, 3500, 4000], iq: [10, 20, 30, 40, 50, 60] },
            defaultData: [
              { rpm: 800, iq: 10, hexValue: "09C4" }, { rpm: 1500, iq: 10, hexValue: "0A28" }, { rpm: 2000, iq: 10, hexValue: "0AE8" }, { rpm: 2500, iq: 10, hexValue: "0B4C" },
              { rpm: 3000, iq: 10, hexValue: "0BB0" }, { rpm: 3500, iq: 10, hexValue: "0C14" }, { rpm: 4000, iq: 10, hexValue: "0C78" },
              { rpm: 800, iq: 20, hexValue: "0B14" }, { rpm: 1500, iq: 20, hexValue: "0B78" }, { rpm: 2000, iq: 20, hexValue: "0BE0" }, { rpm: 2500, iq: 20, hexValue: "0C44" },
              { rpm: 3000, iq: 20, hexValue: "0CA8" }, { rpm: 3500, iq: 20, hexValue: "0D0C" }, { rpm: 4000, iq: 20, hexValue: "0D70" },
              { rpm: 800, iq: 30, hexValue: "0CED" }, { rpm: 1500, iq: 30, hexValue: "0D58" }, { rpm: 2000, iq: 30, hexValue: "0DC0" }, { rpm: 2500, iq: 30, hexValue: "0E24" },
              { rpm: 3000, iq: 30, hexValue: "0E8C" }, { rpm: 3500, iq: 30, hexValue: "0EF0" }, { rpm: 4000, iq: 30, hexValue: "0F58" },
              { rpm: 800, iq: 40, hexValue: "0E8C" }, { rpm: 1500, iq: 40, hexValue: "0EF0" }, { rpm: 2000, iq: 40, hexValue: "0F58" }, { rpm: 2500, iq: 40, hexValue: "0FBC" },
              { rpm: 3000, iq: 40, hexValue: "1020" }, { rpm: 3500, iq: 40, hexValue: "1088" }, { rpm: 4000, iq: 40, hexValue: "10EC" },
              { rpm: 800, iq: 50, hexValue: "0FBC" }, { rpm: 1500, iq: 50, hexValue: "1020" }, { rpm: 2000, iq: 50, hexValue: "1088" }, { rpm: 2500, iq: 50, hexValue: "10EC" },
              { rpm: 3000, iq: 50, hexValue: "1154" }, { rpm: 3500, iq: 50, hexValue: "11B8" }, { rpm: 4000, iq: 50, hexValue: "1220" },
              { rpm: 800, iq: 60, hexValue: "10EC" }, { rpm: 1500, iq: 60, hexValue: "1154" }, { rpm: 2000, iq: 60, hexValue: "11B8" }, { rpm: 2500, iq: 60, hexValue: "1220" },
              { rpm: 3000, iq: 60, hexValue: "1284" }, { rpm: 3500, iq: 60, hexValue: "12EC" }, { rpm: 4000, iq: 60, hexValue: "1350" },
            ]
          },
          dtc_switch: {
            name: "DTC Switch",
            address: 0x3000, type: "8-bit raw", factor: 1, offset: 0,
            axes: { x: null, y: null },
            defaultData: [
                { id: "P0420 (CAT)", hexValue: "01" }, { id: "P0171 (Lean)", hexValue: "01" },
                { id: "P0300 (Misfire)", hexValue: "00" }, { id: "P0440 (EVAP)", hexValue: "01" },
                { id: "P0455 (EVAP Leak)", hexValue: "00" }, { id: "P0460 (Fuel Level)", hexValue: "01" },
                { id: "P0470 (Exhaust Press)", hexValue: "01" }, { id: "P0480 (Fan Control)", hexValue: "00" },
            ]
          },
          egr_map: {
            name: "EGR Control (duty cycle)",
            address: 0x1400, type: "8-bit unsigned", factor: 0.5, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500], load: [10, 20, 30, 40, 50] },
            defaultData: [
                { rpm: 800, load: 10, hexValue: "50" }, { rpm: 1000, load: 10, hexValue: "4A" }, { rpm: 1500, load: 10, hexValue: "40" }, { rpm: 2000, load: 10, hexValue: "30" }, { rpm: 2500, load: 10, hexValue: "20" },
                { rpm: 800, load: 20, hexValue: "55" }, { rpm: 1000, load: 20, hexValue: "50" }, { rpm: 1500, load: 20, hexValue: "45" }, { rpm: 2000, load: 20, hexValue: "35" }, { rpm: 2500, load: 20, hexValue: "25" },
                { rpm: 800, load: 30, hexValue: "60" }, { rpm: 1000, load: 30, hexValue: "55" }, { rpm: 1500, load: 30, hexValue: "50" }, { rpm: 2000, load: 30, hexValue: "40" }, { rpm: 2500, load: 30, hexValue: "30" },
                { rpm: 800, load: 40, hexValue: "65" }, { rpm: 1000, load: 40, hexValue: "60" }, { rpm: 1500, load: 40, hexValue: "55" }, { rpm: 2000, load: 40, hexValue: "45" }, { rpm: 2500, load: 40, hexValue: "35" },
                { rpm: 800, load: 50, hexValue: "6A" }, { rpm: 1000, load: 50, hexValue: "65" }, { rpm: 1500, load: 50, hexValue: "60" }, { rpm: 2000, load: 50, hexValue: "50" }, { rpm: 2500, load: 50, hexValue: "40" },
            ]
          }
        },
        "Mazda 2 Skyactiv-G (Petrol)": {
          ignition_timing: {
            name: "Ignition Timing (degrees BTDC)",
            address: 0x1000, type: "8-bit signed", factor: 0.5, offset: -30,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "30" }, { rpm: 1000, load: 10, hexValue: "35" }, { rpm: 1500, load: 10, hexValue: "3A" }, { rpm: 2000, load: 10, hexValue: "3D" },
              { rpm: 2500, load: 10, hexValue: "40" }, { rpm: 3000, load: 10, hexValue: "42" }, { rpm: 3500, load: 10, hexValue: "44" }, { rpm: 4000, load: 10, hexValue: "45" },
              { rpm: 800, load: 30, hexValue: "2A" }, { rpm: 1000, load: 30, hexValue: "2F" }, { rpm: 1500, load: 30, hexValue: "34" }, { rpm: 2000, load: 30, hexValue: "37" },
              { rpm: 2500, load: 30, hexValue: "3A" }, { rpm: 3000, load: 30, hexValue: "3C" }, { rpm: 3500, load: 30, hexValue: "3E" }, { rpm: 4000, load: 30, hexValue: "3F" },
              { rpm: 800, load: 50, hexValue: "20" }, { rpm: 1000, load: 50, hexValue: "25" }, { rpm: 1500, load: 50, hexValue: "2A" }, { rpm: 2000, load: 50, hexValue: "2D" },
              { rpm: 2500, load: 50, hexValue: "30" }, { rpm: 3000, load: 50, hexValue: "32" }, { rpm: 3500, load: 50, hexValue: "34" }, { rpm: 4000, load: 50, hexValue: "35" },
              { rpm: 800, load: 70, hexValue: "18" }, { rpm: 1000, load: 70, hexValue: "1D" }, { rpm: 1500, load: 70, hexValue: "22" }, { rpm: 2000, load: 70, hexValue: "25" },
              { rpm: 2500, load: 70, hexValue: "28" }, { rpm: 3000, load: 70, hexValue: "2A" }, { rpm: 3500, load: 70, hexValue: "2C" }, { rpm: 4000, load: 70, hexValue: "2D" },
              { rpm: 800, load: 90, hexValue: "10" }, { rpm: 1000, load: 90, hexValue: "15" }, { rpm: 1500, load: 90, hexValue: "1A" }, { rpm: 2000, load: 90, hexValue: "1D" },
              { rpm: 2500, load: 90, hexValue: "20" }, { rpm: 3000, load: 90, hexValue: "22" }, { rpm: 3500, load: 90, hexValue: "24" }, { rpm: 4000, load: 90, hexValue: "25" },
              { rpm: 800, load: 100, hexValue: "08" }, { rpm: 1000, load: 100, hexValue: "0D" }, { rpm: 1500, load: 100, hexValue: "12" }, { rpm: 2000, load: 100, hexValue: "15" },
              { rpm: 2500, load: 100, hexValue: "18" }, { rpm: 3000, load: 100, hexValue: "1A" }, { rpm: 3500, load: 100, hexValue: "1C" }, { rpm: 4000, load: 100, hexValue: "1D" },
            ]
          },
          fuel_map: {
            name: "Fuel Map (lambda)",
            address: 0x1100, type: "8-bit unsigned", factor: 0.01, offset: 0.5,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "64" }, { rpm: 1000, load: 10, hexValue: "66" }, { rpm: 1500, load: 10, hexValue: "68" }, { rpm: 2000, load: 10, hexValue: "6A" },
              { rpm: 2500, load: 10, hexValue: "6C" }, { rpm: 3000, load: 10, hexValue: "6E" }, { rpm: 3500, load: 10, hexValue: "70" }, { rpm: 4000, load: 10, hexValue: "71" },
              { rpm: 800, load: 30, hexValue: "6E" }, { rpm: 1000, load: 30, hexValue: "70" }, { rpm: 1500, load: 30, hexValue: "72" }, { rpm: 2000, load: 30, hexValue: "74" },
              { rpm: 2500, load: 30, hexValue: "76" }, { rpm: 3000, load: 30, hexValue: "78" }, { rpm: 3500, load: 30, hexValue: "7A" }, { rpm: 4000, load: 30, hexValue: "7B" },
              { rpm: 800, load: 50, hexValue: "78" }, { rpm: 1000, load: 50, hexValue: "7A" }, { rpm: 1500, load: 50, hexValue: "7C" }, { rpm: 2000, load: 50, hexValue: "7E" },
              { rpm: 2500, load: 50, hexValue: "80" }, { rpm: 3000, load: 50, hexValue: "82" }, { rpm: 3500, load: 50, hexValue: "84" }, { rpm: 4000, load: 50, hexValue: "85" },
              { rpm: 800, load: 70, hexValue: "82" }, { rpm: 1000, load: 70, hexValue: "84" }, { rpm: 1500, load: 70, hexValue: "86" }, { rpm: 2000, load: 70, hexValue: "88" },
              { rpm: 2500, load: 70, hexValue: "8A" }, { rpm: 3000, load: 70, hexValue: "8C" }, { rpm: 3500, load: 70, hexValue: "8E" }, { rpm: 4000, load: 70, hexValue: "8F" },
              { rpm: 800, load: 90, hexValue: "8C" }, { rpm: 1000, load: 90, hexValue: "8E" }, { rpm: 1500, load: 90, hexValue: "90" }, { rpm: 2000, load: 90, hexValue: "92" },
              { rpm: 2500, load: 90, hexValue: "94" }, { rpm: 3000, load: 90, hexValue: "96" }, { rpm: 3500, load: 90, hexValue: "98" }, { rpm: 4000, load: 90, hexValue: "99" },
              { rpm: 800, load: 100, hexValue: "90" }, { rpm: 1000, load: 100, hexValue: "92" }, { rpm: 1500, load: 100, hexValue: "94" }, { rpm: 2000, load: 100, hexValue: "96" },
              { rpm: 2500, load: 100, hexValue: "98" }, { rpm: 3000, load: 100, hexValue: "9A" }, { rpm: 3500, load: 100, hexValue: "9C" }, { rpm: 4000, load: 100, hexValue: "9D" },
            ]
          }
        },
        "Mazda 3 Skyactiv-G (Petrol)": {
            ignition_timing: {
                name: "Ignition Timing (degrees BTDC)",
                address: 0x1000, type: "8-bit signed", factor: 0.5, offset: -30,
                axes: { x: "RPM", y: "Load" },
                axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000], load: [10, 30, 50, 70, 90, 100] },
                defaultData: [ /* ... (more data points) */ ]
            },
            fuel_map: { /* ... */ },
            vvt_cam_angle: {
                name: "VVT Cam Angle (degrees)",
                address: 0x1200, type: "8-bit unsigned", factor: 0.1, offset: 0,
                axes: { x: "RPM", y: "Load" },
                axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000], load: [10, 30, 50, 70, 90, 100] },
                defaultData: [ /* ... (more data points) */ ]
            }
        },
        "Mazda BT-50 (Diesel)": {
            iq_limit: { /* ... */ },
            main_injection: { /* ... */ },
            boost_pressure: { /* ... */ },
            rail_pressure: { /* ... */ },
            egr_map: { /* ... */ },
            limiter_map: {
                name: "Speed Limiter (km/h)",
                address: 0x4000, type: "16-bit unsigned", factor: 1, offset: 0,
                axes: { x: null, y: null },
                defaultData: [ { id: "Speed Limit", hexValue: "00B4" } ] // 180 km/h
            }
        }
      },
      "Toyota": {
        "Toyota Hilux Revo (Diesel)": {
          iq_limit: { /* ... (similar to Mazda Diesel) */
            name: "IQ Limit (mg/stroke)",
            address: 0x1000, type: "8-bit unsigned", factor: 0.01, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [ /* ... (more data points) */ ]
          },
          main_injection: { /* ... */ },
          boost_pressure: { /* ... */ },
          rail_pressure: { /* ... */ },
          dpf_regeneration: {
            name: "DPF Regeneration Settings",
            address: 0x3000, type: "8-bit raw", factor: 1, offset: 0,
            axes: { x: null, y: null },
            defaultData: [
                { id: "Min Temp for Regen (C)", hexValue: "C8" }, // 200C
                { id: "Min Speed for Regen (km/h)", hexValue: "1E" }, // 30 km/h
                { id: "Regen Duration (min)", hexValue: "0A" }, // 10 min
                { id: "Soot Load Threshold (%)", hexValue: "32" }, // 50%
            ]
          }
        },
        "Toyota Fortuner (Diesel)": {
            iq_limit: { /* ... */ },
            main_injection: { /* ... */ },
            boost_pressure: { /* ... */ },
            rail_pressure: { /* ... */ },
            egr_map: { /* ... */ }
        },
        "Toyota Corolla Altis (Petrol)": {
            ignition_timing: { /* ... */ },
            fuel_map: { /* ... */ },
            throttle_response: {
                name: "Throttle Response (multiplier)",
                address: 0x1200, type: "8-bit unsigned", factor: 0.01, offset: 0.5,
                axes: { x: "RPM", y: "TPS" },
                axisValues: { rpm: [1000, 2000, 3000, 4000, 5000], tps: [10, 30, 50, 70, 90, 100] },
                defaultData: [ /* ... */ ]
            }
        },
        "Toyota Yaris (Petrol)": {
            ignition_timing: { /* ... */ },
            fuel_map: { /* ... */ },
            dtc_switch: { /* ... */ }
        }
      },
      "Honda": {
        "Honda Civic Turbo (Petrol)": {
          ignition_timing: { /* ... */
            name: "Ignition Timing (degrees BTDC)",
            address: 0x1000, type: "8-bit signed", factor: 0.5, offset: -30,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [1000, 2000, 3000, 4000, 5000, 6000, 7000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [ /* ... (more data points) */ ]
          },
          fuel_map: { /* ... */ },
          boost_control: {
            name: "Boost Control (kPa)",
            address: 0x1200, type: "16-bit unsigned", factor: 0.1, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [1000, 2000, 3000, 4000, 5000, 6000, 7000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [ /* ... */ ]
          },
          vtec_control: {
            name: "VTEC Engage RPM",
            address: 0x1300, type: "16-bit unsigned", factor: 1, offset: 0,
            axes: { x: null, y: null },
            defaultData: [ { id: "High Cam Engage RPM", hexValue: "0C80" } ] // 3200 RPM
          }
        },
        "Honda CR-V (Diesel)": {
            iq_limit: { /* ... */ },
            main_injection: { /* ... */ },
            boost_pressure: { /* ... */ },
            dtc_switch: { /* ... */ }
        },
        "Honda Jazz (Petrol)": {
            ignition_timing: { /* ... */ },
            fuel_map: { /* ... */ },
            gear_shift_light: {
                name: "Gear Shift Light RPM",
                address: 0x4000, type: "16-bit unsigned", factor: 1, offset: 0,
                axes: { x: null, y: null },
                defaultData: [ { id: "Shift Light RPM", hexValue: "1388" } ] // 5000 RPM
            }
        },
        "Honda City (Petrol)": {
            ignition_timing: { /* ... */ },
            fuel_map: { /* ... */ },
            throttle_response: { /* ... */ }
        }
      },
      "Isuzu": {
        "Isuzu D-Max Blue Power (Diesel)": {
          iq_limit: { /* ... */
            name: "IQ Limit (mg/stroke)",
            address: 0x1000, type: "8-bit unsigned", factor: 0.01, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [ /* ... (more data points) */ ]
          },
          main_injection: { /* ... */ },
          boost_pressure: { /* ... */ },
          rail_pressure: { /* ... */ },
          dpf_regeneration: { /* ... */ },
          gear_limiter: {
            name: "Gear Torque Limiter",
            address: 0x5000, type: "16-bit unsigned", factor: 1, offset: 0,
            axes: { x: "Gear", y: null }, // 1D map
            axisValues: { gear: [1, 2, 3, 4, 5, 6] },
            defaultData: [
                { gear: 1, hexValue: "01F4" }, // 500 Nm
                { gear: 2, hexValue: "0258" }, // 600 Nm
                { gear: 3, hexValue: "02BC" }, // 700 Nm
                { gear: 4, hexValue: "0320" }, // 800 Nm
                { gear: 5, hexValue: "0384" }, // 900 Nm
                { gear: 6, hexValue: "03E8" }, // 1000 Nm
            ]
          }
        },
        "Isuzu MU-X (Diesel)": {
            iq_limit: { /* ... */ },
            main_injection: { /* ... */ },
            boost_pressure: { /* ... */ },
            rail_pressure: { /* ... */ }
        }
      },
      "Ford": {
        "Ford Ranger (Diesel)": {
          iq_limit: { /* ... */ },
          main_injection: { /* ... */ },
          boost_pressure: { /* ... */ },
          rail_pressure: { /* ... */ },
          dtc_switch: { /* ... */ },
          egr_map: { /* ... */ }
        },
        "Ford Everest (Diesel)": {
          iq_limit: { /* ... */ },
          main_injection: { /* ... */ },
          boost_pressure: { /* ... */ },
          rail_pressure: { /* ... */ },
          dpf_regeneration: { /* ... */ }
        },
        "Ford Focus (Petrol)": {
          ignition_timing: { /* ... */ },
          fuel_map: { /* ... */ },
          throttle_response: { /* ... */ },
          turbo_wastegate: {
              name: "Turbo Wastegate Duty Cycle",
              address: 0x1400, type: "8-bit unsigned", factor: 0.5, offset: 0,
              axes: { x: "RPM", y: "Boost (kPa)" },
              axisValues: { rpm: [1500, 2000, 2500, 3000, 3500], boost: [50, 100, 150, 200, 250] },
              defaultData: [ /* ... */ ]
          }
        }
      },
      "Nissan": {
        "Nissan Navara (Diesel)": {
          iq_limit: { /* ... */ },
          main_injection: { /* ... */ },
          boost_pressure: { /* ... */ },
          rail_pressure: { /* ... */ },
          egr_map: { /* ... */ }
        },
        "Nissan Almera (Petrol)": {
          ignition_timing: { /* ... */ },
          fuel_map: { /* ... */ },
          idle_rpm: {
            name: "Idle RPM",
            address: 0x4000, type: "16-bit unsigned", factor: 1, offset: 0,
            axes: { x: null, y: null },
            defaultData: [ { id: "Idle RPM", hexValue: "02BC" } ] // 700 RPM
          }
        },
        "Nissan March (Petrol)": {
          ignition_timing: { /* ... */ },
          fuel_map: { /* ... */ }
        }
      },
      "BMW": {
        "BMW 320d (Diesel)": {
          iq_limit: { /* ... */ },
          main_injection: { /* ... */ },
          boost_pressure: { /* ... */ },
          rail_pressure: { /* ... */ },
          dtc_switch: { /* ... */ }
        },
        "BMW 320i (Petrol)": {
          ignition_timing: { /* ... */ },
          fuel_map: { /* ... */ },
          vanos_control: {
              name: "VANOS Cam Angle",
              address: 0x1400, type: "8-bit unsigned", factor: 0.1, offset: 0,
              axes: { x: "RPM", y: "Load" },
              axisValues: { rpm: [1000, 2000, 3000, 4000, 5000], load: [10, 30, 50, 70, 90, 100] },
              defaultData: [ /* ... */ ]
          }
        },
        "BMW X5 (Diesel)": {
            iq_limit: { /* ... */ },
            main_injection: { /* ... */ },
            boost_pressure: { /* ... */ },
            rail_pressure: { /* ... */ }
        }
      },
      "Mercedes-Benz": {
        "Mercedes-Benz C220d (Diesel)": {
          iq_limit: { /* ... */ },
          main_injection: { /* ... */ },
          boost_pressure: { /* ... */ },
          rail_pressure: { /* ... */ },
          egr_map: { /* ... */ }
        },
        "Mercedes-Benz C200 (Petrol)": {
          ignition_timing: { /* ... */ },
          fuel_map: { /* ... */ },
          throttle_response: { /* ... */ }
        },
        "Mercedes-Benz GLE (Diesel)": {
          iq_limit: { /* ... */ },
          main_injection: { /* ... */ },
          boost_pressure: { /* ... */ },
          rail_pressure: { /* ... */ }
        }
      }
    };

    // --- DOM Elements ---
    const carBrandSelect = document.getElementById("carBrand");
    const carModelSelect = document.getElementById("carModel");
    const mapTypeSelect = document.getElementById("mapType");
    const tuningTableHead = document.querySelector("#tuningTable thead tr"); // Added for dynamic headers
    const tuningTableBody = document.querySelector("#tuningTable tbody");
    const hexGrid = document.getElementById("hexGrid");
    const resultArea = document.getElementById("resultArea");
    const messageArea = document.getElementById("messageArea");
    const viewModeSelect = document.getElementById("viewMode");
    const graphCanvas = document.getElementById("graphCanvas");
    const graphCtx = graphCanvas.getContext('2d');
    let chartInstance;

    // --- Utility Functions ---
    function decToHex(d, padLength = 2) {
      let hex = Number(d).toString(16).toUpperCase();
      return hex.padStart(padLength, '0');
    }

    function hexToDec(h) {
      return parseInt(h, 16);
    }

    function showMessage(msg, isError = false) {
      messageArea.textContent = msg;
      messageArea.className = isError ? "error" : "";
      clearTimeout(messageArea.timer);
      messageArea.timer = setTimeout(() => {
        messageArea.textContent = '';
        messageArea.className = '';
      }, 5000);
    }

    // --- Core Logic ---

    // Populates car models based on selected brand
    function populateCarModels() {
        const selectedBrand = carBrandSelect.value;
        const modelsForBrand = ecuDefinitions[selectedBrand];
        carModelSelect.innerHTML = ''; // Clear existing options

        if (modelsForBrand) {
            for (const modelKey in modelsForBrand) {
                const option = document.createElement("option");
                option.value = modelKey.toLowerCase().replace(/[^a-z0-9]/g, '_'); // Sanitize value for consistency
                option.textContent = modelKey;
                carModelSelect.appendChild(option);
            }
        } else {
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "No models available";
            carModelSelect.appendChild(option);
        }
        // Always attempt to populate map options for the newly selected model
        populateMapOptions();
    }


    // Populates map options based on selected car model
    function populateMapOptions() {
        const selectedBrand = carBrandSelect.value;
        const selectedModelText = carModelSelect.options[carModelSelect.selectedIndex].textContent; // Get the actual text, not the sanitized value
        const mapsForModel = ecuDefinitions[selectedBrand]?.[selectedModelText]; // Use optional chaining for safety
        
        mapTypeSelect.innerHTML = ''; // Clear existing options

        let hasMaps = false;
        if (mapsForModel) {
            for (const mapKey in mapsForModel) {
                const option = document.createElement("option");
                option.value = mapKey; // Use mapKey (e.g., 'iq_limit')
                option.textContent = mapsForModel[mapKey].name; // Use friendly name
                mapTypeSelect.appendChild(option);
                hasMaps = true;
            }
        }
        
        if (!hasMaps) {
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "No maps available";
            mapTypeSelect.appendChild(option);
        }

        if (hasMaps && mapTypeSelect.value) {
            loadMapData();
        } else {
            tuningTableBody.innerHTML = '<tr><td colspan="3">No data available for this map.</td></tr>';
            hexGrid.innerHTML = '';
            currentMapData = null;
            currentMapDefinition = null;
            renderGraph();
        }
    }

    // Loads and displays the selected map data
    function loadMapData() {
        const selectedBrand = carBrandSelect.value;
        const selectedModelText = carModelSelect.options[carModelSelect.selectedIndex].textContent;
        const selectedMapType = mapTypeSelect.value;

        if (!selectedMapType || !ecuDefinitions[selectedBrand] || !ecuDefinitions[selectedBrand][selectedModelText] || !ecuDefinitions[selectedBrand][selectedModelText][selectedMapType]) {
            tuningTableBody.innerHTML = '<tr><td colspan="3">No data available for this map.</td></tr>';
            hexGrid.innerHTML = '';
            currentMapData = null;
            currentMapDefinition = null;
            renderGraph();
            return;
        }

        currentMapDefinition = ecuDefinitions[selectedBrand][selectedModelText][selectedMapType];
        currentMapData = JSON.parse(JSON.stringify(currentMapDefinition.defaultData));

        renderTuningTable();
        renderHexGrid();
        renderGraph();
        addToHistory();
    }

    // Renders the table view of the map
    function renderTuningTable() {
      tuningTableBody.innerHTML = '';

      // Dynamically update table headers
      tuningTableHead.innerHTML = '';
      if (currentMapDefinition && currentMapDefinition.axes && currentMapDefinition.axes.x) {
        tuningTableHead.innerHTML += `<th>${currentMapDefinition.axes.x}</th>`;
      } else if (currentMapDefinition && currentMapDefinition.name.includes("DTC Switch")) {
        tuningTableHead.innerHTML += `<th>DTC ID</th>`;
      } else {
         tuningTableHead.innerHTML += `<th>Axis X</th>`; // Generic fallback
      }

      if (currentMapDefinition && currentMapDefinition.axes && currentMapDefinition.axes.y) {
        tuningTableHead.innerHTML += `<th>${currentMapDefinition.axes.y}</th>`;
      } else {
        tuningTableHead.innerHTML += `<th>Axis Y</th>`; // Generic fallback
      }
      tuningTableHead.innerHTML += `<th>Value</th>`;

      if (!currentMapData || currentMapData.length === 0) {
          tuningTableBody.innerHTML = '<tr><td colspan="3">No map data to display.</td></tr>';
          return;
      }

      const isDTC = currentMapDefinition && currentMapDefinition.name.includes("DTC Switch");

      currentMapData.forEach((row, index) => {
        let displayValue;
        if (isDTC) {
            displayValue = row.hexValue === "01" ? "Enabled" : "Disabled";
        } else {
            if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
                displayValue = (hexToDec(row.hexValue) * currentMapDefinition.factor + currentMapDefinition.offset).toFixed(currentMapDefinition.factor < 1 ? 2 : 0);
            } else {
                displayValue = hexToDec(row.hexValue);
            }
        }

        const tr = document.createElement("tr");
        const axisXKey = currentMapDefinition?.axes?.x?.toLowerCase() || (isDTC ? 'id' : null);
        const axisYKey = currentMapDefinition?.axes?.y?.toLowerCase();

        const axisXValue = axisXKey ? (row[axisXKey] || '-') : '-';
        const axisYValue = axisYKey ? (row[axisYKey] || '-') : '-';

        tr.innerHTML = `
          <td>${axisXValue}</td>
          <td>${axisYValue}</td>
          <td>
            ${isDTC ? `
                <select class="map-value-input" data-index="${index}">
                    <option value="01" ${row.hexValue === "01" ? 'selected' : ''}>Enabled</option>
                    <option value="00" ${row.hexValue === "00" ? 'selected' : ''}>Disabled</option>
                </select>
            ` : `
                <input type="number" class="map-value-input" data-index="${index}" value="${displayValue}">
            `}
          </td>
        `;
        tuningTableBody.appendChild(tr);
      });

      document.querySelectorAll(".map-value-input").forEach(input => {
        input.addEventListener("change", updateFromMapTable);
      });
    }

    // Renders the HEX Viewer grid
    function renderHexGrid() {
      hexGrid.innerHTML = '';
      if (!currentMapData || currentMapData.length === 0) {
          hexGrid.innerHTML = 'No HEX data to display.';
          return;
      }

      let maxLength = 2;
      if (currentMapDefinition && currentMapDefinition.type === "16-bit unsigned") {
          maxLength = 4;
      }

      currentMapData.forEach((row, index) => {
        const input = document.createElement("input");
        input.type = "text";
        input.className = "hex";
        input.maxLength = maxLength;
        input.value = row.hexValue;
        input.setAttribute("data-index", index);
        input.addEventListener("input", updateFromHexGrid);
        hexGrid.appendChild(input);
      });
    }

    // Updates map data and HEX viewer from table input
    function updateFromMapTable(event) {
      const index = parseInt(event.target.dataset.index);
      let newValue = event.target.value;

      addToHistory();

      let hexEquivalent;
      if (currentMapDefinition && currentMapDefinition.name.includes("DTC Switch")) {
          hexEquivalent = newValue;
      } else {
          newValue = parseFloat(newValue);
          if (isNaN(newValue)) return;
          if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
              hexEquivalent = Math.round((newValue - currentMapDefinition.offset) / currentMapDefinition.factor);
              if (currentMapDefinition.type === "8-bit unsigned" || currentMapDefinition.type === "8-bit signed") {
                  hexEquivalent = Math.max(0, Math.min(hexEquivalent, 255));
              } else if (currentMapDefinition.type === "16-bit unsigned" || currentMapDefinition.type === "16-bit signed") {
                  hexEquivalent = Math.max(0, Math.min(hexEquivalent, 65535));
              }
          } else {
              hexEquivalent = Math.round(newValue);
          }
      }

      const hexString = decToHex(hexEquivalent, currentMapDefinition && currentMapDefinition.type.includes("16-bit") ? 4 : 2);
      currentMapData[index].hexValue = hexString;

      const hexInput = hexGrid.querySelector(`input[data-index="${index}"]`);
      if (hexInput) {
        hexInput.value = hexString;
      }
      renderGraph();
      resultArea.innerHTML = '';
    }

    // Updates map data and table from HEX viewer input
    function updateFromHexGrid(event) {
      const index = parseInt(event.target.dataset.index);
      let newHexValue = event.target.value.toUpperCase();

      const is8Bit = currentMapDefinition && (currentMapDefinition.type === "8-bit unsigned" || currentMapDefinition.type === "8-bit signed");
      const is16Bit = currentMapDefinition && (currentMapDefinition.type === "16-bit unsigned" || currentMapDefinition.type === "16-bit signed");

      if (!/^[0-9A-F]*$/.test(newHexValue) || (is8Bit && newHexValue.length > 2) || (is16Bit && newHexValue.length > 4)) {
        event.target.value = currentMapData[index].hexValue;
        showMessage("Invalid HEX input.", true);
        return;
      }

      if (is8Bit && newHexValue.length === 1) newHexValue = '0' + newHexValue;
      if (is16Bit && newHexValue.length < 4) newHexValue = newHexValue.padStart(4, '0');

      addToHistory();

      currentMapData[index].hexValue = newHexValue;

      const mapInput = tuningTableBody.querySelector(`[data-index="${index}"]`);
      if (mapInput) {
          if (currentMapDefinition && currentMapDefinition.name.includes("DTC Switch")) {
              mapInput.value = newHexValue;
          } else {
              if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
                  const actualValue = (hexToDec(newHexValue) * currentMapDefinition.factor + currentMapDefinition.offset).toFixed(currentMapDefinition.factor < 1 ? 2 : 0);
                  mapInput.value = actualValue;
              } else {
                  mapInput.value = hexToDec(newHexValue);
              }
          }
      }
      renderGraph();
      resultArea.innerHTML = '';
    }

    // --- Graphing (2D Simulation with Chart.js) ---
    function renderGraph() {
        const viewMode = viewModeSelect.value;
        if (chartInstance) {
            chartInstance.destroy();
        }

        const xAxisLabel = currentMapDefinition?.axes?.x;
        const yAxisLabel = currentMapDefinition?.axes?.y;

        // Check if map is suitable for 2D graph
        const isGraphable = currentMapDefinition && currentMapData && 
                             !currentMapDefinition.name.includes("DTC Switch") &&
                             (xAxisLabel || yAxisLabel); // Ensure at least one axis is defined

        if (viewMode === '2d' && isGraphable) {
            graphCanvas.style.display = 'block';
            
            let labels = [];
            let dataValues = [];

            // For 2D graphs, we typically want one primary axis (X) for labels
            // and the 'Value' as the Y-axis data.
            // If only Y-axis is defined, we'll use that for labels.
            // If neither is defined (like DTC), it's not graphable via this logic.

            if (xAxisLabel) {
                labels = currentMapData.map(d => d[xAxisLabel.toLowerCase()] || 'N/A');
            } else if (yAxisLabel) { // Fallback to Y-axis for labels if X-axis is not defined
                labels = currentMapData.map(d => d[yAxisLabel.toLowerCase()] || 'N/A');
            } else {
                labels = currentMapData.map((_, i) => `Point ${i + 1}`); // Generic fallback
            }
            
            dataValues = currentMapData.map(d => {
                if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
                    return (hexToDec(d.hexValue) * currentMapDefinition.factor + currentMapDefinition.offset);
                }
                return hexToDec(d.hexValue); // Fallback to raw decimal
            });

            chartInstance = new Chart(graphCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${currentMapDefinition.name} Values`,
                        data: dataValues,
                        borderColor: '#00bfff',
                        backgroundColor: 'rgba(0, 191, 255, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xAxisLabel || (yAxisLabel ? yAxisLabel : 'Index'), // Dynamic X-axis title
                                color: '#ccc'
                            },
                            ticks: { color: '#eee' },
                            grid: { color: '#555' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: currentMapDefinition.name, // Y-axis title is always the Map Name
                                color: '#ccc'
                            },
                            ticks: { color: '#eee' },
                            grid: { color: '#555' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#eee'
                            }
                        }
                    }
                }
            });
        } else {
            graphCanvas.style.display = 'none';
            if (viewMode === '3d') {
                showMessage("3D Graph visualization is highly complex and requires advanced libraries (e.g., Three.js) and data structures.", false);
            } else if (currentMapDefinition && currentMapDefinition.name.includes("DTC Switch")) {
                showMessage("2D Graph is not applicable for DTC Switch map.", false);
            } else if (currentMapDefinition && (!xAxisLabel && !yAxisLabel)) {
                 showMessage("This map does not have defined axes for 2D graph visualization.", false);
            }
        }
    }

    // --- File Operations Simulation ---
    function simulateFileLoad() {
        showMessage("Simulating ECU file load...", false);

        currentECUFile = Array(0x4000).fill('00'); // Simulate a 16KB ECU file filled with '00'
        
        // This part populates the simulated ECU file with *some* default data
        // from our predefined 'ecuDefinitions'. This is simplified.
        // In a real app, this would be actual parsing of the loaded binary file.
        for (const brandKey in ecuDefinitions) {
            for (const modelKey in ecuDefinitions[brandKey]) {
                for (const mapKey in ecuDefinitions[brandKey][modelKey]) {
                    const mapDef = ecuDefinitions[brandKey][modelKey][mapKey];
                    let currentAddress = mapDef.address;
                    mapDef.defaultData.forEach(item => {
                        let hexBytes = item.hexValue;
                        const byteLength = mapDef.type.includes("16-bit") ? 4 : 2;
                        hexBytes = hexBytes.padStart(byteLength, '0');

                        for (let i = 0; i < hexBytes.length; i += 2) {
                            if (currentAddress < currentECUFile.length) {
                                 currentECUFile[currentAddress++] = hexBytes.substring(i, i + 2);
                            }
                        }
                    });
                }
            }
        }

        populateCarModels(); // Start by populating models for the default brand
        showMessage("ECU file simulated load complete. Default map data loaded.", false);
    }

    function simulateFileSave() {
        if (!currentECUFile) {
            showMessage("No ECU file loaded to save.", true);
            return;
        }
        showMessage("Simulating saving of modified ECU file. This is where the file would be compiled and downloaded.");
    }

    // --- Tuning Functions ---

    function confirmTuning() {
      if (!currentMapData || !currentMapDefinition) {
          resultArea.innerHTML = "<p style='color: #ffaaaa;'>Please load a map first.</p>";
          return;
      }
      const map = mapTypeSelect.options[mapTypeSelect.selectedIndex].text;
      const mode = viewModeSelect.value;

      let originalTotalValue = 0;
      let modifiedTotalValue = 0;

      if (!currentMapDefinition.name.includes("DTC Switch")) {
          const originalMapDataDef = ecuDefinitions[carBrandSelect.value][carModelSelect.options[carModelSelect.selectedIndex].textContent][mapTypeSelect.value];
          if (originalMapDataDef && originalMapDataDef.defaultData) {
              originalMapDataDef.defaultData.forEach(item => {
                  originalTotalValue += hexToDec(item.hexValue);
              });
          }
          currentMapData.forEach(item => {
              modifiedTotalValue += hexToDec(item.hexValue);
          });
      }

      let hpChange = 0;
      let torqueChange = 0;
      let response = "Standard response.";

      const diffRatio = (originalTotalValue !== 0) ? (modifiedTotalValue - originalTotalValue) / originalTotalValue : 0;

      // More specific tuning responses based on map type
      if (mapTypeSelect.value.includes("iq_limit") || mapTypeSelect.value.includes("main_injection")) {
        hpChange = (diffRatio * 30).toFixed(1);
        torqueChange = (diffRatio * 40).toFixed(1);
        response = diffRatio > 0 ? "Significantly improved throttle response and power delivery. Expect more aggressive acceleration." : "Smoother power delivery for economy and comfort.";
      } else if (mapTypeSelect.value.includes("boost_pressure")) {
        hpChange = (diffRatio * 25).toFixed(1);
        torqueChange = (diffRatio * 35).toFixed(1);
        response = diffRatio > 0 ? "Stronger pull throughout the RPM range, especially in mid-range." : "Reduced turbo lag for better drivability.";
      } else if (mapTypeSelect.value.includes("rail_pressure")) {
        hpChange = (diffRatio * 20).toFixed(1);
        torqueChange = (diffRatio * 30).toFixed(1);
        response = diffRatio > 0 ? "Improved fuel atomization for more efficient combustion and power." : "Enhanced fuel economy and reduced emissions.";
      } else if (mapTypeSelect.value.includes("ignition_timing")) {
        hpChange = (diffRatio * 20).toFixed(1);
        torqueChange = (diffRatio * 25).toFixed(1);
        response = diffRatio > 0 ? "Optimized combustion for increased power and efficiency." : "Safer operation with reduced risk of knocking.";
      } else if (mapTypeSelect.value.includes("fuel_map")) {
        hpChange = (diffRatio * 15).toFixed(1);
        torqueChange = (diffRatio * 15).toFixed(1);
        response = diffRatio < 0 ? "Richer mixture for safety and power. Fuel economy may decrease." : "Leaner mixture for better fuel economy. Monitor engine health!";
      } else if (mapTypeSelect.value.includes("dtc_switch")) {
          const disabledDTCs = currentMapData.filter(d => d.hexValue === "00");
          if (disabledDTCs.length > 0) {
              response = `Warning: ${disabledDTCs.length} DTCs (${disabledDTCs.map(d => d.id).join(', ')}) are currently disabled. Use with caution! This is for off-road use only.`;
              resultArea.style.color = '#ffaa00';
          } else {
              response = "All DTCs are enabled as per standard. No issues detected.";
              resultArea.style.color = '#aaffaa';
          }
          hpChange = "N/A";
          torqueChange = "N/A";
      } else {
          hpChange = (diffRatio * 10).toFixed(1);
          torqueChange = (diffRatio * 10).toFixed(1);
          response = "General performance adjustment.";
      }

      resultArea.innerHTML = `
        <p>‚úÖ Tuning of "${map}" in "${mode}" view mode completed!</p>
        <p>Initial Results: Horsepower change ~${hpChange} HP, Torque change ~${torqueChange} %, ${response}</p>
        <p><em>(‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏π‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏ï‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)</em></p>
      `;
      resultArea.style.color = '#aaffaa';
    }

    function compareMaps() {
        if (!currentMapData || history.length < 2 || !currentMapDefinition) {
            showMessage("Load a map and make changes to compare.", true);
            return;
        }

        const originalMapState = history[0];
        let changes = 0;
        let comparisonDetails = 'Changes detected:<br>';

        currentMapData.forEach((modifiedItem, index) => {
            const originalItem = originalMapState.currentMapData[index];
            if (originalItem && modifiedItem.hexValue !== originalItem.hexValue) {
                changes++;
                const axisXKey = currentMapDefinition?.axes?.x?.toLowerCase();
                const axisYKey = currentMapDefinition?.axes?.y?.toLowerCase();
                
                let label = '';
                if (axisXKey) label += `${axisXKey.toUpperCase()}: ${modifiedItem[axisXKey]} `;
                if (axisYKey) label += `${axisYKey.toUpperCase()}: ${modifiedItem[axisYKey]} `;
                if (modifiedItem.id) label = `ID: ${modifiedItem.id}`; // For DTC or other ID-based maps

                comparisonDetails += `Row ${index + 1} (${label.trim() || 'N/A'}): Original HEX: ${originalItem.hexValue}, Modified HEX: ${modifiedItem.hexValue}<br>`;
            }
        });

        if (changes === 0) {
            showMessage("No changes detected between current map and original state.", false);
        } else {
            resultArea.innerHTML = `
                <p>üìä Map Comparison Complete: Found ${changes} differences.</p>
                <p>${comparisonDetails}</p>
            `;
            resultArea.style.color = '#ffffaa';
        }
    }

    function calculateChecksum() {
        if (!currentECUFile) {
            showMessage("No ECU file loaded to calculate checksum. Load a file first.", true);
            return;
        }

        let sum = 0;
        currentECUFile.forEach(hexByte => {
            sum += hexToDec(hexByte);
        });

        const simulatedChecksum = decToHex(sum % 65536, 4);

        resultArea.innerHTML = `
            <p>‚ûï Simulated Checksum Calculation Complete.</p>
            <p>Calculated Checksum: <strong>0x${simulatedChecksum}</strong></p>
            <p><em>(‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Checksum ‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏Å‡∏±‡∏ö ECU ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)</em></p>
        `;
        resultArea.style.color = '#aaffaa';
    }

    // --- Undo/Redo Functionality ---
    function addToHistory() {
        if (!currentMapData || !currentMapDefinition) return;

        if (historyPointer < history.length - 1) {
            history = history.slice(0, historyPointer + 1);
        }
        history.push({
            currentMapData: JSON.parse(JSON.stringify(currentMapData)),
            currentMapDefinition: JSON.parse(JSON.stringify(currentMapDefinition))
        });
        historyPointer++;
    }

    function undoLastChange() {
        if (historyPointer > 0) {
            historyPointer--;
            const prevState = history[historyPointer];
            currentMapData = JSON.parse(JSON.stringify(prevState.currentMapData));
            currentMapDefinition = JSON.parse(JSON.stringify(prevState.currentMapDefinition));
            
            // Re-select map type in dropdown to match history state
            if (prevState.currentMapDefinition && mapTypeSelect.value !== prevState.currentMapDefinition.mapKey) { // Check if value is different
                mapTypeSelect.value = mapTypeSelect.querySelector(`option[textContent="${prevState.currentMapDefinition.name}"]`)?.value || prevState.currentMapDefinition.mapKey; // Try to match by text or use mapKey directly
            }

            renderTuningTable();
            renderHexGrid();
            renderGraph();
            showMessage("Undo successful.", false);
        } else {
            showMessage("No more changes to undo.", true);
        }
    }

    // --- Event Listeners and Initial Load ---
    document.addEventListener("DOMContentLoaded", () => {
      carBrandSelect.addEventListener("change", populateCarModels);
      carModelSelect.addEventListener("change", populateMapOptions); // Populate maps when model changes
      mapTypeSelect.addEventListener("change", loadMapData);
      viewModeSelect.addEventListener("change", renderGraph);
      
      simulateFileLoad(); // Initial load when the page is ready
    });

    // Initial population for models and maps based on default selected brand/model
    // This will be called by simulateFileLoad() on DOMContentLoaded
  </script>

</body>
</html>
