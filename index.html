<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WinOLS ECU Tuning Simulator (Advanced)</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2a3a, #2d3b4d); /* Enhanced dark gradient */
      color: #eee;
      padding: 20px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      width: 100%;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      width: 100%;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      border: 1px solid #2a6496;
    }

    h1 {
      color: #00bfff;
      margin: 0;
      font-size: 2.5rem;
      text-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    h1 .icon {
      font-size: 2rem;
    }

    .subtitle {
      color: #7fdbff;
      margin-top: 5px;
      font-size: 1.1rem;
    }

    .section {
      background: rgba(30, 40, 50, 0.8);
      padding: 25px;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      width: 100%;
      border: 1px solid #3a506b;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .section:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    .section h3 {
      color: #00bfff;
      margin-top: 0;
      padding-bottom: 15px;
      border-bottom: 1px solid #3a506b;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.4rem;
    }

    .section h3 .icon {
      font-size: 1.2rem;
    }

    label {
      margin-right: 10px;
      color: #aaccff;
      white-space: nowrap;
      font-weight: 500;
    }

    select, input[type=number], input.hex, button, input[type=file] {
      background: rgba(50, 60, 80, 0.8);
      color: #eee;
      border: 1px solid #4a6380;
      padding: 10px 15px;
      margin: 8px 15px 8px 0;
      border-radius: 6px;
      font-size: 1.05em;
      transition: all 0.3s ease;
    }

    select:focus, input:focus, button:focus, input[type=file]:focus {
      outline: none;
      border-color: #00bfff;
      box-shadow: 0 0 10px rgba(0, 191, 255, 0.7);
      background: rgba(60, 80, 100, 0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(40, 50, 65, 0.7);
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #4a6380;
      padding: 12px;
      color: #eee;
      text-align: center;
    }

    th {
      background: rgba(30, 70, 100, 0.7);
      color: #7fdbff;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background: rgba(45, 55, 70, 0.5);
    }

    tr:hover {
      background: rgba(60, 80, 110, 0.6);
    }

    input.map-value-input {
      width: 100%;
      max-width: 120px;
      text-align: center;
      background: rgba(60, 70, 90, 0.8);
    }

    .hex-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 12px;
      margin-top: 20px;
      padding: 15px;
      background: rgba(40, 50, 65, 0.7);
      border-radius: 6px;
      border: 1px solid #4a6380;
    }

    input.hex {
      width: 100%;
      box-sizing: border-box;
      text-transform: uppercase;
      font-family: 'Consolas', 'Monaco', monospace;
      text-align: center;
      padding: 10px;
    }

    button {
      background: linear-gradient(to right, #0062cc, #00bfff);
      color: white;
      border: none;
      padding: 14px 30px;
      cursor: pointer;
      font-size: 1.1em;
      transition: all 0.3s ease;
      margin-top: 15px;
      border-radius: 50px;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0, 110, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: linear-gradient(to right, #0050a0, #009acd);
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 110, 255, 0.5);
    }

    button:active {
      transform: translateY(1px);
    }

    #resultArea, #messageArea {
      margin-top: 25px;
      padding: 20px;
      background: rgba(40, 50, 65, 0.8);
      border-radius: 8px;
      text-align: center;
      font-size: 1.1em;
      border: 1px solid #00bfff;
      box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
    }
    
    #resultArea {
      color: #aaffaa;
    }
    
    #messageArea {
      color: #aaccff;
    }
    
    #messageArea.error {
      color: #ffaaaa;
      border-color: #ff5555;
      box-shadow: 0 0 15px rgba(255, 85, 85, 0.3);
    }

    .button-group {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 25px;
    }

    /* --- ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏á‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ --- */
    #graphCanvas {
      width: 100%;
      max-width: 500px; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏≠‡∏µ‡∏Å */
      height: 250px;    /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏≠‡∏µ‡∏Å */
      background: rgba(30, 40, 50, 0.7);
      border: 1px solid #4a6380;
      border-radius: 8px;
      margin-top: 20px;
      box-sizing: border-box;
      align-self: center; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ô Flex container */
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
      padding: 12px;
      background: rgba(40, 60, 80, 0.6);
      border-radius: 8px;
      border: 1px solid #4a6380;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-active {
      background: #00ff00;
      box-shadow: 0 0 8px #00ff00;
    }
    
    .status-inactive {
      background: #ff5555;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .section {
        padding: 20px;
      }
      
      .button-group {
        flex-direction: column;
        align-items: center;
      }
      
      button {
        width: 100%;
        max-width: 300px;
      }
      
      .file-info {
        flex-direction: column;
        align-items: flex-start;
      }
      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
      #graphCanvas {
        height: 200px; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        max-width: 100%; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.8rem;
      }
      
      select, input[type=number], input.hex, button, input[type=file] {
        width: 100%;
        margin: 8px 0;
      }
      
      .hex-grid {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      }
      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏∏‡∏î */
      #graphCanvas {
        height: 150px; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1><span class="icon">üîß</span> WinOLS ECU Tuning Simulator (Advanced)</h1>
      <div class="subtitle">Professional-grade ECU remapping simulation for performance tuning</div>
    </header>

    <div class="section">
      <h3><span class="icon">üìÇ</span> File Operations</h3>
      <div>
        <label for="fileInput">Load ECU File (.bin/.hex):</label>
        <input type="file" id="fileInput" accept=".bin, .hex" disabled>
        <button onclick="simulateFileLoad()">Simulate Load</button>
        <button onclick="simulateFileSave()">Simulate Save</button>
      </div>
      <div id="messageArea"></div>
      <div class="file-info">
        <div><span class="status-indicator status-inactive"></span> ECU File: <span id="fileStatus">Not loaded</span></div>
        <div><span class="status-indicator status-inactive"></span> Current Map: <span id="mapStatus">None selected</span></div>
      </div>
    </div>

    <div class="section">
      <h3><span class="icon">‚öôÔ∏è</span> Vehicle & Model Selection</h3>
      <div>
        <label for="carBrand">Brand:</label>
        <select id="carBrand">
          <option value="Mazda">Mazda</option>
          <option value="Toyota">Toyota</option>
          <option value="Honda">Honda</option>
          <option value="Isuzu">Isuzu</option>
          <option value="Ford">Ford</option>
          <option value="Nissan">Nissan</option>
          <option value="BMW">BMW</option>
          <option value="Mercedes-Benz">Mercedes-Benz</option>
        </select>

        <label for="carModel">Model:</label>
        <select id="carModel"></select>
      </div>
    </div>

    <div class="section">
      <h3><span class="icon">üó∫Ô∏è</span> Map Selection & View Mode</h3>
      <div>
        <label for="mapType">Select Map for Tuning:</label>
        <select id="mapType"></select>
      </div>
      <div style="margin-top: 20px;">
        <label for="viewMode">Display Mode:</label>
        <select id="viewMode">
          <option value="text">Text</option>
          <option value="2d">2D Graph</option>
          <option value="3d">3D Graph (Simulated)</option>
        </select>
      </div>
      <canvas id="graphCanvas" style="display: none;"></canvas>
    </div>

    <div class="section">
      <h3><span class="icon">üìà</span> Map Tuning Area</h3>
      <div style="overflow-x: auto;">
        <table id="tuningTable">
          <thead>
            <tr><th>Axis X</th><th>Axis Y</th><th>Value</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h3><span class="icon">üî¢</span> HEX Viewer</h3>
      <div class="hex-grid" id="hexGrid"></div>
    </div>

    <div class="section">
      <div class="button-group">
        <button onclick="confirmTuning()"><span>‚úÖ</span> Confirm Tuning</button>
        <button onclick="compareMaps()"><span>üìä</span> Compare Maps</button>
        <button onclick="calculateChecksum()"><span>‚ûï</span> Calc Checksum</button>
        <button onclick="undoLastChange()"><span>‚Ü©Ô∏è</span> Undo</button>
        <button onclick="redoChange()"><span>‚Ü™Ô∏è</span> Redo</button>
      </div>
      <div id="resultArea"></div>
    </div>
  </div>

  <script>
    // --- Global State ---
    let currentECUFile = null;
    let currentMapData = null;
    let currentMapDefinition = null;
    let history = [];
    let historyPointer = -1;

    // --- Data Definitions ---
    const ecuDefinitions = {
      "Mazda": {
        "Mazda 2 Skyactiv-D (Diesel)": {
          iq_limit: {
            name: "IQ Limit (mg/stroke)",
            address: 0x1000, type: "8-bit unsigned", factor: 0.01, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "20" }, { rpm: 1000, load: 10, hexValue: "25" }, { rpm: 1500, load: 10, hexValue: "2A" }, { rpm: 2000, load: 10, hexValue: "2D" },
              { rpm: 2500, load: 10, hexValue: "30" }, { rpm: 3000, load: 10, hexValue: "32" }, { rpm: 3500, load: 10, hexValue: "34" }, { rpm: 4000, load: 10, hexValue: "35" },
              { rpm: 800, load: 30, hexValue: "30" }, { rpm: 1000, load: 30, hexValue: "35" }, { rpm: 1500, load: 30, hexValue: "3A" }, { rpm: 2000, load: 30, hexValue: "3D" },
              { rpm: 2500, load: 30, hexValue: "40" }, { rpm: 3000, load: 30, hexValue: "42" }, { rpm: 3500, load: 30, hexValue: "44" }, { rpm: 4000, load: 30, hexValue: "45" },
              { rpm: 800, load: 50, hexValue: "40" }, { rpm: 1000, load: 50, hexValue: "45" }, { rpm: 1500, load: 50, hexValue: "4A" }, { rpm: 2000, load: 50, hexValue: "4D" },
              { rpm: 2500, load: 50, hexValue: "50" }, { rpm: 3000, load: 50, hexValue: "52" }, { rpm: 3500, load: 50, hexValue: "54" }, { rpm: 4000, load: 50, hexValue: "55" },
              { rpm: 800, load: 70, hexValue: "50" }, { rpm: 1000, load: 70, hexValue: "55" }, { rpm: 1500, load: 70, hexValue: "5A" }, { rpm: 2000, load: 70, hexValue: "5D" },
              { rpm: 2500, load: 70, hexValue: "60" }, { rpm: 3000, load: 70, hexValue: "62" }, { rpm: 3500, load: 70, hexValue: "64" }, { rpm: 4000, load: 70, hexValue: "65" },
              { rpm: 800, load: 90, hexValue: "60" }, { rpm: 1000, load: 90, hexValue: "65" }, { rpm: 1500, load: 90, hexValue: "6A" }, { rpm: 2000, load: 90, hexValue: "6D" },
              { rpm: 2500, load: 90, hexValue: "70" }, { rpm: 3000, load: 90, hexValue: "72" }, { rpm: 3500, load: 90, hexValue: "74" }, { rpm: 4000, load: 90, hexValue: "75" },
              { rpm: 800, load: 100, hexValue: "68" }, { rpm: 1000, load: 100, hexValue: "6D" }, { rpm: 1500, load: 100, hexValue: "72" }, { rpm: 2000, load: 100, hexValue: "75" },
              { rpm: 2500, load: 100, hexValue: "78" }, { rpm: 3000, load: 100, hexValue: "7A" }, { rpm: 3500, load: 100, hexValue: "7C" }, { rpm: 4000, load: 100, hexValue: "7D" },
            ]
          },
          main_injection: {
            name: "Main Injection Quantity (mg/stroke)",
            address: 0x1100, type: "8-bit unsigned", factor: 0.02, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "1A" }, { rpm: 1000, load: 10, hexValue: "1C" }, { rpm: 1500, load: 10, hexValue: "1E" }, { rpm: 2000, load: 10, hexValue: "20" },
              { rpm: 2500, load: 10, hexValue: "22" }, { rpm: 3000, load: 10, hexValue: "24" }, { rpm: 3500, load: 10, hexValue: "26" }, { rpm: 4000, load: 10, hexValue: "27" },
              { rpm: 800, load: 30, hexValue: "25" }, { rpm: 1000, load: 30, hexValue: "28" }, { rpm: 1500, load: 30, hexValue: "2B" }, { rpm: 2000, load: 30, hexValue: "2E" },
              { rpm: 2500, load: 30, hexValue: "30" }, { rpm: 3000, load: 30, hexValue: "32" }, { rpm: 3500, load: 30, hexValue: "34" }, { rpm: 4000, load: 30, hexValue: "35" },
              { rpm: 800, load: 50, hexValue: "30" }, { rpm: 1000, load: 50, hexValue: "33" }, { rpm: 1500, load: 50, hexValue: "36" }, { rpm: 2000, load: 50, hexValue: "39" },
              { rpm: 2500, load: 50, hexValue: "3B" }, { rpm: 3000, load: 50, hexValue: "3D" }, { rpm: 3500, load: 50, hexValue: "3F" }, { rpm: 4000, load: 50, hexValue: "40" },
              { rpm: 800, load: 70, hexValue: "3B" }, { rpm: 1000, load: 70, hexValue: "3E" }, { rpm: 1500, load: 70, hexValue: "41" }, { rpm: 2000, load: 70, hexValue: "44" },
              { rpm: 2500, load: 70, hexValue: "46" }, { rpm: 3000, load: 70, hexValue: "48" }, { rpm: 3500, load: 70, hexValue: "4A" }, { rpm: 4000, load: 70, hexValue: "4B" },
              { rpm: 800, load: 90, hexValue: "48" }, { rpm: 1000, load: 90, hexValue: "4B" }, { rpm: 1500, load: 90, hexValue: "4E" }, { rpm: 2000, load: 90, hexValue: "51" },
              { rpm: 2500, load: 90, hexValue: "53" }, { rpm: 3000, load: 90, hexValue: "55" }, { rpm: 3500, load: 90, hexValue: "57" }, { rpm: 4000, load: 90, hexValue: "58" },
              { rpm: 800, load: 100, hexValue: "50" }, { rpm: 1000, load: 100, hexValue: "53" }, { rpm: 1500, load: 100, hexValue: "56" }, { rpm: 2000, load: 100, hexValue: "59" },
              { rpm: 2500, load: 100, hexValue: "5B" }, { rpm: 3000, load: 100, hexValue: "5D" }, { rpm: 3500, load: 100, hexValue: "5F" }, { rpm: 4000, load: 100, hexValue: "60" },
            ]
          },
          boost_pressure: {
            name: "Boost Pressure (mbar)",
            address: 0x1200, type: "16-bit unsigned", factor: 0.01, offset: 950,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000], load: [30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 1500, load: 30, hexValue: "05DC" }, { rpm: 2000, load: 30, hexValue: "0640" }, { rpm: 2500, load: 30, hexValue: "06A4" }, { rpm: 3000, load: 30, hexValue: "0708" },
              { rpm: 3500, load: 30, hexValue: "076C" }, { rpm: 4000, load: 30, hexValue: "07D0" }, { rpm: 4500, load: 30, hexValue: "0834" }, { rpm: 5000, load: 30, hexValue: "0898" },
              { rpm: 1500, load: 50, hexValue: "06A4" }, { rpm: 2000, load: 50, hexValue: "0708" }, { rpm: 2500, load: 50, hexValue: "076C" }, { rpm: 3000, load: 50, hexValue: "07D0" },
              { rpm: 3500, load: 50, hexValue: "0834" }, { rpm: 4000, load: 50, hexValue: "0898" }, { rpm: 4500, load: 50, hexValue: "08FC" }, { rpm: 5000, load: 50, hexValue: "0960" },
              { rpm: 1500, load: 70, hexValue: "07D0" }, { rpm: 2000, load: 70, hexValue: "0834" }, { rpm: 2500, load: 70, hexValue: "0898" }, { rpm: 3000, load: 70, hexValue: "08FC" },
              { rpm: 3500, load: 70, hexValue: "0960" }, { rpm: 4000, load: 70, hexValue: "09C4" }, { rpm: 4500, load: 70, hexValue: "0A28" }, { rpm: 5000, load: 70, hexValue: "0A8C" },
              { rpm: 1500, load: 90, hexValue: "08FC" }, { rpm: 2000, load: 90, hexValue: "0960" }, { rpm: 2500, load: 90, hexValue: "09C4" }, { rpm: 3000, load: 90, hexValue: "0A28" },
              { rpm: 3500, load: 90, hexValue: "0A8C" }, { rpm: 4000, load: 90, hexValue: "0AF0" }, { rpm: 4500, load: 90, hexValue: "0B54" }, { rpm: 5000, load: 90, hexValue: "0BB8" },
              { rpm: 1500, load: 100, hexValue: "0A28" }, { rpm: 2000, load: 100, hexValue: "0A8C" }, { rpm: 2500, load: 100, hexValue: "0AF0" }, { rpm: 3000, load: 100, hexValue: "0B54" },
              { rpm: 3500, load: 100, hexValue: "0BB8" }, { rpm: 4000, load: 100, hexValue: "0C1C" }, { rpm: 4500, load: 100, hexValue: "0C80" }, { rpm: 5000, load: 100, hexValue: "0CE4" },
            ]
          },
          dtc_switch: {
            name: "DTC Switch (Diagnostic Trouble Code)",
            address: 0x2000, type: "8-bit unsigned", factor: 1, offset: 0, // Special handling for display
            axes: { x: "DTC Code", y: "Status" }, // Dummy axes for display
            axisValues: { dtc_code: ["P0001", "P0002", "P0003", "P0004", "P0005"], status: ["Enabled/Disabled"] },
            defaultData: [
                { dtc_code: "P0001", hexValue: "01" }, // Enabled
                { dtc_code: "P0002", hexValue: "01" }, // Enabled
                { dtc_code: "P0003", hexValue: "00" }, // Disabled
                { dtc_code: "P0004", hexValue: "01" }, // Enabled
                { dtc_code: "P0005", hexValue: "00" }  // Disabled
            ]
          }
        },
        "Mazda 2 Skyactiv-G (Petrol)": {
          ignition_timing: {
            name: "Ignition Timing (degrees BTDC)",
            address: 0x1000, type: "8-bit signed", factor: 0.5, offset: -30,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "30" }, { rpm: 1000, load: 10, hexValue: "35" }, { rpm: 1500, load: 10, hexValue: "3A" }, { rpm: 2000, load: 10, hexValue: "3D" },
              { rpm: 2500, load: 10, hexValue: "40" }, { rpm: 3000, load: 10, hexValue: "42" }, { rpm: 3500, load: 10, hexValue: "44" }, { rpm: 4000, load: 10, hexValue: "45" },
              { rpm: 800, load: 30, hexValue: "2A" }, { rpm: 1000, load: 30, hexValue: "2F" }, { rpm: 1500, load: 30, hexValue: "34" }, { rpm: 2000, load: 30, hexValue: "37" },
              { rpm: 2500, load: 30, hexValue: "3A" }, { rpm: 3000, load: 30, hexValue: "3C" }, { rpm: 3500, load: 30, hexValue: "3E" }, { rpm: 4000, load: 30, hexValue: "3F" },
              { rpm: 800, load: 50, hexValue: "20" }, { rpm: 1000, load: 50, hexValue: "25" }, { rpm: 1500, load: 50, hexValue: "2A" }, { rpm: 2000, load: 50, hexValue: "2D" },
              { rpm: 2500, load: 50, hexValue: "30" }, { rpm: 3000, load: 50, hexValue: "32" }, { rpm: 3500, load: 50, hexValue: "34" }, { rpm: 4000, load: 50, hexValue: "35" },
              { rpm: 800, load: 70, hexValue: "18" }, { rpm: 1000, load: 70, hexValue: "1D" }, { rpm: 1500, load: 70, hexValue: "22" }, { rpm: 2000, load: 70, hexValue: "25" },
              { rpm: 2500, load: 70, hexValue: "28" }, { rpm: 3000, load: 70, hexValue: "2A" }, { rpm: 3500, load: 70, hexValue: "2C" }, { rpm: 4000, load: 70, hexValue: "2D" },
              { rpm: 800, load: 90, hexValue: "10" }, { rpm: 1000, load: 90, hexValue: "15" }, { rpm: 1500, load: 90, hexValue: "1A" }, { rpm: 2000, load: 90, hexValue: "1D" },
              { rpm: 2500, load: 90, hexValue: "20" }, { rpm: 3000, load: 90, hexValue: "22" }, { rpm: 3500, load: 90, hexValue: "24" }, { rpm: 4000, load: 90, hexValue: "25" },
              { rpm: 800, load: 100, hexValue: "08" }, { rpm: 1000, load: 100, hexValue: "0D" }, { rpm: 1500, load: 100, hexValue: "12" }, { rpm: 2000, load: 100, hexValue: "15" },
              { rpm: 2500, load: 100, hexValue: "18" }, { rpm: 3000, load: 100, hexValue: "1A" }, { rpm: 3500, load: 100, hexValue: "1C" }, { rpm: 4000, load: 100, hexValue: "1D" },
            ]
          }
        }
      },
      "Toyota": {
        "Toyota Hilux Revo (Diesel)": {
          iq_limit: {
            name: "IQ Limit (mg/stroke)",
            address: 0x1000, type: "8-bit unsigned", factor: 0.01, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
            defaultData: [
              { rpm: 800, load: 10, hexValue: "20" }, { rpm: 1000, load: 10, hexValue: "25" }, { rpm: 1500, load: 10, hexValue: "2A" }, { rpm: 2000, load: 10, hexValue: "2D" },
              { rpm: 2500, load: 10, hexValue: "30" }, { rpm: 3000, load: 10, hexValue: "32" }, { rpm: 3500, load: 10, hexValue: "34" }, { rpm: 4000, load: 10, hexValue: "35" },
              { rpm: 800, load: 30, hexValue: "30" }, { rpm: 1000, load: 30, hexValue: "35" }, { rpm: 1500, load: 30, hexValue: "3A" }, { rpm: 2000, load: 30, hexValue: "3D" },
              { rpm: 2500, load: 30, hexValue: "40" }, { rpm: 3000, load: 30, hexValue: "42" }, { rpm: 3500, load: 30, hexValue: "44" }, { rpm: 4000, load: 30, hexValue: "45" },
              { rpm: 800, load: 50, hexValue: "40" }, { rpm: 1000, load: 50, hexValue: "45" }, { rpm: 1500, load: 50, hexValue: "4A" }, { rpm: 2000, load: 50, hexValue: "4D" },
              { rpm: 2500, load: 50, hexValue: "50" }, { rpm: 3000, load: 50, hexValue: "52" }, { rpm: 3500, load: 50, hexValue: "54" }, { rpm: 4000, load: 50, hexValue: "55" },
              { rpm: 800, load: 70, hexValue: "50" }, { rpm: 1000, load: 70, hexValue: "55" }, { rpm: 1500, load: 70, hexValue: "5A" }, { rpm: 2000, load: 70, hexValue: "5D" },
              { rpm: 2500, load: 70, hexValue: "60" }, { rpm: 3000, load: 70, hexValue: "62" }, { rpm: 3500, load: 70, hexValue: "64" }, { rpm: 4000, load: 70, hexValue: "65" },
              { rpm: 800, load: 90, hexValue: "60" }, { rpm: 1000, load: 90, hexValue: "65" }, { rpm: 1500, load: 90, hexValue: "6A" }, { rpm: 2000, load: 90, hexValue: "6D" },
              { rpm: 2500, load: 90, hexValue: "70" }, { rpm: 3000, load: 90, hexValue: "72" }, { rpm: 3500, load: 90, hexValue: "74" }, { rpm: 4000, load: 90, hexValue: "75" },
              { rpm: 800, load: 100, hexValue: "68" }, { rpm: 1000, load: 100, hexValue: "6D" }, { rpm: 1500, load: 100, hexValue: "72" }, { rpm: 2000, load: 100, hexValue: "75" },
              { rpm: 2500, load: 100, hexValue: "78" }, { rpm: 3000, load: 100, hexValue: "7A" }, { rpm: 3500, load: 100, hexValue: "7C" }, { rpm: 4000, load: 100, hexValue: "7D" },
            ]
          }
        },
        "Toyota Corolla Altis (Petrol)": {
            ignition_timing: {
                name: "Ignition Timing (degrees BTDC)",
                address: 0x1000, type: "8-bit signed", factor: 0.5, offset: -30,
                axes: { x: "RPM", y: "Load" },
                axisValues: { rpm: [800, 1000, 1500, 2000, 2500, 3000, 3500, 4000], load: [10, 30, 50, 70, 90, 100] },
                defaultData: [
                  { rpm: 800, load: 10, hexValue: "30" }, { rpm: 1000, load: 10, hexValue: "35" }, { rpm: 1500, load: 10, hexValue: "3A" }, { rpm: 2000, load: 10, hexValue: "3D" },
                  { rpm: 2500, load: 10, hexValue: "40" }, { rpm: 3000, load: 10, hexValue: "42" }, { rpm: 3500, load: 10, hexValue: "44" }, { rpm: 4000, load: 10, hexValue: "45" },
                  { rpm: 800, load: 30, hexValue: "2A" }, { rpm: 1000, load: 30, hexValue: "2F" }, { rpm: 1500, load: 30, hexValue: "34" }, { rpm: 2000, load: 30, hexValue: "37" },
                  { rpm: 2500, load: 30, hexValue: "3A" }, { rpm: 3000, load: 30, hexValue: "3C" }, { rpm: 3500, load: 30, hexValue: "3E" }, { rpm: 4000, load: 30, hexValue: "3F" },
                  { rpm: 800, load: 50, hexValue: "20" }, { rpm: 1000, load: 50, hexValue: "25" }, { rpm: 1500, load: 50, hexValue: "2A" }, { rpm: 2000, load: 50, hexValue: "2D" },
                  { rpm: 2500, load: 50, hexValue: "30" }, { rpm: 3000, load: 50, hexValue: "32" }, { rpm: 3500, load: 50, hexValue: "34" }, { rpm: 4000, load: 50, hexValue: "35" },
                  { rpm: 800, load: 70, hexValue: "18" }, { rpm: 1000, load: 70, hexValue: "1D" }, { rpm: 1500, load: 70, hexValue: "22" }, { rpm: 2000, load: 70, hexValue: "25" },
                  { rpm: 2500, load: 70, hexValue: "28" }, { rpm: 3000, load: 70, hexValue: "2A" }, { rpm: 3500, load: 70, hexValue: "2C" }, { rpm: 4000, load: 70, hexValue: "2D" },
                  { rpm: 800, load: 90, hexValue: "10" }, { rpm: 1000, load: 90, hexValue: "15" }, { rpm: 1500, load: 90, hexValue: "1A" }, { rpm: 2000, load: 90, hexValue: "1D" },
                  { rpm: 2500, load: 90, hexValue: "20" }, { rpm: 3000, load: 90, hexValue: "22" }, { rpm: 3500, load: 90, hexValue: "24" }, { rpm: 4000, load: 90, hexValue: "25" },
                  { rpm: 800, load: 100, hexValue: "08" }, { rpm: 1000, load: 100, hexValue: "0D" }, { rpm: 1500, load: 100, hexValue: "12" }, { rpm: 2000, load: 100, hexValue: "15" },
                  { rpm: 2500, load: 100, hexValue: "18" }, { rpm: 3000, load: 100, hexValue: "1A" }, { rpm: 3500, load: 100, hexValue: "1C" }, { rpm: 4000, load: 100, hexValue: "1D" },
                ]
            }
        }
      },
      "Honda": {
        "Honda Civic FC (Petrol)": {
          vtec_engagement: {
            name: "VTEC Engagement RPM",
            address: 0x1000, type: "16-bit unsigned", factor: 1, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [1000, 2000, 3000, 4000], load: [20, 50, 80, 100] },
            defaultData: [
              { rpm: 1000, load: 20, hexValue: "0BB8" }, { rpm: 2000, load: 20, hexValue: "0BB8" }, { rpm: 3000, load: 20, hexValue: "0C80" }, { rpm: 4000, load: 20, hexValue: "0D48" },
              { rpm: 1000, load: 50, hexValue: "0D48" }, { rpm: 2000, load: 50, hexValue: "0E10" }, { rpm: 3000, load: 50, hexValue: "0ED8" }, { rpm: 4000, load: 50, hexValue: "0FA0" },
              { rpm: 1000, load: 80, hexValue: "0FA0" }, { rpm: 2000, load: 80, hexValue: "1068" }, { rpm: 3000, load: 80, hexValue: "1130" }, { rpm: 4000, load: 80, hexValue: "11F8" },
              { rpm: 1000, load: 100, hexValue: "11F8" }, { rpm: 2000, load: 100, hexValue: "12C0" }, { rpm: 3000, load: 100, hexValue: "1388" }, { rpm: 4000, load: 100, hexValue: "1450" },
            ]
          }
        }
      },
      "Isuzu": {
        "Isuzu D-Max (Diesel)": {
          fuel_pressure_limit: {
            name: "Fuel Pressure Limit (bar)",
            address: 0x1000, type: "16-bit unsigned", factor: 0.1, offset: 0,
            axes: { x: "RPM", y: "Load" },
            axisValues: { rpm: [800, 1500, 2500, 3500], load: [30, 60, 90] },
            defaultData: [
              { rpm: 800, load: 30, hexValue: "2EE0" }, { rpm: 1500, load: 30, hexValue: "3A98" }, { rpm: 2500, load: 30, hexValue: "4650" }, { rpm: 3500, load: 30, hexValue: "5208" },
              { rpm: 800, load: 60, hexValue: "3A98" }, { rpm: 1500, load: 60, hexValue: "4650" }, { rpm: 2500, load: 60, hexValue: "5208" }, { rpm: 3500, load: 60, hexValue: "5DC0" },
              { rpm: 800, load: 90, hexValue: "5208" }, { rpm: 1500, load: 90, hexValue: "5DC0" }, { rpm: 2500, load: 90, hexValue: "6978" }, { rpm: 3500, load: 90, hexValue: "7530" },
            ]
          }
        }
      },
      "Ford": {
        "Ford Ranger (Diesel)": {
          egr_duty_cycle: {
            name: "EGR Duty Cycle (%)",
            address: 0x1000, type: "8-bit unsigned", factor: 0.39, offset: 0, // Roughly 100 / 255
            axes: { x: "RPM", y: "Coolant Temp" },
            axisValues: { rpm: [800, 1500, 2500, 3500], coolant_temp: [60, 80, 95] },
            defaultData: [
              { rpm: 800, coolant_temp: 60, hexValue: "40" }, { rpm: 1500, coolant_temp: 60, hexValue: "30" }, { rpm: 2500, coolant_temp: 60, hexValue: "20" }, { rpm: 3500, coolant_temp: 60, hexValue: "10" },
              { rpm: 800, coolant_temp: 80, hexValue: "30" }, { rpm: 1500, coolant_temp: 80, hexValue: "20" }, { rpm: 2500, coolant_temp: 80, hexValue: "10" }, { rpm: 3500, coolant_temp: 80, hexValue: "05" },
              { rpm: 800, coolant_temp: 95, hexValue: "20" }, { rpm: 1500, coolant_temp: 95, hexValue: "10" }, { rpm: 2500, coolant_temp: 95, hexValue: "05" }, { rpm: 3500, coolant_temp: 95, hexValue: "00" },
            ]
          }
        }
      },
      "Nissan": {
        "Nissan Navara NP300 (Diesel)": {
          rail_pressure: {
            name: "Rail Pressure (MPa)",
            address: 0x1000, type: "16-bit unsigned", factor: 0.1, offset: 0,
            axes: { x: "RPM", y: "IQ" },
            axisValues: { rpm: [1000, 2000, 3000, 4000], iq: [20, 40, 60, 80] },
            defaultData: [
              { rpm: 1000, iq: 20, hexValue: "0DAC" }, { rpm: 2000, iq: 20, hexValue: "0E10" }, { rpm: 3000, iq: 20, hexValue: "0ED8" }, { rpm: 4000, iq: 20, hexValue: "0FA0" },
              { rpm: 1000, iq: 40, hexValue: "0FA0" }, { rpm: 2000, iq: 40, hexValue: "1068" }, { rpm: 3000, iq: 40, hexValue: "1130" }, { rpm: 4000, iq: 40, hexValue: "11F8" },
              { rpm: 1000, iq: 60, hexValue: "11F8" }, { rpm: 2000, iq: 60, hexValue: "12C0" }, { rpm: 3000, iq: 60, hexValue: "1388" }, { rpm: 4000, iq: 60, hexValue: "1450" },
              { rpm: 1000, iq: 80, hexValue: "1450" }, { rpm: 2000, iq: 80, hexValue: "1518" }, { rpm: 3000, iq: 80, hexValue: "15E0" }, { rpm: 4000, iq: 80, hexValue: "16A8" },
            ]
          }
        }
      },
      "BMW": {
        "BMW 320d (F30)": {
          torque_limiter: {
            name: "Torque Limiter (Nm)",
            address: 0x1000, type: "16-bit unsigned", factor: 0.5, offset: 0,
            axes: { x: "RPM", y: "Gear" },
            axisValues: { rpm: [1500, 2500, 3500, 4500], gear: [1, 2, 3, 4, 5, 6] },
            defaultData: [
              { rpm: 1500, gear: 1, hexValue: "02BC" }, { rpm: 2500, gear: 1, hexValue: "0320" }, { rpm: 3500, gear: 1, hexValue: "0384" }, { rpm: 4500, gear: 1, hexValue: "03E8" },
              { rpm: 1500, gear: 2, hexValue: "0320" }, { rpm: 2500, gear: 2, hexValue: "0384" }, { rpm: 3500, gear: 2, hexValue: "03E8" }, { rpm: 4500, gear: 2, hexValue: "044C" },
              { rpm: 1500, gear: 3, hexValue: "03E8" }, { rpm: 2500, gear: 3, hexValue: "044C" }, { rpm: 3500, gear: 3, hexValue: "04B0" }, { rpm: 4500, gear: 3, hexValue: "0514" },
              { rpm: 1500, gear: 4, hexValue: "04B0" }, { rpm: 2500, gear: 4, hexValue: "0514" }, { rpm: 3500, gear: 4, hexValue: "0578" }, { rpm: 4500, gear: 4, hexValue: "05DC" },
              { rpm: 1500, gear: 5, hexValue: "0514" }, { rpm: 2500, gear: 5, hexValue: "0578" }, { rpm: 3500, gear: 5, hexValue: "05DC" }, { rpm: 4500, gear: 5, hexValue: "0640" },
              { rpm: 1500, gear: 6, hexValue: "0578" }, { rpm: 2500, gear: 6, hexValue: "05DC" }, { rpm: 3500, gear: 6, hexValue: "0640" }, { rpm: 4500, gear: 6, hexValue: "06A4" },
            ]
          }
        }
      },
      "Mercedes-Benz": {
        "Mercedes-Benz C220d (W205)": {
          exhaust_temp_limit: {
            name: "Exhaust Gas Temp Limit (¬∞C)",
            address: 0x1000, type: "16-bit unsigned", factor: 0.1, offset: 0,
            axes: { x: "RPM", y: "IQ" },
            axisValues: { rpm: [1000, 2000, 3000, 4000], iq: [20, 40, 60, 80] },
            defaultData: [
              { rpm: 1000, iq: 20, hexValue: "07D0" }, { rpm: 2000, iq: 20, hexValue: "0834" }, { rpm: 3000, iq: 20, hexValue: "0898" }, { rpm: 4000, iq: 20, hexValue: "08FC" },
              { rpm: 1000, iq: 40, hexValue: "08FC" }, { rpm: 2000, iq: 40, hexValue: "0960" }, { rpm: 3000, iq: 40, hexValue: "09C4" }, { rpm: 4000, iq: 40, hexValue: "0A28" },
              { rpm: 1000, iq: 60, hexValue: "0A28" }, { rpm: 2000, iq: 60, hexValue: "0A8C" }, { rpm: 3000, iq: 60, hexValue: "0AF0" }, { rpm: 4000, iq: 60, hexValue: "0B54" },
              { rpm: 1000, iq: 80, hexValue: "0B54" }, { rpm: 2000, iq: 80, hexValue: "0BB8" }, { rpm: 3000, iq: 80, hexValue: "0C1C" }, { rpm: 4000, iq: 80, hexValue: "0C80" },
            ]
          }
        }
      }
    };

    // --- DOM Elements ---
    const carBrandSelect = document.getElementById("carBrand");
    const carModelSelect = document.getElementById("carModel");
    const mapTypeSelect = document.getElementById("mapType");
    const tuningTableBody = document.querySelector("#tuningTable tbody");
    const hexGrid = document.getElementById("hexGrid");
    const resultArea = document.getElementById("resultArea");
    const messageArea = document.getElementById("messageArea");
    const viewModeSelect = document.getElementById("viewMode");
    const graphCanvas = document.getElementById("graphCanvas");
    const graphCtx = graphCanvas.getContext('2d');
    const fileStatus = document.getElementById("fileStatus");
    const mapStatus = document.getElementById("mapStatus");
    let chartInstance;

    // --- Utility Functions ---
    function decToHex(d, padLength = 2) {
      let hex = Number(d).toString(16).toUpperCase();
      return hex.padStart(padLength, '0');
    }

    function hexToDec(h) {
        if (!h || !/^[0-9A-Fa-f]+$/.test(h)) { // Basic validation
            // console.warn("Invalid HEX input for hexToDec:", h);
            return 0; // Return 0 or handle error appropriately
        }
        let dec = parseInt(h, 16);
        if (currentMapDefinition && (currentMapDefinition.type === "8-bit signed" || currentMapDefinition.type === "16-bit signed")) {
            const bitLength = currentMapDefinition.type.includes("8-bit") ? 8 : 16;
            const maxVal = Math.pow(2, bitLength);
            const halfMaxVal = maxVal / 2;
            if (dec >= halfMaxVal) {
                dec -= maxVal;
            }
        }
        return dec;
    }

    function showMessage(msg, isError = false) {
      messageArea.textContent = msg;
      messageArea.className = isError ? "error" : "";
      clearTimeout(messageArea.timer);
      messageArea.timer = setTimeout(() => {
        messageArea.textContent = '';
        messageArea.className = '';
      }, 5000);
    }

    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    // --- Core Logic ---

    // Populates car models based on selected brand
    function populateCarModels() {
        const selectedBrand = carBrandSelect.value;
        const modelsForBrand = ecuDefinitions[selectedBrand];
        carModelSelect.innerHTML = '';

        if (modelsForBrand) {
            for (const modelKey in modelsForBrand) {
                const option = document.createElement("option");
                option.value = modelKey;
                option.textContent = modelKey;
                carModelSelect.appendChild(option);
            }
        } else {
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "No models available";
            carModelSelect.appendChild(option);
        }
        
        populateMapOptions();
    }

    // Populates map options based on selected car model
    function populateMapOptions() {
        const selectedBrand = carBrandSelect.value;
        const selectedModelText = carModelSelect.value;
        const mapsForModel = ecuDefinitions[selectedBrand]?.[selectedModelText];
        
        mapTypeSelect.innerHTML = '';

        let hasMaps = false;
        if (mapsForModel) {
            for (const mapKey in mapsForModel) {
                const option = document.createElement("option");
                option.value = mapKey;
                option.textContent = mapsForModel[mapKey].name;
                mapTypeSelect.appendChild(option);
                hasMaps = true;
            }
        }
        
        if (!hasMaps) {
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "No maps available";
            mapTypeSelect.appendChild(option);
        }

        if (hasMaps && mapTypeSelect.value && currentECUFile) { // Only load map data if ECU file is loaded
            loadMapData();
        } else {
            tuningTableBody.innerHTML = '<tr><td colspan="3">Please load ECU file and select a map.</td></tr>';
            hexGrid.innerHTML = '';
            currentMapData = null;
            currentMapDefinition = null;
            renderGraph();
            mapStatus.textContent = "None selected";
            document.querySelectorAll('.status-indicator')[1].className = 'status-indicator status-inactive';
        }
    }

    // Loads and displays the selected map data
    function loadMapData() {
        const selectedBrand = carBrandSelect.value;
        const selectedModelText = carModelSelect.value;
        const selectedMapType = mapTypeSelect.value;

        if (!currentECUFile) {
            showMessage("Please simulate loading an ECU file first.", true);
            mapStatus.textContent = "None selected";
            document.querySelectorAll('.status-indicator')[1].className = 'status-indicator status-inactive';
            return;
        }

        if (!selectedMapType || !ecuDefinitions[selectedBrand] || 
            !ecuDefinitions[selectedBrand][selectedModelText] || 
            !ecuDefinitions[selectedBrand][selectedModelText][selectedMapType]) {
            tuningTableBody.innerHTML = '<tr><td colspan="3">No data available for this map.</td></tr>';
            hexGrid.innerHTML = '';
            currentMapData = null;
            currentMapDefinition = null;
            renderGraph();
            mapStatus.textContent = "None selected";
            document.querySelectorAll('.status-indicator')[1].className = 'status-indicator status-inactive';
            return;
        }

        currentMapDefinition = ecuDefinitions[selectedBrand][selectedModelText][selectedMapType];
        // Deep copy defaultData to currentMapData for modification
        currentMapData = JSON.parse(JSON.stringify(currentMapDefinition.defaultData));

        renderTuningTable();
        renderHexGrid();
        renderGraph();
        addToHistory();
        
        mapStatus.textContent = currentMapDefinition.name;
        document.querySelectorAll('.status-indicator')[1].className = 'status-indicator status-active';
    }

    // Renders the table view of the map
    function renderTuningTable() {
      tuningTableBody.innerHTML = '';

      if (!currentMapData || currentMapData.length === 0) {
          tuningTableBody.innerHTML = '<tr><td colspan="3">No map data to display.</td></tr>';
          return;
      }

      // Create header row for axes
      const headerRow = document.createElement("tr");
      const axisXKey = currentMapDefinition?.axes?.x?.toLowerCase();
      const axisYKey = currentMapDefinition?.axes?.y?.toLowerCase();

      if (axisXKey) {
          const thX = document.createElement("th");
          thX.textContent = currentMapDefinition.axes.x;
          headerRow.appendChild(thX);
      } else {
          const thIndex = document.createElement("th");
          thIndex.textContent = "Index";
          headerRow.appendChild(thIndex);
      }
      
      if (axisYKey) {
          const thY = document.createElement("th");
          thY.textContent = currentMapDefinition.axes.y;
          headerRow.appendChild(thY);
      }
      const thValue = document.createElement("th");
      thValue.textContent = "Value";
      headerRow.appendChild(thValue);
      
      tuningTableBody.parentNode.querySelector('thead').innerHTML = ''; // Clear existing header
      tuningTableBody.parentNode.querySelector('thead').appendChild(headerRow);


      currentMapData.forEach((row, index) => {
        let displayValue;
        if (currentMapDefinition.name.includes("DTC Switch")) {
            displayValue = row.hexValue === "01" ? "Enabled" : "Disabled";
        } else {
            let actualValueDec = hexToDec(row.hexValue);
            // Conversion for signed values happens in hexToDec now
            
            if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
                displayValue = (actualValueDec * currentMapDefinition.factor + currentMapDefinition.offset).toFixed(currentMapDefinition.factor < 1 ? 2 : 0);
            } else {
                displayValue = actualValueDec;
            }
        }

        const tr = document.createElement("tr");
        const xVal = currentMapDefinition?.axes?.x ? (row[currentMapDefinition.axes.x.toLowerCase()] || '-') : index; // Use index if no x-axis defined
        const yVal = currentMapDefinition?.axes?.y ? (row[currentMapDefinition.axes.y.toLowerCase()] || '-') : '-';

        let rowHtml = `<td>${xVal}</td>`;
        if (currentMapDefinition?.axes?.y) { // Only add Y axis column if Y axis is defined
            rowHtml += `<td>${yVal}</td>`;
        }
        
        rowHtml += `<td>
            ${currentMapDefinition.name.includes("DTC Switch") ? `
                <select class="map-value-input" data-index="${index}">
                    <option value="01" ${row.hexValue === "01" ? 'selected' : ''}>Enabled</option>
                    <option value="00" ${row.hexValue === "00" ? 'selected' : ''}>Disabled</option>
                </select>
            ` : `
                <input type="number" class="map-value-input" data-index="${index}" value="${displayValue}" step="${currentMapDefinition.factor < 1 ? '0.01' : '1'}">
            `}
          </td>`;
        tr.innerHTML = rowHtml;
        tuningTableBody.appendChild(tr);
      });

      document.querySelectorAll(".map-value-input").forEach(input => {
        input.addEventListener("change", updateFromMapTable);
      });
    }

    // Renders the HEX Viewer grid
    function renderHexGrid() {
      hexGrid.innerHTML = '';
      if (!currentMapData || currentMapData.length === 0) {
          hexGrid.innerHTML = 'No HEX data to display.';
          return;
      }

      let maxLength = 2; // Default for 8-bit
      if (currentMapDefinition && currentMapDefinition.type && currentMapDefinition.type.includes("16-bit")) {
          maxLength = 4;
      }

      currentMapData.forEach((row, index) => {
        const input = document.createElement("input");
        input.type = "text";
        input.className = "hex";
        input.maxLength = maxLength;
        input.value = row.hexValue;
        input.setAttribute("data-index", index);
        input.addEventListener("input", updateFromHexGrid);
        hexGrid.appendChild(input);
      });
    }

    // Updates map data and HEX viewer from table input
    function updateFromMapTable(event) {
      const index = parseInt(event.target.dataset.index);
      let newValue = event.target.value;

      addToHistory();

      let hexEquivalent;
      if (currentMapDefinition.name.includes("DTC Switch")) {
          hexEquivalent = newValue; // "00" or "01"
      } else {
          newValue = parseFloat(newValue);
          if (isNaN(newValue)) {
             showMessage("Invalid number input.", true);
             // Revert to original value if invalid input
             event.target.value = (hexToDec(currentMapData[index].hexValue) * currentMapDefinition.factor + currentMapDefinition.offset).toFixed(currentMapDefinition.factor < 1 ? 2 : 0);
             return;
          }
          
          if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
              let calculatedRawValue = Math.round((newValue - currentMapDefinition.offset) / currentMapDefinition.factor);
              
              if (currentMapDefinition.type === "8-bit unsigned") {
                  hexEquivalent = Math.max(0, Math.min(calculatedRawValue, 255));
              } else if (currentMapDefinition.type === "8-bit signed") {
                  hexEquivalent = Math.max(-128, Math.min(calculatedRawValue, 127));
                  if (hexEquivalent < 0) hexEquivalent = 256 + hexEquivalent; // Convert to 8-bit unsigned representation for hex
              } else if (currentMapDefinition.type === "16-bit unsigned") {
                  hexEquivalent = Math.max(0, Math.min(calculatedRawValue, 65535));
              } else if (currentMapDefinition.type === "16-bit signed") {
                  hexEquivalent = Math.max(-32768, Math.min(calculatedRawValue, 32767));
                  if (hexEquivalent < 0) hexEquivalent = 65536 + hexEquivalent; // Convert to 16-bit unsigned representation for hex
              } else {
                  hexEquivalent = Math.round(newValue); // Fallback if type not specified or handled
              }
          }
          else {
              hexEquivalent = Math.round(newValue); // Fallback if factor/offset not defined
          }
      }

      const hexString = decToHex(hexEquivalent, currentMapDefinition && currentMapDefinition.type.includes("16-bit") ? 4 : 2);
      currentMapData[index].hexValue = hexString;

      const hexInput = hexGrid.querySelector(`input[data-index="${index}"]`);
      if (hexInput) {
        hexInput.value = hexString;
      }
      renderGraph();
      resultArea.innerHTML = '';
      showMessage("Map value updated.", false);
    }

    // Updates map data and table from HEX viewer input
    function updateFromHexGrid(event) {
      const index = parseInt(event.target.dataset.index);
      let newHexValue = event.target.value.toUpperCase();

      const is8Bit = currentMapDefinition && (currentMapDefinition.type.includes("8-bit"));
      const is16Bit = currentMapDefinition && (currentMapDefinition.type.includes("16-bit"));
      const targetLength = is16Bit ? 4 : 2;

      // Basic validation for HEX format and length
      if (!/^[0-9A-F]*$/.test(newHexValue) || newHexValue.length > targetLength) {
        event.target.value = currentMapData[index].hexValue; // Revert if invalid
        showMessage("Invalid HEX input.", true);
        return;
      }

      // Pad with leading zeros if necessary
      if (newHexValue.length < targetLength) {
          // Do not pad until user finishes typing if they're still inputting
          // This allows for typing "F" then "F" for "FF" instead of "0F" then "FF"
          // We'll update the data only when a valid, full-length hex is entered or when value is already there
          // For immediate feedback, we can update, but revert if partial/invalid
      } else {
          addToHistory(); // Add to history only when a valid, complete change occurs
      }
      
      currentMapData[index].hexValue = newHexValue; // Temporarily update for display

      const mapInput = tuningTableBody.querySelector(`[data-index="${index}"]`);
      if (mapInput) {
          if (currentMapDefinition.name.includes("DTC Switch")) {
              mapInput.value = newHexValue; // "00" or "01"
          } else {
              let actualValueDec = hexToDec(newHexValue); // hexToDec now handles signed conversion
              
              if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
                  const actualValue = (actualValueDec * currentMapDefinition.factor + currentMapDefinition.offset).toFixed(currentMapDefinition.factor < 1 ? 2 : 0);
                  mapInput.value = actualValue;
              } else {
                  mapInput.value = actualValueDec;
              }
          }
      }
      renderGraph();
      resultArea.innerHTML = '';
      showMessage("HEX value updated.", false);
    }

    // --- Graphing (2D Simulation with Chart.js) ---
    function renderGraph() {
        // ‡∏ã‡πà‡∏≠‡∏ô canvas ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡∏°‡πà
        graphCanvas.style.display = 'none';

        // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ Chart instance ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á
        if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô null ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ reference ‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
        }

        const viewMode = viewModeSelect.value;
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î 2D, ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà, ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó DTC Switch ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏≤‡∏ü
        if (viewMode === '2d' && currentMapDefinition && currentMapData && 
            !currentMapDefinition.name.includes("DTC Switch")) {
            
            try {
                // ‡πÅ‡∏™‡∏î‡∏á canvas
                graphCanvas.style.display = 'block';

                const xAxisLabel = currentMapDefinition?.axes?.x;
                const yAxisLabel = currentMapDefinition?.axes?.y;
                
                let labels = [];
                let datasets = [];
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÅ‡∏Å‡∏ô X ‡πÅ‡∏•‡∏∞ Y ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Map Definition ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡∏ô Y ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å series
                if (xAxisLabel && yAxisLabel && currentMapDefinition.axisValues) {
                    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏Å‡∏ô Y ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢ series (‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü)
                    const uniqueYValues = [...new Set(currentMapData.map(d => d?.[yAxisLabel.toLowerCase()]))].sort((a,b) => a - b);
                    
                    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏Å‡∏ô X ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô labels ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü
                    labels = [...new Set(currentMapData.map(d => d?.[xAxisLabel.toLowerCase()]))].sort((a,b) => a - b);

                    uniqueYValues.forEach(yVal => {
                        const dataForY = [];
                        labels.forEach((xVal, index) => {
                            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏Å‡∏ô X ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡∏ô Y
                            const item = currentMapData.find(d => 
                                d?.[xAxisLabel.toLowerCase()] === xVal && 
                                d?.[yAxisLabel.toLowerCase()] === yVal
                            );
                            if (item) {
                                let value = hexToDec(item.hexValue);
                                // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏° factor ‡πÅ‡∏•‡∏∞ offset ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                                if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
                                    value = (value * currentMapDefinition.factor + currentMapDefinition.offset);
                                }
                                // ‡∏ó‡∏î‡∏•‡∏≠‡∏á: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏à‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô (‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î)
                                dataForY.push((index % 2 === 0) ? value : null); 
                            } else {
                                dataForY.push(null); 
                            }
                        });

                        // ‡πÄ‡∏û‡∏¥‡πà‡∏° dataset ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏Å‡∏ô Y
                        datasets.push({
                            label: `${yAxisLabel}: ${yVal}`, // Label ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö legend (‡πÄ‡∏ä‡πà‡∏ô Load: 10, Load: 30)
                            data: dataForY,
                            borderColor: getRandomColor(), // ‡πÉ‡∏´‡πâ‡∏™‡∏µ‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°
                            backgroundColor: 'rgba(0, 191, 255, 0.1)', // ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏à‡∏≤‡∏á‡πÜ)
                            borderWidth: 1, // ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô
                            pointRadius: 1, // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏∏‡∏î
                            fill: false, // ‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏µ‡πÉ‡∏ï‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
                            tension: 0.3 // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô
                        });
                    });
                } else { 
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏≤‡∏ü 1 ‡∏°‡∏¥‡∏ï‡∏¥ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏Å‡∏ô Y ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                    labels = currentMapData.map((d, i) => {
                        if (xAxisLabel) return d?.[xAxisLabel.toLowerCase()] || `Point ${i + 1}`;
                        return `Point ${i + 1}`;
                    });
                    
                    const dataValues = currentMapData.map((d, index) => {
                        let value = hexToDec(d.hexValue);
                        if (currentMapDefinition && typeof currentMapDefinition.factor !== 'undefined' && typeof currentMapDefinition.offset !== 'undefined') {
                            value = (value * currentMapDefinition.factor + currentMapDefinition.offset);
                        }
                        // ‡∏ó‡∏î‡∏•‡∏≠‡∏á: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏à‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô (‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î)
                        return (index % 2 === 0) ? value : null; 
                    });

                    datasets.push({
                        label: `${currentMapDefinition.name} Values`,
                        data: dataValues,
                        borderColor: '#00bfff',
                        backgroundColor: 'rgba(0, 191, 255, 0.2)',
                        borderWidth: 1,
                        pointRadius: 1,
                        fill: true,
                        tension: 0.3
                    });
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Chart.js instance ‡πÉ‡∏´‡∏°‡πà
                chartInstance = new Chart(graphCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true, /* ‡πÄ‡∏õ‡πá‡∏ô true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô */
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: xAxisLabel || 'Index', // ‡πÉ‡∏ä‡πâ 'Index' ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡∏ô X
                                    color: '#ccc',
                                    font: { size: 10 } // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î font
                                },
                                ticks: { 
                                    color: '#eee', 
                                    maxRotation: 90, 
                                    minRotation: 0, 
                                    autoSkip: true, 
                                    maxTicksLimit: 10, // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô tick labels
                                    font: { size: 8 } // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î font ‡∏Ç‡∏≠‡∏á tick
                                },
                                grid: { color: '#555' }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: currentMapDefinition.name, // ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≤‡∏ü‡∏ö‡∏ô‡πÅ‡∏Å‡∏ô Y
                                    color: '#ccc',
                                    font: { size: 10 } // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î font
                                },
                                ticks: { color: '#eee', font: { size: 8 } }, // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î font ‡∏Ç‡∏≠‡∏á tick
                                grid: { color: '#555' }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#eee',
                                    font: { size: 10 } // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î font
                                },
                                position: 'bottom' // ‡∏¢‡πâ‡∏≤‡∏¢ legend ‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
                            },
                            title: { // ‡πÄ‡∏û‡∏¥‡πà‡∏° title ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
                                display: true,
                                text: `‡∏Å‡∏£‡∏≤‡∏ü ${currentMapDefinition.name} (2D View)`,
                                color: '#00bfff',
                                font: {
                                    size: 12 // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î title
                                }
                            }
                        },
                        elements: {
                            line: {
                                tension: 0.4 // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
                            }
                        }
                    }
                });
                console.log('‡∏Å‡∏£‡∏≤‡∏ü 2D ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏≤‡∏ü:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏≤‡∏ü: " + error.message, true);
                graphCanvas.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô canvas ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            }
        } else {
            // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î 2D ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà DTC Switch ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô canvas
            graphCanvas.style.display = 'none';
            if (viewMode === '3d') {
                showMessage("3D Graph visualization requires advanced libraries. This is a simulated view.", false);
            }
        }
    }

    // --- File Operations Simulation ---
    function simulateFileLoad() {
        showMessage("Simulating ECU file load...", false);

        // Simulate a larger ECU file memory (e.g., 64KB = 0x10000 bytes)
        currentECUFile = Array(0x10000).fill('00');
        
        // Populate currentECUFile with default data from all defined maps
        for (const brandKey in ecuDefinitions) {
            for (const modelKey in ecuDefinitions[brandKey]) {
                for (const mapKey in ecuDefinitions[brandKey][modelKey]) {
                    const mapDef = ecuDefinitions[brandKey][modelKey][mapKey];
                    let currentAddress = mapDef.address;
                    mapDef.defaultData.forEach(item => {
                        let hexBytes = item.hexValue;
                        const byteLength = mapDef.type.includes("16-bit") ? 4 : 2; // 2 chars per byte, so 4 for 16-bit
                        
                        // Ensure hexBytes has correct length (e.g., "A" becomes "0A", "1B" becomes "01B")
                        hexBytes = hexBytes.padStart(byteLength, '0');

                        for (let i = 0; i < hexBytes.length; i += 2) {
                            if (currentAddress < currentECUFile.length) {
                                 currentECUFile[currentAddress++] = hexBytes.substring(i, i + 2);
                            } else {
                                console.warn(`Address 0x${(currentAddress-1).toString(16)} out of simulated ECU file bounds for map ${mapDef.name}`);
                                break;
                            }
                        }
                    });
                }
            }
        }

        history = [];
        historyPointer = -1;

        populateCarModels(); // This will also call populateMapOptions and loadMapData
        showMessage("ECU file simulated load complete.", false);
        fileStatus.textContent = "Loaded (simulated)";
        document.querySelectorAll('.status-indicator')[0].className = 'status-indicator status-active';
    }

    function simulateFileSave() {
        if (!currentECUFile) {
            showMessage("No ECU file loaded to save.", true);
            return;
        }
        // In a real scenario, this would trigger a download of the modified currentECUFile
        showMessage("Simulating saving of modified ECU file. (No actual file download in simulator)");
    }

    // --- Tuning Functions ---

    function confirmTuning() {
      if (!currentMapData || !currentMapDefinition) {
          resultArea.innerHTML = "<p style='color: #ffaaaa;'>Please load a map first.</p>";
          return;
      }
      if (!currentECUFile) {
          resultArea.innerHTML = "<p style='color: #ffaaaa;'>Please simulate loading an ECU file first.</p>";
          return;
      }

      const map = mapTypeSelect.options[mapTypeSelect.selectedIndex].text;

      let originalTotalRawValue = 0;
      let modifiedTotalRawValue = 0;

      // Get original map data from the definition, not history[0] because history[0] might not be the original "stock" map
      const originalMapDataDef = ecuDefinitions[carBrandSelect.value]
                                  ?.[carModelSelect.value]
                                  ?.[mapTypeSelect.value];

      if (originalMapDataDef && originalMapDataDef.defaultData) {
          originalMapDataDef.defaultData.forEach(item => {
              originalTotalRawValue += hexToDec(item.hexValue); // Sum raw hex values
          });
      }
      currentMapData.forEach(item => {
          modifiedTotalRawValue += hexToDec(item.hexValue); // Sum raw hex values
      });

      let hpChange = 0;
      let torqueChange = 0;
      let response = "";

      // Only calculate difference for numerical maps
      if (!currentMapDefinition.name.includes("DTC Switch")) {
          const diffRatio = (originalTotalRawValue !== 0) ? (modifiedTotalRawValue - originalTotalRawValue) / originalTotalRawValue : 0;

          if (mapTypeSelect.value.includes("iq_limit") || mapTypeSelect.value.includes("main_injection")) {
            hpChange = (diffRatio * 30).toFixed(1);
            torqueChange = (diffRatio * 40).toFixed(1);
            response = diffRatio > 0 ? "Improved throttle response and power delivery. Expect more aggressive acceleration." : "Smoother power delivery, potentially better fuel economy.";
          } else if (mapTypeSelect.value.includes("boost_pressure")) {
            hpChange = (diffRatio * 25).toFixed(1);
            torqueChange = (diffRatio * 35).toFixed(1);
            response = diffRatio > 0 ? "Stronger pull throughout the RPM range due to increased boost." : "Reduced turbo lag for better drivability, potentially at lower boost levels.";
          } else if (mapTypeSelect.value.includes("ignition_timing")) {
            hpChange = (diffRatio * 20).toFixed(1);
            torqueChange = (diffRatio * 25).toFixed(1);
            response = diffRatio > 0 ? "Optimized combustion for increased power and efficiency. Ensure fuel quality." : "Safer operation with reduced risk of knocking, slight power reduction.";
          } else if (mapTypeSelect.value.includes("vtec_engagement")) {
              hpChange = (diffRatio * 15).toFixed(1); // Small impact, more about character
              torqueChange = (diffRatio * 10).toFixed(1);
              response = diffRatio < 0 ? "Earlier VTEC engagement for a sportier feel and quicker power band access." : "Later VTEC engagement for smoother power transition at higher RPMs.";
          } else if (mapTypeSelect.value.includes("fuel_pressure_limit") || mapTypeSelect.value.includes("rail_pressure")) {
              hpChange = (diffRatio * 25).toFixed(1);
              torqueChange = (diffRatio * 30).toFixed(1);
              response = diffRatio > 0 ? "Higher fuel pressure for more precise and powerful injection." : "Adjusted fuel pressure for efficiency or engine protection.";
          } else if (mapTypeSelect.value.includes("egr_duty_cycle")) {
              hpChange = (diffRatio * -5).toFixed(1); // Lower EGR duty cycle usually means more power, so inverse
              torqueChange = (diffRatio * -5).toFixed(1);
              response = diffRatio < 0 ? "Reduced EGR for cleaner combustion and more power. May affect emissions." : "Increased EGR for better emissions control.";
          } else if (mapTypeSelect.value.includes("torque_limiter")) {
              hpChange = (diffRatio * 20).toFixed(1); // Direct increase in torque limit implies more power
              torqueChange = (diffRatio * 30).toFixed(1);
              response = diffRatio > 0 ? "Increased torque limits allowing the engine to produce more power." : "Reduced torque limits for engine protection or smoother delivery.";
          } else if (mapTypeSelect.value.includes("exhaust_temp_limit")) {
              hpChange = (diffRatio * -10).toFixed(1); // Higher temp limit allows more aggressive tune, so inverse diff
              torqueChange = (diffRatio * -10).toFixed(1);
              response = diffRatio > 0 ? "Increased exhaust gas temperature limits, allowing for more aggressive tuning. Monitor EGTs!" : "Reduced exhaust gas temperature limits for engine and turbo longevity.";
          }
          else {
              hpChange = (diffRatio * 10).toFixed(1);
              torqueChange = (diffRatio * 10).toFixed(1);
              response = "General performance adjustment based on raw value change.";
          }
      } else { // DTC Switch map
          const disabledDTCs = currentMapData.filter(d => d.hexValue === "00");
          if (disabledDTCs.length > 0) {
              response = `<span style="color: #ffcc00;">Warning: ${disabledDTCs.length} Diagnostic Trouble Codes (DTCs) are currently disabled.</span> This may prevent error detection.`;
          } else {
              response = "All Diagnostic Trouble Codes (DTCs) are enabled as per standard operation. No DTCs have been removed.";
          }
          hpChange = "N/A";
          torqueChange = "N/A";
      }

      resultArea.innerHTML = `
        <p>‚úÖ Tuning of "<strong>${map}</strong>" confirmed!</p>
        <p>Simulated Performance Impact: Horsepower Change: <strong>~${hpChange} HP</strong>, Torque Change: <strong>~${torqueChange}%</strong></p>
        <p>${response}</p>
      `;
    }

    function compareMaps() {
        if (!currentMapData || history.length < 1 || !currentMapDefinition || !currentECUFile) {
            showMessage("Please load an ECU file and make changes to compare.", true);
            return;
        }

        // The "original" map data is always the first state in history (after initial load)
        const originalMapState = history[0];
        let changes = 0;
        let comparisonDetails = '<p>Differences Found:</p><ul>';

        currentMapData.forEach((modifiedItem, index) => {
            const originalItem = originalMapState.currentMapData[index];
            if (originalItem && modifiedItem.hexValue !== originalItem.hexValue) {
                changes++;
                
                // Get axis labels for better readability
                const xLabel = currentMapDefinition?.axes?.x?.toLowerCase();
                const yLabel = currentMapDefinition?.axes?.y?.toLowerCase();
                
                let locationString = '';
                if (xLabel && modifiedItem[xLabel] !== undefined) {
                    locationString += `${currentMapDefinition.axes.x}: ${modifiedItem[xLabel]}`;
                }
                if (yLabel && modifiedItem[yLabel] !== undefined) {
                    locationString += (locationString ? ', ' : '') + `${currentMapDefinition.axes.y}: ${modifiedItem[yLabel]}`;
                }
                if (!locationString) {
                    locationString = `Index: ${index}`;
                }

                comparisonDetails += `<li><strong>${locationString}</strong>: Original HEX: <code>${originalItem.hexValue}</code>, Modified HEX: <code>${modifiedItem.hexValue}</code></li>`;
            }
        });
        comparisonDetails += '</ul>';

        if (changes === 0) {
            showMessage("No changes detected between current map and the initial loaded state.", false);
            resultArea.innerHTML = '';
        } else {
            resultArea.innerHTML = `
                <p>üìä Map Comparison Complete: Found <strong>${changes}</strong> differences in "${currentMapDefinition.name}".</p>
                ${comparisonDetails}
            `;
        }
    }

    function calculateChecksum() {
        if (!currentECUFile) {
            showMessage("No ECU file loaded to calculate checksum.", true);
            return;
        }

        let sum = 0;
        currentECUFile.forEach(hexByte => {
            sum += parseInt(hexByte, 16); // Parse hex string to integer
        });

        // Common checksum calculations involve summing bytes and then often taking modulo of a specific value
        // For simplicity, let's use a 16-bit checksum (sum modulo 65536)
        const simulatedChecksum = decToHex(sum % 65536, 4); // Pad to 4 hex characters for 16-bit

        resultArea.innerHTML = `
            <p>‚ûï Simulated Checksum Calculation Complete.</p>
            <p>Calculated Checksum: <strong>0x${simulatedChecksum}</strong></p>
            <p style="font-size: 0.9em; color: #88bbff;">(This is a simple sum-based simulation. Real checksum algorithms are more complex.)</p>
        `;
    }

    // --- Undo/Redo Functionality ---
    function addToHistory() {
        if (!currentMapData || !currentMapDefinition) return;

        // Create a deep copy of the current map data and definition
        const currentState = {
            currentMapData: JSON.parse(JSON.stringify(currentMapData)),
            currentMapDefinition: JSON.parse(JSON.stringify(currentMapDefinition))
        };
        
        // Prevent adding identical consecutive states
        if (historyPointer >= 0 && JSON.stringify(history[historyPointer]) === JSON.stringify(currentState)) {
            return;
        }

        // If we are not at the end of history (i.e., we've undone some changes),
        // any new change should truncate the redo history.
        if (historyPointer < history.length - 1) {
            history = history.slice(0, historyPointer + 1);
        }
        history.push(currentState);
        historyPointer++;
    }

    function applyHistoryState(state) {
        currentMapData = JSON.parse(JSON.stringify(state.currentMapData));
        currentMapDefinition = JSON.parse(JSON.stringify(state.currentMapDefinition));
        
        // Re-render UI based on the restored state
        populateMapOptions(); // Call this to ensure map data is re-evaluated and table is rebuilt correctly
        renderGraph();
    }

    function undoLastChange() {
        if (historyPointer > 0) {
            historyPointer--;
            const prevState = history[historyPointer];
            applyHistoryState(prevState);
            showMessage("Undo successful.", false);
        } else {
            showMessage("No more changes to undo.", true);
        }
    }
    
    function redoChange() {
        if (historyPointer < history.length - 1) {
            historyPointer++;
            const nextState = history[historyPointer];
            applyHistoryState(nextState);
            showMessage("Redo successful.", false);
        } else {
            showMessage("No more changes to redo.", true);
        }
    }

    // --- Event Listeners and Initial Load ---
    document.addEventListener("DOMContentLoaded", () => {
      carBrandSelect.addEventListener("change", populateCarModels);
      carModelSelect.addEventListener("change", populateMapOptions);
      mapTypeSelect.addEventListener("change", loadMapData);
      viewModeSelect.addEventListener("change", renderGraph);
      
      // Initialize models
      populateCarModels();
      showMessage("Welcome to WinOLS Simulator. Please 'Simulate Load' an ECU file to begin.", false);
    });
  </script>
</body>
</html>
